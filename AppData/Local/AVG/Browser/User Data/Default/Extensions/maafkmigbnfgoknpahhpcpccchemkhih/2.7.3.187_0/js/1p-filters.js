"use strict";(()=>{const e=new CodeMirror(document.getElementById("userFilters"),{autoCloseBrackets:!0,autofocus:!0,extraKeys:{"Ctrl-Space":"autocomplete",Tab:"toggleComment"},foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,maxScanLines:1,styleActiveLine:{nonEmpty:!0}});uBlockDashboard.patchCodeMirrorEditor(e);let t="";{let t=0;const n=function(n){if(n instanceof Object!=0){if(void 0!==n.hintUpdateToken){const o=e.getMode();o.setHints instanceof Function&&o.setHints(n),0===t&&(o.parser.expertMode=!1!==n.expertMode),t=n.hintUpdateToken}vAPI.setTimeout(o,2503)}},o=function(){vAPI.messaging.send("dashboard",{what:"getAutoCompleteDetails",hintUpdateToken:t}).then(n)};o()}const n=function(){const t=e.getValue().replace(/\s+$/,"");return""===t?t:t+"\n"},o=function(t){e.setValue(t.replace(/\s+$/,"")+"\n\n")},r=function(e){"boolean"!=typeof e&&(e=self.hasUnsavedData()),uDom.nodeFromId("userFiltersApply").disabled=!e,uDom.nodeFromId("userFiltersRevert").disabled=!e},i=async function(){const e=await vAPI.messaging.send("dashboard",{what:"writeUserFilters",content:n()});e instanceof Object==0||e.error||(t=e.content.trim(),r(!1),vAPI.messaging.send("dashboard",{what:"reloadAllFilters"}))};self.cloud.onPush=function(){return n()},self.cloud.onPull=function(t,o){"string"==typeof t&&(o&&(t=uBlockDashboard.mergeNewLines(n(),t)),e.setValue(t))},self.hasUnsavedData=function(){return n().trim()!==t},uDom("#importUserFiltersFromFile").on("click",(function(){const e=document.getElementById("importFilePicker");e.value="",e.click()})),uDom("#importFilePicker").on("change",(function(){const t=this.files[0];if(void 0===t||""===t.name)return;if(0!==t.type.indexOf("text"))return;const r=new FileReader;r.onload=function(){let t=function(e){const t=/\n\[Subscription\]\n+url=~[^\n]+([\x08-\x7E]*?)(?:\[Subscription\]|$)/gi,n=/\[Subscription filters\]([\x08-\x7E]*?)(?:\[Subscription\]|$)/i;let o=t.exec(e);if(null===o)return e;const r=[];do{if(2===o.length){let e=n.exec(o[1].trim());null!==e&&2===e.length&&r.push(e[1].trim().replace(/\\\[/g,"["))}o=t.exec(e)}while(null!==o);return r.join("\n")}(this.result);t=uBlockDashboard.mergeNewLines(n(),t),e.operation((()=>{const n=e.getCursor();o(t),e.setCursor(n),e.focus()}))},r.readAsText(t)})),uDom("#exportUserFiltersToFile").on("click",(function(){const e=n();if(""===e)return;const t=vAPI.i18n("1pExportFilename").replace("{{datetime}}",uBlockDashboard.dateNowToSensibleString()).replace(/ +/g,"_");vAPI.download({url:"data:text/plain;charset=utf-8,"+encodeURIComponent(e+"\n"),filename:t})})),uDom("#userFiltersApply").on("click",(()=>{i()})),uDom("#userFiltersRevert").on("click",(function(){o(t)}));{let n,i=0;(async function(){const e=await vAPI.messaging.send("dashboard",{what:"readUserFilters"});if(e instanceof Object==0||e.error)return;let n=e.content.trim();t=n,o(n),r(!1)})().then((()=>(e.clearHistory(),vAPI.localStorage.getItemAsync("myFiltersCursorPosition")))).then((t=>{"number"==typeof t&&e.setCursor(t,0),e.on("cursorActivity",(()=>{void 0===n&&e.getCursor().line!==i&&(n=vAPI.setTimeout((()=>{n=void 0,i=e.getCursor().line,vAPI.localStorage.setItem("myFiltersCursorPosition",i)}),701))}))}))}e.on("changes",r),CodeMirror.commands.save=i})();