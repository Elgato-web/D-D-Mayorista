"use strict";(()=>{let t,e;vAPI.localStorage.getItemAsync("popupFontSize").then((e=>{"string"==typeof e&&"unset"!==e&&(document.body.style.setProperty("font-size",e),t=e)})),(vAPI.webextFlavor.soup.has("mobile")||/[\?&]responsive=1/.test(window.location.search))&&document.body.classList.add("responsive"),vAPI.localStorage.getItemAsync("popupFirewallPane").then((t=>{e=!0===t||"true"===t,e&&document.getElementById("panes").classList.add("dfEnabled")}));const o=vAPI.messaging,n=/^\d+(?:\.\d+){1,3}$/,a={"/":"*",".":""},s=new Map,i=vAPI.i18n("popupBlockedStats"),l=vAPI.i18n("popupHitDomainCount");let c={},r=!1,u=null,d={},p=0,m=[],g=0,f="";const h=/[\u0400-\u042b\u042d-\u042f\u0431\u0432\u0434\u0436-\u043d\u0442\u0444\u0446-\u0449\u044b-\u0454\u0457\u0459-\u0460\u0462-\u0474\u0476-\u04ba\u04bc\u04be-\u04ce\u04d0-\u0500\u0502-\u051a\u051c\u051e-\u052f]/,b=/[\u042c\u0430\u0433\u0435\u043e\u043f\u0440\u0441\u0443\u0445\u044a\u0455\u0456\u0458\u0461\u0475\u04bb\u04bd\u04cf\u0501\u051b\u051d]/,y=function(){const t=document.getElementById("appinfo").getBoundingClientRect().bottom+window.scrollY+3,e=document.getElementById("firewallContainer").getBoundingClientRect().left+window.scrollX+3,o=document.getElementById("rulesetTools").style;o.setProperty("top",(t>>>0)+"px"),o.setProperty("left",(e>>>0)+"px")},w=function(t){if(c={},a["."]="",s.clear(),"object"!=typeof t)return c;c=t,c.cnameMap=new Map(c.cnameMap),a["."]=c.pageHostname||"";const e=c.hostnameDict;if("object"!=typeof e)return c;for(const t in e){if(!1===e.hasOwnProperty(t))continue;let o=e[t].domain,n=t.slice(0,0-o.length-1);o===c.pageDomain&&(o=" "),s.set(t,o+" "+n.split(".").reverse().join("."))}return c},I=function(t){if("behind-the-scene"===c.pageHostname)return void uDom("body").toggleClass("dirty",!1);const e=[],o=c.firewallRules;for(const t in o){const n=o[t];null!==n&&e.push(n.src+" "+n.des+" "+n.type+" "+n.action)}e.sort(),e.push(uDom("body").hasClass("off")),e.push(uDom.nodeFromId("no-large-media").classList.contains("on")),e.push(uDom.nodeFromId("no-cosmetic-filtering").classList.contains("on")),e.push(uDom.nodeFromId("no-remote-fonts").classList.contains("on")),e.push(uDom.nodeFromId("no-scripting").classList.contains("on"));const n=e.join("");t&&(f=n),uDom("body").toggleClass("dirty",n!==f)},v=function(t){return"number"==typeof t?t.toLocaleString():""},C=function(t,e){let o=t.slice(2,t.indexOf(" ",2));n.test(o)||(o=s.get(o)||" ");let a=e.slice(2,e.indexOf(" ",2));n.test(a)||(a=s.get(a)||" ");const i=o.charCodeAt(0),l=a.charCodeAt(0);return i!==l?i-l:o.localeCompare(a)},P=function(t,e,o,n){const s=document.querySelector(`#firewallContainer div[data-des="${e}"][data-type="${o}"]`);if(null===s)return;const i=s.querySelectorAll(`:scope > span[data-src="${t}"]`);if(0===i.length)return;if(null!==n?i.forEach((t=>{t.setAttribute("class",n.action+"Rule")})):i.forEach((t=>{t.removeAttribute("class")})),null===n||"*"===n.des&&n.type!==o||n.des!==e||n.src!==a[t]||i.forEach((t=>{t.classList.add("ownRule")})),"."!==t||"*"===e)return;if(!1===c.hostnameDict.hasOwnProperty(e))return void i.forEach((t=>{t.removeAttribute("data-acount"),t.removeAttribute("data-bcount")}));const l=c.hostnameDict[e];let r=i[0];0!==l.allowCount?r.setAttribute("data-acount",Math.min(Math.ceil(Math.log(l.allowCount+1)/Math.LN10),3)):r.setAttribute("data-acount","0"),0!==l.blockCount?r.setAttribute("data-bcount",Math.min(Math.ceil(Math.log(l.blockCount+1)/Math.LN10),3)):r.setAttribute("data-bcount","0"),l.domain===e&&(r=i[1],0!==l.totalAllowCount?r.setAttribute("data-acount",Math.min(Math.ceil(Math.log(l.totalAllowCount+1)/Math.LN10),3)):r.setAttribute("data-acount","0"),0!==l.totalBlockCount?r.setAttribute("data-bcount",Math.min(Math.ceil(Math.log(l.totalBlockCount+1)/Math.LN10),3)):r.setAttribute("data-bcount","0"))},D=function(){const t=c.firewallRules;for(const e in t)!1!==t.hasOwnProperty(e)&&P(e.charAt(0),e.slice(2,e.indexOf(" ",2)),e.slice(e.lastIndexOf(" ")+1),t[e]);const e=!0===c.matrixIsDirty;e&&y(),uDom.nodeFromId("firewallContainer").classList.toggle("dirty",e)},A=function(){null===u&&(u=uDom("#actionSelector").on("click","span",B)),u.remove();const t=document.getElementById("firewallContainer"),e=document.createDocumentFragment(),o=document.querySelector("#templates > div:nth-of-type(1)");let n=t.querySelector("div:nth-of-type(7) + div");for(const t of m){null===n&&(n=o.cloneNode(!0),e.appendChild(n)),n.setAttribute("data-des",t);const a=c.hostnameDict[t]||{},s=t===a.domain,i=punycode.toUnicode(t),l=i!==t,r=n.querySelector("span:first-of-type");r.querySelector("span").textContent=i;const u=n.classList;let d="";u.toggle("isCname",c.cnameMap.has(t))?d=punycode.toUnicode(c.cnameMap.get(t)):s&&l&&!0===b.test(i)&&!1===h.test(i)&&(d=t),r.querySelector("sub").textContent=d,u.toggle("isRootContext",t===c.pageHostname),u.toggle("isDomain",s),u.toggle("isSubDomain",!s),u.toggle("allowed",0!==a.allowCount),u.toggle("blocked",0!==a.blockCount),u.toggle("totalAllowed",0!==a.totalAllowCount),u.toggle("totalBlocked",0!==a.totalBlockCount),u.toggle("expandException",z.has(a.domain)),n=n.nextElementSibling}if(null!==n){for(;null!==n.nextElementSibling;)t.removeChild(n.nextElementSibling);t.removeChild(n)}0!==e.childElementCount&&t.appendChild(e),!0!==r&&c.advancedUserEnabled&&(uDom("#firewallContainer").on("click","span[data-src]",H).on("mouseenter","[data-src]",E).on("mouseleave","[data-src]",k),r=!0),D()},S=function(){uDom.nodeFromId("no-popups").classList.toggle("on",!0===c.noPopups),uDom.nodeFromId("no-large-media").classList.toggle("on",!0===c.noLargeMedia),uDom.nodeFromId("no-cosmetic-filtering").classList.toggle("on",!0===c.noCosmeticFiltering),uDom.nodeFromId("no-remote-fonts").classList.toggle("on",!0===c.noRemoteFonts),uDom.nodeFromId("no-scripting").classList.toggle("on",!0===c.noScripting)},L=function(t){for(const e of F){if(void 0!==t&&e[0]!==t)continue;const o=vAPI.i18n(e[1].i18n+(null===uDom.nodeFromSelector(e[1].state)?"1":"2")),n=uDom.nodeFromSelector(e[0]);n.setAttribute("aria-label",o),n.setAttribute("data-tip",o),void 0!==t&&(uDom.nodeFromId("tooltip").textContent=n.getAttribute("data-tip"))}},F=new Map([["#switch",{state:"body.off",i18n:"popupPowerSwitchInfo"}],["#no-popups",{state:"#no-popups.on",i18n:"popupTipNoPopups"}],["#no-large-media",{state:"#no-large-media.on",i18n:"popupTipNoLargeMedia"}],["#no-cosmetic-filtering",{state:"#no-cosmetic-filtering.on",i18n:"popupTipNoCosmeticFiltering"}],["#no-remote-fonts",{state:"#no-remote-fonts.on",i18n:"popupTipNoRemoteFonts"}],["#no-scripting",{state:"#no-scripting.on",i18n:"popupTipNoScripting"}]]);let x=function(){if(x=function(){},c.fontSize!==t&&(t=c.fontSize,"unset"!==t?(document.body.style.setProperty("font-size",t),vAPI.localStorage.setItem("popupFontSize",t)):(document.body.style.removeProperty("font-size"),vAPI.localStorage.removeItem("popupFontSize"))),uDom.nodeFromId("appname").textContent=c.appName,uDom.nodeFromId("version").textContent=c.appVersion,!0!==c.advancedUserEnabled&&uDom("#firewallContainer [data-i18n-tip][data-src]").removeAttr("data-tip"),document.body.classList.contains("responsive"))return;const e=uDom.nodeFromSelector("#panes > div:first-of-type"),o=uDom.nodeFromSelector("#panes > div:last-of-type");let n;o.style.setProperty("height",e.offsetHeight+"px");const a=function(){n=void 0,Math.abs(document.body.offsetWidth-window.innerWidth)<=2&&Math.abs(document.body.offsetHeight-window.innerHeight)<=2||(document.body.classList.add("responsive"),o.style.removeProperty("height"),window.removeEventListener("resize",s))},s=function(){void 0!==n&&clearTimeout(n),n=vAPI.setTimeout(a,67)};window.addEventListener("resize",s),s()};const M=(()=>{let t=!0;{const e=uDom.nodeFromId("no-cosmetic-filtering"),n=e.querySelector(":scope > span.fa-icon-badge");n.textContent="â‹¯";const a=()=>{!1!==t&&(t=!1,e.classList.contains("hnSwitchBusy")||(e.classList.add("hnSwitchBusy"),o.send("popupPanel",{what:"getHiddenElementCount",tabId:c.tabId}).then((t=>{let o;o=0===(t||0)?"":-1===t?"?":Math.min(t,99).toLocaleString(),n.textContent=o,e.classList.remove("hnSwitchBusy")}))))};e.addEventListener("mouseenter",a,{passive:!0})}return async function(){const e=await o.send("popupPanel",{what:"getScriptCount",tabId:c.tabId});uDom.nodeFromSelector("#no-scripting > span.fa-icon-badge").textContent=0!==(e||0)?Math.min(e,99).toLocaleString():"",t=!0}})(),E=function(){!1===uDom(this).hasClass("ownRule")&&u.appendTo(this)},k=function(){u.remove()},R=async function(t,e,n,a,s){if("string"!=typeof c.pageHostname||""===c.pageHostname)return;const i=await o.send("popupPanel",{what:"toggleFirewallRule",tabId:c.tabId,pageHostname:c.pageHostname,srcHostname:t,desHostname:e,requestType:n,action:a,persist:s});0!==a&&u.remove(),w(i),D(),I()},H=function(t){const e=t.target,o=e.closest("[data-des]");R("/"===e.getAttribute("data-src")?"*":c.pageHostname,o.getAttribute("data-des"),o.getAttribute("data-type"),0,t.ctrlKey||t.metaKey),u.appendTo(e)},B=function(t){const e=t.target,o=e.closest("[data-src]");if(null===o)return;const n=o.closest("[data-des]");let a=0;a="dynaAllow"===e.id?2:"dynaNoop"===e.id?3:1,R("/"===o.getAttribute("data-src")?"*":c.pageHostname,n.getAttribute("data-des"),n.getAttribute("data-type"),a,t.ctrlKey||t.metaKey),u.remove()},T=function(t){o.send("popupPanel",{what:"reloadTab",tabId:c.tabId,select:vAPI.webextFlavor.soup.has("mobile"),bypassCache:t.ctrlKey||t.metaKey||t.shiftKey}),c.contentLastModified=-1,uDom("body").toggleClass("dirty",!1)};uDom("#refresh").on("click",T),document.addEventListener("keydown",(t=>{"F5"===t.code&&(T(t),t.preventDefault(),t.stopPropagation())}),{capture:!0});const z=new Set;vAPI.localStorage.getItemAsync("popupExpandExceptions").then((t=>{try{if(!1===Array.isArray(t))return;for(const e of t)z.add(e)}catch(t){}}));const K=function(){vAPI.localStorage.setItem("popupExpandExceptions",Array.from(z))},N=function(t,e=!1){uDom(".expandException").removeClass("expandException"),t?uDom("#firewallContainer").addClass("expanded"):uDom("#firewallContainer").removeClass("expanded"),y(),e||(c.firewallPaneMinimized=!t,z.clear(),K(),o.send("popupPanel",{what:"userSettings",name:"firewallPaneMinimized",value:c.firewallPaneMinimized}))};uDom('[data-i18n="popupAnyRulePrompt"]').on("click",(t=>{if(t.shiftKey&&t.ctrlKey)return o.send("popupPanel",{what:"gotoURL",details:{url:`popup.html?tabId=${c.tabId}&responsive=1`,select:!0,index:-1}}),void vAPI.closePopup();N(!1===uDom("#firewallContainer").hasClass("expanded"))})),uDom("#firewallContainer").on("click",'.isDomain[data-type="*"] > span:first-of-type',(t=>{const e=t.target.closest("[data-des]");null!==e&&function(t,e,o=!1){const n=uDom(`[data-des="${t}"],[data-des$=".${t}"]`);e?n.addClass("expandException"):n.removeClass("expandException"),o||(e?z.add(t):z.delete(t),K())}(e.getAttribute("data-des"),!1===e.classList.contains("expandException"))}));const q=(()=>{let t;const e=async function(){t=void 0;const e=await o.send("popupPanel",{what:"hasPopupContentChanged",tabId:c.tabId,contentLastModified:c.contentLastModified});n(e)},n=function(t){t?O(c.tabId):a()},a=function(){void 0===t&&(t=vAPI.setTimeout(e,1500))};return a})(),O=async function(t){const n=await o.send("popupPanel",{what:"getPopupData",tabId:t});w(n),x(),function(){c.tabTitle&&(document.title=c.appName+" - "+c.tabTitle);let t=document.body;t.classList.toggle("advancedUser",!0===c.advancedUserEnabled),t.classList.toggle("off",""===c.pageURL||!0!==c.netFilteringSwitch);const o=!0===c.canElementPicker&&!0===c.netFilteringSwitch;uDom.nodeFromId("gotoPick").classList.toggle("enabled",o),uDom.nodeFromId("gotoZap").classList.toggle("enabled",o);let n,a=c.pageBlockedRequestCount,s=c.pageAllowedRequestCount+a;n=0===s?v(0):i.replace("{{count}}",v(a)).replace("{{percent}}",v(Math.floor(100*a/s))),uDom.nodeFromId("page-blocked").textContent=n,a=c.globalBlockedRequestCount,s=c.globalAllowedRequestCount+a,n=0===s?v(0):i.replace("{{count}}",v(a)).replace("{{percent}}",v(Math.floor(100*a/s))),uDom.nodeFromId("total-blocked").textContent=n,function(){d={},p=g=0,m=[];const t={},e=Object.keys(c.firewallRules).sort(C);for(const o of e){const e=o.slice(2,o.indexOf(" ",2));if("*"===e||t.hasOwnProperty(e))continue;const n=c.hostnameDict[e]||{};!1===d.hasOwnProperty(n.domain)&&(d[n.domain]=!1,p+=1),0!==n.allowCount&&!1===d[n.domain]&&(d[n.domain]=!0,g+=1),m.push(e),t[e]=!0}const o=l.replace("{{count}}",g.toLocaleString()).replace("{{total}}",p.toLocaleString());uDom.nodeFromId("popupHitDomainCount").textContent=o}(),S(),s=c.popupBlockedCount,uDom.nodeFromSelector("#no-popups > span.fa-icon-badge").textContent=s?Math.min(s,99).toLocaleString():"",s=c.largeMediaCount,uDom.nodeFromSelector("#no-large-media > span.fa-icon-badge").textContent=s?Math.min(s,99).toLocaleString():"",s=c.remoteFontCount,uDom.nodeFromSelector("#no-remote-fonts > span.fa-icon-badge").textContent=s?Math.min(s,99).toLocaleString():"";const r=0!=(16&c.popupPanelSections);r!==e&&(e=r,vAPI.localStorage.setItem("popupFirewallPane",e)),uDom.nodeFromId("panes").classList.toggle("dfEnabled",!0===r),document.documentElement.classList.toggle("colorBlind",!0===c.colorBlindFriendly),N(!1===c.firewallPaneMinimized,!0),r&&A(),L()}(),M(),I(!0),q()};(()=>{let t=null;const e=window.location.search.match(/[\?&]tabId=([^&]+)/);e&&2===e.length&&(t=parseInt(e[1],10)||0),O(t)})(),uDom("#switch").on("click",(function(t){c&&c.pageURL&&(o.send("popupPanel",{what:"toggleNetFiltering",url:c.pageURL,scope:t.ctrlKey||t.metaKey?"page":"",state:!uDom("body").toggleClass("off").hasClass("off"),tabId:c.tabId}),L("#switch"),I())})),uDom("#gotoZap").on("click",(function(){o.send("popupPanel",{what:"launchElementPicker",tabId:c.tabId,zap:!0}),vAPI.closePopup()})),uDom("#gotoPick").on("click",(function(){o.send("popupPanel",{what:"launchElementPicker",tabId:c.tabId}),vAPI.closePopup()})),uDom("h2").on("click",(function(){c.popupPanelSections=16^c.popupPanelSections,o.send("popupPanel",{what:"userSettings",name:"popupPanelSections",value:15|c.popupPanelSections}),e=0!=(16&c.popupPanelSections),vAPI.localStorage.setItem("popupFirewallPane",e),uDom.nodeFromId("panes").classList.toggle("dfEnabled",e),e&&!1===r&&A()})),uDom(".hnSwitch").on("click",(t=>{!async function(t){const e=t.currentTarget,n=e.getAttribute("id");if(!n)return;if(vAPI.webextFlavor.soup.has("mobile")&&e.classList.contains("hnSwitchBusy"))return;e.classList.toggle("on"),L("#"+n);const a=await o.send("popupPanel",{what:"toggleHostnameSwitch",name:n,hostname:c.pageHostname,state:e.classList.contains("on"),tabId:c.tabId,persist:0==(16&c.popupPanelSections)||t.ctrlKey||t.metaKey});w(a),D(),I()}(t)})),uDom("#saveRules").on("click",(function(){o.send("popupPanel",{what:"saveFirewallRules",srcHostname:c.pageHostname,desHostnames:c.hostnameDict}),uDom.nodeFromId("firewallContainer").classList.remove("dirty")})),uDom("#revertRules").on("click",(()=>{!async function(){uDom.nodeFromId("firewallContainer").classList.remove("dirty");const t=await o.send("popupPanel",{what:"revertFirewallRules",srcHostname:c.pageHostname,desHostnames:c.hostnameDict,tabId:c.tabId});w(t),D(),S(),I()}()})),uDom("body").on("mouseenter","[data-tip]",(function(t){if(c.tooltipsDisabled)return;const e=t.target,o=uDom(e).ancestors(".tooltipContainer").nodeAt(0)||document.body,n=o.getBoundingClientRect(),a=uDom.nodeFromId("tooltip");a.textContent=e.getAttribute("data-tip"),a.style.removeProperty("top"),a.style.removeProperty("bottom"),o.appendChild(a);const s=e.getBoundingClientRect();let i;"under"!==e.getAttribute("data-tip-position")?(i=n.height-s.top+n.top,a.style.setProperty("bottom",i+"px")):(i=s.bottom-n.top,a.style.setProperty("top",i+"px")),a.classList.add("show")})).on("mouseleave","[data-tip]",(function(){uDom.nodeFromId("tooltip").classList.remove("show")})),uDom("a[href]").on("click",(function(t){if(!1===this.hasAttribute("href"))return;t.preventDefault();let e=this.getAttribute("href");"logger-ui.html#_"===e&&"number"==typeof c.tabId&&(e+="+"+c.tabId),o.send("popupPanel",{what:"gotoURL",details:{url:e,select:!0,index:-1,shiftKey:t.shiftKey}}),vAPI.closePopup()}))})();