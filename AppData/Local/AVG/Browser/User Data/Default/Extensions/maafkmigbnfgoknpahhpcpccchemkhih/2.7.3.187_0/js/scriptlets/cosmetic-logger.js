"use strict";(()=>{if("object"!=typeof vAPI||vAPI.domWatcher instanceof Object==0)return;const e=/[ >+~]/,t=new Set;let o;const n=new Set;let r;const s=new Map;let i;const c=new Map,a=new Map;let d;const f=new Map,l=new Set,u=new Set,v=/:(?::?after|:?before|:[a-z-]+)$/,m=function(e,t){const o=v.test(e)?e.replace(v,""):e;return t.matches(o)},h=function(e,t=document){const o=v.test(e)?e.replace(v,""):e;return t.querySelector(o)},p=function(e){return(Array.isArray(e)?e:Array.from(e)).map((e=>v.test(e)?e.replace(v,""):e)).join(",\n")},A=function(e,n){if(0!==t.size&&(void 0===o&&(o=p(t)),e!==document&&!1!==e.matches(o)||null!==e.querySelector(o)))for(const r of t)(e!==document&&!1!==m(r,e)||null!==h(r,e))&&(n.push(`##${r}`),t.delete(r),o=void 0,u.add(r))},y=new vAPI.SafeAnimationFrame((()=>{if(y.clear(),0===l.size)return;1!==l.size&&l.has(document)&&(l.clear(),l.add(document));const e=[];if(0!==t.size)for(const t of l)A(t,e);if(function(e){if(0!==n.size&&(void 0===r&&(r=p(n)),null!==document.querySelector(r)))for(const t of n)null!==h(t)&&(e.push(`##${t}`),n.delete(t),r=void 0,u.add(t))}(e),function(e){if(0!==s.size&&(void 0===i&&(i=p(s.keys())),null!==document.querySelector(i)))for(const t of s.keys())if(null!==h(t)){for(const o of s.get(t)){const n=`##${t}:style(${o})`;e.push(n),u.add(n)}s.delete(t),i=void 0}}(e),function(e){if(0!==c.size)for(const[t,o]of c)!1!==o.hit&&(e.push(`##${t}`),c.delete(t))}(e),function(e){if(0!==a.size&&(void 0===d&&(d=p(a.keys())),null!==document.querySelector(d)))for(const[t,o]of a)null!==h(t)&&(e.push(`#@#${o}`),a.delete(t),d=void 0,u.add(o))}(e),function(e){if(0!==f.size)for(const t of f.values())!1!==t.test()&&(e.push(`#@#${t.raw}`),f.delete(t.raw))}(e),l.clear(),0===e.length)return;const o=vAPI.effectiveSelf.location;vAPI.messaging.send("scriptlets",{what:"logCosmeticFilteringData",frameURL:o.href,frameHostname:o.hostname,matchedSelectors:e})})),P=new MutationObserver((e=>{if(!l.has(document)){for(const t of e){const e=t.target;1===e.nodeType&&l.add(e)}0!==l.size&&y.start(100)}})),I={onFiltersetChanged:function(v){for(const c of v.declarative||[])for(let a of c[0].split(",\n"))if("display:none!important;"===c[1])u.has(a)||(e.test(a)?(n.add(a),r=void 0):(t.add(a),o=void 0));else{i=void 0;const e=s.get(a);if(void 0===e){s.set(a,[c[1]]);continue}e.push(c[1])}if(Array.isArray(v.procedural)&&0!==v.procedural.length)for(const e of v.procedural)c.set(e.raw,e);if(Array.isArray(v.exceptions)){for(const e of v.exceptions){if(u.has(e))continue;if(123!==e.charCodeAt(0)){a.set(e,e);continue}const t=JSON.parse(e);void 0===t.action||void 0!==t.tasks||":style"!==t.action[0]?f.set(t.raw,vAPI.domFilterer.createProceduralFilter(t)):a.set(t.selector,t.raw)}d=void 0}l.clear(),l.add(document),y.start(1)},onDOMCreated:function(){if(vAPI.domFilterer instanceof Object==0)return b();I.onFiltersetChanged(vAPI.domFilterer.getAllSelectors()),vAPI.domFilterer.addListener(I),P.observe(document.body,{attributes:!0,subtree:!0})},onDOMChanged:function(e){if(!l.has(document)){for(const t of e)null!==t.parentNode&&l.add(t);0!==l.size&&y.start(100)}}},b=function(){y.clear(),P.disconnect(),"object"==typeof vAPI&&(vAPI.domFilterer instanceof Object&&vAPI.domFilterer.removeListener(I),vAPI.domWatcher instanceof Object&&vAPI.domWatcher.removeListener(I),vAPI.broadcastListener instanceof Object&&vAPI.broadcastListener.remove(g))},g=e=>{"loggerDisabled"===e.what&&b()};vAPI.messaging.extend().then((e=>{if(!0!==e)return b();vAPI.broadcastListener.add(g)})),vAPI.domWatcher.addListener(I)})();