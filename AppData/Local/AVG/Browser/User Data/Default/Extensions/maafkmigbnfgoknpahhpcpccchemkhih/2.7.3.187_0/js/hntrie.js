"use strict";{const t=65536,e=64,s=e+1,i=e+2,r=e+3,h=e+4<<2,n=e=>e+t-1&~(t-1),f=class{constructor(){const n=2*t;this.buf=new Uint8Array(n),this.buf32=new Uint32Array(this.buf.buffer),this.needle="",this.buf32[e]=h,this.buf32[s]=this.buf32[e],this.buf32[i]=n>>>1,this.buf32[r]=this.buf32[i],this.wasmMemory=null,this.lastStored="",this.lastStoredLen=this.lastStoredIndex=0}reset(t){t instanceof Object&&"number"==typeof t.byteLength&&"number"==typeof t.char0&&(t.byteLength>this.buf.byteLength&&this.reallocateBuf(t.byteLength),this.buf32[i]=t.char0),this.buf32[s]=this.buf32[e],this.buf32[r]=this.buf32[i],this.lastStored="",this.lastStoredLen=this.lastStoredIndex=0}setNeedle(t){if(t!==this.needle){const e=this.buf;let s=t.length;for(s>255&&(s=255),e[255]=s;s--;)e[s]=t.charCodeAt(s);this.needle=t}return this}matchesJS(t){const e=this.buf32,s=this.buf,r=e[i];let h=s[255],n=e[t+0];if(0===n)return-1;for(;;){if(0===h)return-1;h-=1;let t,i,f=s[h];for(;t=e[n+2],i=r+(16777215&t),s[i]!==f;)if(n=e[n+0],0===n)return-1;let u=t>>>24;if(u>1){if(u-=1,u>h)return-1;i+=1;const t=i+u;do{if(h-=1,s[i]!==s[h])return-1;i+=1}while(i<t)}if(n=e[n+1],0===n)break;if(0===e[n+2]){if(0===h||46===s[h-1])return h;n=e[n+1]}}return 0===h||46===s[h-1]?h:-1}createOne(t){if(Array.isArray(t))return new this.HNTrieRef(this,t[0],t[1]);this.buf32[i]-this.buf32[s]<12&&this.growBuf(12,0);const e=this.buf32[s]>>>2;return this.buf32[s]+=12,this.buf32[e+0]=0,this.buf32[e+1]=0,this.buf32[e+2]=0,new this.HNTrieRef(this,e,0)}compileOne(t){return[t.iroot,t.size]}addJS(t){let e=this.buf[255];if(0===e)return 0;(this.buf32[i]-this.buf32[s]<24||this.buf.length-this.buf32[r]<256)&&this.growBuf(24,256);let h=this.buf32[t+0];if(0===h)return this.buf32[t+0]=this.addCell(0,0,this.addSegment(e)),1;const n=this.buf32[i];let f;for(;;){const t=this.buf32[h+2];if(0===t){if(46===this.buf[e-1])return-1;h=this.buf32[h+1];continue}let s=n+(16777215&t);if(this.buf[s]!==this.buf[e-1]){if(f=this.buf32[h+0],0===f)return this.buf32[h+0]=this.addCell(0,0,this.addSegment(e)),1;h=f;continue}let i=1;e-=1;const r=t>>>24;if(1!==r)for(;i!==r&&0!==e&&this.buf[s+i]===this.buf[e-1];)i+=1,e-=1;if(i===r)if(f=this.buf32[h+1],0===e){if(0===f||0===this.buf32[f+2])return 0;this.buf32[h+1]=this.addCell(0,f,0)}else{if(0!==f){h=f;continue}if(46===this.buf[e-1])return-1;f=this.addCell(0,0,0),this.buf32[h+1]=f,this.buf32[f+1]=this.addCell(0,0,this.addSegment(e))}else s-=n,this.buf32[h+2]=i<<24|s,f=this.addCell(0,this.buf32[h+1],r-i<<24|s+i),this.buf32[h+1]=f,0===e?this.buf32[h+1]=this.addCell(0,f,0):this.buf32[f+0]=this.addCell(0,0,this.addSegment(e));return 1}}optimize(){return this.shrinkBuf(),{byteLength:this.buf.byteLength,char0:this.buf32[i]}}fromIterable(t,e){void 0===e&&(e="add");const s=this.createOne();for(const i of t)s[e](i);return s}serialize(t){return t instanceof Object?t.encode(this.buf32.buffer,this.buf32[r]):Array.from(new Uint32Array(this.buf32.buffer,0,this.buf32[r]+3>>>2))}unserialize(t,e){this.needle="";const s="string"==typeof t;let i=s?e.decodeSize(t):t.length<<2;if(0===i)return!1;if(i=n(i),null!==this.wasmMemory){const t=this.buf.length>>>16,e=i>>>16;e>t&&(this.wasmMemory.grow(e-t),this.buf=new Uint8Array(this.wasmMemory.buffer),this.buf32=new Uint32Array(this.buf.buffer))}else i>this.buf.length&&(this.buf=new Uint8Array(i),this.buf32=new Uint32Array(this.buf.buffer));return s?e.decode(t,this.buf.buffer):this.buf32.set(t),!0}storeHostname(t){let e=t.length;if(e>255&&(t=t.slice(-255),e=255),e===this.lastStoredLen&&t===this.lastStored)return this.lastStoredIndex;this.lastStored=t,this.lastStoredLen=e,this.buf.length-this.buf32[r]<e&&this.growBuf(0,e);const s=this.buf32[r];this.buf32[r]=s+e;const h=this.buf;for(let i=0;i<e;i++)h[s+i]=t.charCodeAt(i);return this.lastStoredIndex=s-this.buf32[i]}extractHostname(t,e){const s=new TextDecoder,r=this.buf32[i]+t;return s.decode(this.buf.subarray(r,r+e))}matchesHostname(t,e,s){this.setNeedle(t);const r=this.buf,h=r[255];if(s>h)return!1;const n=h-s,f=this.buf32[i]+e;for(let t=0;t<s;t++)if(r[f+t]!==r[n+t])return!1;return s===h||46===t.charCodeAt(n-1)}async enableWASM(){if("object"!=typeof WebAssembly)return!1;if(this.wasmMemory instanceof WebAssembly.Memory)return!0;const t=await u();if(t instanceof WebAssembly.Module==0)return!1;const e=new WebAssembly.Memory({initial:2}),s=await WebAssembly.instantiate(t,{imports:{memory:e,growBuf:this.growBuf.bind(this,24,256)}});if(s instanceof WebAssembly.Instance==0)return!1;this.wasmMemory=e;const i=e.buffer.byteLength>>>16,r=n(this.buf.byteLength)>>>16;r>i&&e.grow(r-i);const h=new Uint8Array(e.buffer);h.set(this.buf),this.buf=h,this.buf32=new Uint32Array(this.buf.buffer),this.matches=this.matchesWASM=s.exports.matches,this.add=this.addWASM=s.exports.add}addCell(t,e,i){let r=this.buf32[s];return this.buf32[s]=r+12,r>>>=2,this.buf32[r+0]=t,this.buf32[r+1]=e,this.buf32[r+2]=i,r}addSegment(t){if(0===t)return 0;let e=this.buf32[r];const s=e-this.buf32[i];let h=t;do{this.buf[e++]=this.buf[--h]}while(0!==h);return this.buf32[r]=e,t<<24|s}growBuf(t,e){const h=Math.max(n(this.buf32[s]+t),this.buf32[i]),f=h+this.buf32[r]-this.buf32[i],u=Math.max(n(f+e),this.buf.length);this.resizeBuf(u,h)}shrinkBuf(){if(null!==this.wasmMemory)return;const t=this.buf32[s]+24,e=t+this.buf32[r]-this.buf32[i]+256;this.resizeBuf(e,t)}resizeBuf(t,e){if((t=n(t))===this.buf.length&&e===this.buf32[i])return;const h=this.buf32[r]-this.buf32[i];if(null!==this.wasmMemory){const e=(t>>>16)-(this.buf.byteLength>>>16);e>0&&(this.wasmMemory.grow(e),this.buf=new Uint8Array(this.wasmMemory.buffer),this.buf32=new Uint32Array(this.wasmMemory.buffer))}else if(t!==this.buf.length){const n=new Uint8Array(t);n.set(new Uint8Array(this.buf.buffer,0,this.buf32[s]),0),n.set(new Uint8Array(this.buf.buffer,this.buf32[i],h),e),this.buf=n,this.buf32=new Uint32Array(this.buf.buffer),this.buf32[i]=e,this.buf32[r]=e+h}e!==this.buf32[i]&&(this.buf.set(new Uint8Array(this.buf.buffer,this.buf32[i],h),e),this.buf32[i]=e,this.buf32[r]=e+h)}reallocateBuf(t){if((t=n(t))!==this.buf.length){if(null===this.wasmMemory){const e=new Uint8Array(t);e.set(e.length<this.buf.length?this.buf.subarray(0,e.length):this.buf),this.buf=e}else{const e=(t+65535>>>16)-(this.buf.length>>>16);if(e<=0)return;this.wasmMemory.grow(e),this.buf=new Uint8Array(this.wasmMemory.buffer)}this.buf32=new Uint32Array(this.buf.buffer)}}};f.prototype.matches=f.prototype.matchesJS,f.prototype.matchesWASM=null,f.prototype.add=f.prototype.addJS,f.prototype.addWASM=null,f.prototype.HNTrieRef=class{constructor(t,e,s){this.container=t,this.iroot=e,this.size=s,this.needle="",this.last=-1}add(t){return this.container.setNeedle(t).add(this.iroot)>0&&(this.last=-1,this.needle="",this.size+=1,!0)}addJS(t){return this.container.setNeedle(t).addJS(this.iroot)>0&&(this.last=-1,this.needle="",this.size+=1,!0)}addWASM(t){return this.container.setNeedle(t).addWASM(this.iroot)>0&&(this.last=-1,this.needle="",this.size+=1,!0)}matches(t){return t!==this.needle&&(this.needle=t,this.last=this.container.setNeedle(t).matches(this.iroot)),this.last}matchesJS(t){return t!==this.needle&&(this.needle=t,this.last=this.container.setNeedle(t).matchesJS(this.iroot)),this.last}matchesWASM(t){return t!==this.needle&&(this.needle=t,this.last=this.container.setNeedle(t).matchesWASM(this.iroot)),this.last}dump(){let t=Array.from(this);if(String.prototype.padStart instanceof Function){const e=Math.min(t.reduce(((t,e)=>Math.max(t,e.length)),0),64);t=t.map((t=>t.padStart(e)))}for(const e of t)console.log(e)}[Symbol.iterator](){return{value:void 0,done:!1,next:function(){if(0===this.icell){if(0===this.forks.length)return this.value=void 0,this.done=!0,this;this.charPtr=this.forks.pop(),this.icell=this.forks.pop()}for(;;){const t=this.container.buf32[this.icell+0];0!==t&&this.forks.push(t,this.charPtr);const e=this.container.buf32[this.icell+2];let s=this.container.buf32[i]+(16777215&e);const r=s+(e>>>24);for(;s<r;)this.charPtr-=1,this.charBuf[this.charPtr]=this.container.buf[s],s+=1;if(this.icell=this.container.buf32[this.icell+1],0===this.icell)return this.toHostname();if(0===this.container.buf32[this.icell+2])return this.icell=this.container.buf32[this.icell+1],this.toHostname()}},toHostname:function(){return this.value=this.textDecoder.decode(new Uint8Array(this.charBuf.buffer,this.charPtr)),this},container:this.container,icell:this.iroot,charBuf:new Uint8Array(256),charPtr:256,forks:[],textDecoder:new TextDecoder}}},f.prototype.HNTrieRef.prototype.last=-1,f.prototype.HNTrieRef.prototype.needle="";const u=(()=>{let t,e;{const t=new URL(document.currentScript.src),s=/[^\/]+$/.exec(t.pathname);null!==s&&(t.pathname=t.pathname.slice(0,s.index)),e=t.href}return async function(){if(t instanceof Promise)return t;if("object"!=typeof WebAssembly||"function"!=typeof WebAssembly.compileStreaming)return;if("object"==typeof vAPI&&!0!==vAPI.canWASM)return;const s=new Uint32Array(1),i=new Uint8Array(s.buffer);return s[0]=1,1===i[0]?(t=fetch(e+"wasm/hntrie.wasm",{mode:"same-origin"}).then(WebAssembly.compileStreaming).catch((t=>{log.info(t)})),t):void 0}})();ÂµBlock.HNTrieContainer=f}