"use strict";(()=>{const e=self.publicSuffixList,t=new Map,o=new CodeMirror.MergeView(document.querySelector(".codeMirrorMergeContainer"),{allowEditingOriginals:!0,connect:"align",inputStyle:"contenteditable",lineNumbers:!0,lineWrapping:!1,origLeft:"",revertButtons:!0,value:""});o.editor().setOption("styleActiveLine",!0),o.editor().setOption("lineNumbers",!1),o.leftOriginal().setOption("readOnly","nocursor"),uBlockDashboard.patchCodeMirrorEditor(o.editor());const n={orig:{doc:o.leftOriginal(),original:[],modified:[]},edit:{doc:o.editor(),original:[],modified:[]}};let i=0,r="",l=!1;{const e=vAPI.i18n("rulesCommit"),t=vAPI.i18n("rulesRevert"),o='.CodeMirror-merge-copybuttons-left .CodeMirror-merge-copy-reverse:not([title="'+e+'"])',n='.CodeMirror-merge-copybuttons-left .CodeMirror-merge-copy:not([title="'+t+'"])';uDom.nodeFromSelector(".CodeMirror-merge-scrolllock").setAttribute("title",vAPI.i18n("genericMergeViewScrollLock")),new MutationObserver((function(){let i=document.querySelectorAll(o);for(const t of i)t.setAttribute("title",e);i=document.querySelectorAll(n);for(const e of i)e.setAttribute("title",t)})).observe(uDom.nodeFromSelector(".CodeMirror-merge-copybuttons-left"),{attributes:!0,attributeFilter:["title"],subtree:!0})}const s=(()=>{let e;return()=>(void 0===e&&(e=new diff_match_patch),e)})(),c=(()=>{let e;const t={token:function(t){if(void 0!==e){e.lastIndex=t.pos;let o=e.exec(t.string);if(null!==o)return o.index===t.pos?(t.pos+=o[0].length||1,"searching"):void(t.pos=o.index)}t.skipToEnd()}};return function(o){return e="string"==typeof o&&""!==o?new RegExp(o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"):void 0,t}})(),u=function(e){const t=n.orig.doc,c=n.edit.doc;t.startOperation(),c.startOperation();for(const t in n){if(!1===n.hasOwnProperty(t))continue;const o=n[t].doc,i=d(t);if(e||1===o.lineCount()&&""===o.getValue()||0===i.length){o.setValue(0!==i.length?i.join("\n")+"\n":"");continue}let r=o.getValue(),l=i.join("\n").trim();""!==l&&(l+="\n");const c=s().diff_main(r,l);let u=c.length,a=r.length;for(;u--;){const e=c[u];if(0===e[0]){a-=e[1].length;continue}const t=o.posFromIndex(a);if(1===e[0]){o.replaceRange(e[1],t,t);continue}a-=e[1].length;const n=o.posFromIndex(a);o.replaceRange("",n,t)}}const u=c.getAllMarks();for(const e of u)!0===e.uboEllipsis&&e.clear();if(l)for(let e=0,t=c.lineCount();e<t;e++)"..."===c.getLine(e)&&(c.markText({line:e,ch:0},{line:e+1,ch:0},{atomic:!0,readOnly:!0}).uboEllipsis=!0);if(t.endOperation(),c.endOperation(),r=o.editor().getValue().trim(),i=o.editor().changeGeneration(),!0!==e)return;o.editor().clearHistory();const a=o.leftChunks();if(0===a.length)return;const g=n.orig.doc,{clientHeight:f}=g.getScrollInfo(),m=Math.min(a[0].editFrom,a[0].origFrom);g.setCursor(m,0),g.scrollIntoView({line:m,ch:0},(f-g.defaultTextHeight())/2)},d=function(e){const t=uDom.nodeFromSelector("#ruleFilter input").value,o=n[e].modified;if(""===t)return o;const i=[];for(const e of o)-1!==e.indexOf(t)&&i.push(e);return i},a=async function(e,t,o){const i=await vAPI.messaging.send("dashboard",{what:"modifyRuleset",permanent:e,toAdd:t,toRemove:o});n.orig.original=i.permanentRules,n.edit.original=i.sessionRules,f()};o.options.revertChunk=function(e,t,o,n,i,r,l){if("rtl"===document.body.getAttribute("dir")){let e=t;t=i,i=e,e=o,o=r,r=e,e=n,n=l,l=e}"number"!=typeof o.ch&&(o.ch=0),0!==n.ch&&(n.line+=1);const s=t.getRange({line:o.line,ch:0},{line:n.line,ch:0});"number"!=typeof r.ch&&(r.ch=0),0!==l.ch&&(l.line+=1);const c=i.getRange({line:r.line,ch:0},{line:l.line,ch:0});a(t===e.editor(),s,c)};const g=(()=>{let e,t=null,n="";const r=function(){if(e=void 0,!1===o.editor().isClean(i))return;const r=uDom.nodeFromSelector("#ruleFilter input").value;r!==n&&(n=r,null!==t&&(o.leftOriginal().removeOverlay(t),o.editor().removeOverlay(t),t=null),""!==r&&(t=c(r),o.leftOriginal().addOverlay(t),o.editor().addOverlay(t)),u(!0))};return function(){void 0!==e&&self.cancelIdleCallback(e),e=self.requestIdleCallback(r,{timeout:773})}})(),f=(()=>{let o=1;const i=/^([^/]+): ([^/ ]+) ([^ ]+)/,r=/^([^ ]+) ([^/ ]+) ([^ ]+ [^ ]+)/,c=/^([^ ]+) ([^ ]+) ([^ ]+ [^ ]+)/,d=function(o){let n=t.get(o);void 0===n&&(n=/(\d|\])$/.test(o)?o:e.getDomain(o),t.set(o,n));let i=n||o;if(o.length!==n.length){const e=o.slice(0,o.length-n.length-1);i+="."+(e.includes(".")?e.split(".").reverse().join("."):e)}return i},a=e=>{let t,n,l,s,u=i.exec(e);return null!==u?(t=" "+u[1],n=d(u[2]),l=n,s=u[3]):null!==(u=r.exec(e))?(t="FFFE",n=d(u[1]),l=d(u[2]),s=u[3]):null!==(u=c.exec(e))&&(t="FFFF",n=d(u[1]),l=d(vAPI.hostnameFromURI(u[2])),s=u[3]),0===o?{rule:e,token:`${t} ${n} ${l} ${s}`}:1===o?{rule:e,token:`${n} ${t} ${l} ${s}`}:{rule:e,token:`${l} ${t} ${n} ${s}`}},g=e=>{const t=[];for(let o=0;o<e.length;o++)t.push(a(e[o]));t.sort(((e,t)=>e.token.localeCompare(t.token)));for(let o=0;o<e.length;o++)e[o]=t[o].rule};return function(i){const r=n.orig,c=n.edit;r.modified=r.original.slice(),c.modified=c.original.slice();const d=document.querySelector("#ruleFilter select");o=parseInt(d.value,10),isNaN(o)&&(o=1);{const n=r.doc.getMode();n.sortType=o,n.setHostnameToDomainMap(t),n.setPSL(e)}{const n=c.doc.getMode();n.sortType=o,n.setHostnameToDomainMap(t),n.setPSL(e)}g(r.modified),g(c.modified),(()=>{if(!0!==l)return;const e=s().diff_main(n.orig.modified.join("\n"),n.edit.modified.join("\n")),t=[];let o=0,i=!1;const r=[];let c=0,u=!1;for(let n=0;n<e.length;n++){const l=e[n];0!==l[0]?l[0]<0?(i&&(t.push("..."),u&&r.push("..."),i=u=!1),t.push(l[1].trim()),o+=1):(u&&(r.push("..."),i&&t.push("..."),i=u=!1),r.push(l[1].trim()),c+=1):(i=u=!0,o+=1,c+=1)}i&&t.push("..."),u&&r.push("..."),n.orig.modified=t,n.edit.modified=r})(),u(i),m(i)}})(),m=(()=>{let e;const t=t=>{e=void 0;const n=document.getElementById("diff");let l=o.editor().isClean(i);void 0===t&&!1===l&&o.editor().getValue().trim()===r&&(i=o.editor().changeGeneration(),l=!0),document.body.classList.toggle("editing",!1===l),n.classList.toggle("dirty",0!==o.leftChunks().length),document.getElementById("editSaveButton").classList.toggle("disabled",l);const s=document.querySelector("#ruleFilter input");l?(s.removeAttribute("disabled"),CodeMirror.commands.save=void 0):(s.setAttribute("disabled",""),CodeMirror.commands.save=p)};return function(o){void 0!==e&&self.cancelIdleCallback(e),e=o?t():self.requestIdleCallback(t,{timeout:57})}})(),p=function(){const e=o.editor().getValue().trim();if(e===r)return void m(!0);const t=[],n=[],i=s().diff_main(r,e);for(const e of i)1===e[0]?t.push(e[1]):-1===e[0]&&n.push(e[1]);a(!1,t.join(""),n.join(""))};self.cloud.onPush=function(){return n.orig.original.join("\n")},self.cloud.onPull=function(e,t){"string"==typeof e&&a(!1,e,t?"":o.editor().getValue().trim())},self.hasUnsavedData=function(){return!1===o.editor().isClean(i)},vAPI.messaging.send("dashboard",{what:"getRules"}).then((t=>{n.orig.original=t.permanentRules,n.edit.original=t.sessionRules,e.fromSelfie(t.pslSelfie),f(!0)})),uDom("#importButton").on("click",(function(){const e=document.getElementById("importFilePicker");e.value="",e.click()})),uDom("#importFilePicker").on("change",(function(){const e=this.files[0];if(void 0===e||""===e.name)return;if(0!==e.type.indexOf("text"))return;const t=new FileReader;t.onload=function(){if("string"!=typeof this.result||""===this.result)return;let e=this.result,t=/\[origins-to-destinations\]([^\[]+)/.exec(e);t&&2===t.length&&(e=t[1].trim().replace(/\|/g," ").replace(/\n/g," * noop\n")),a(!1,e,"")},t.readAsText(e)})),uDom("#exportButton").on("click",(function(){const e=vAPI.i18n("rulesDefaultFileName").replace("{{datetime}}",uBlockDashboard.dateNowToSensibleString()).replace(/ +/g,"_");vAPI.download({url:"data:text/plain,"+encodeURIComponent(o.leftOriginal().getValue().trim()+"\n"),filename:e,saveAs:!0})})),uDom("#revertButton").on("click",(function(){const e=[],t=[],n=o.leftOriginal(),i=o.editor();for(const r of o.leftChunks()){const o=n.getRange({line:r.origFrom,ch:0},{line:r.origTo,ch:0}),l=i.getRange({line:r.editFrom,ch:0},{line:r.editTo,ch:0});e.push(o.trim()),t.push(l.trim())}a(!1,e.join("\n"),t.join("\n"))})),uDom("#commitButton").on("click",(function(){const e=[],t=[],n=o.leftOriginal(),i=o.editor();for(const r of o.leftChunks()){const o=i.getRange({line:r.editFrom,ch:0},{line:r.editTo,ch:0}),l=n.getRange({line:r.origFrom,ch:0},{line:r.origTo,ch:0});e.push(o.trim()),t.push(l.trim())}a(!0,e.join("\n"),t.join("\n"))})),uDom("#editSaveButton").on("click",p),uDom("#ruleFilter input").on("input",g),uDom("#ruleFilter select").on("input",(()=>{f(!0)})),uDom("#ruleFilter #diffCollapse").on("click",(e=>{l=e.target.classList.toggle("active"),f(!0)})),o.editor().on("updateDiff",(()=>{m()}))})();