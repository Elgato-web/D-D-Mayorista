"use strict";(async()=>{const e=µBlock;vAPI.app.onShutdown=function(){const e=µBlock;e.staticFilteringReverseLookup.shutdown(),e.assets.updateStop(),e.staticNetFilteringEngine.reset(),e.staticExtFilteringEngine.reset(),e.sessionFirewall.reset(),e.permanentFirewall.reset(),e.sessionURLFiltering.reset(),e.permanentURLFiltering.reset(),e.sessionSwitches.reset(),e.permanentSwitches.reset()};const t=function(e,t){for(const n in e)!1!==e.hasOwnProperty(n)&&(t[n]=e[n])},n=function(e,t){for(const n in e)!1!==e.hasOwnProperty(n)&&!1!==t.hasOwnProperty(n)&&(e[n]=t[n])},s=function(){const n={dynamicFilteringString:["behind-the-scene * * noop","behind-the-scene * image noop","behind-the-scene * 3p noop","behind-the-scene * inline-script noop","behind-the-scene * 1p-script noop","behind-the-scene * 3p-script noop","behind-the-scene * 3p-frame noop"].join("\n"),urlFilteringString:"",hostnameSwitchesString:["no-large-media: behind-the-scene false"].join("\n"),lastRestoreFile:"",lastRestoreTime:0,lastBackupFile:"",lastBackupTime:0,netWhitelist:e.netWhitelistDefault,version:"0.0.0.0"};return vAPI.webextFlavor.soup.has("firefox")&&(n.hostnameSwitchesString+="\nno-csp-reports: * true"),t(e.localSettings,n),t(e.restoreBackupSettings,n),n};try{await e.restoreAdminSettings(),log.info(`Admin settings ready ${Date.now()-vAPI.T0} ms after launch`),await e.loadHiddenSettings(),log.info(`Hidden settings ready ${Date.now()-vAPI.T0} ms after launch`),"no"===e.hiddenSettings.suspendTabsUntilReady?vAPI.net.unsuspend(!0):"yes"===e.hiddenSettings.suspendTabsUntilReady&&vAPI.net.suspend(),!0!==e.hiddenSettings.disableWebAssembly&&e.staticNetFilteringEngine.enableWASM().then((()=>{log.info(`WASM modules ready ${Date.now()-vAPI.T0} ms after launch`)}));const t=await e.cacheStorage.select(e.hiddenSettings.cacheStorageAPI);log.info(`Backend storage for cache will be ${t}`);const i=await vAPI.adminStorage.get("toAdd");log.info(`Extra admin settings ready ${Date.now()-vAPI.T0} ms after launch`),await Promise.all([e.loadSelectedFilterLists().then((()=>{log.info(`List selection ready ${Date.now()-vAPI.T0} ms after launch`)})),e.cacheStorage.get({compiledMagic:0,selfieMagic:0}).then((t=>{log.info(`Cache magic numbers ready ${Date.now()-vAPI.T0} ms after launch`),async function(t){t.compiledMagic!==e.systemSettings.compiledMagic&&(e.compiledFormatChanged=!0,e.selfieIsInvalid=!0),t.selfieMagic!==e.systemSettings.selfieMagic&&(e.selfieIsInvalid=!0),e.selfieIsInvalid&&(e.selfieManager.destroy(),e.cacheStorage.set(e.systemSettings))}(t)})),vAPI.storage.get(s()).then((t=>{log.info(`First fetch ready ${Date.now()-vAPI.T0} ms after launch`),function(t,i){t instanceof Object==0&&(t=s()),n(e.localSettings,t),n(e.restoreBackupSettings,t),e.permanentFirewall.fromString(t.dynamicFilteringString),e.sessionFirewall.assign(e.permanentFirewall),e.permanentURLFiltering.fromString(t.urlFilteringString),e.sessionURLFiltering.assign(e.permanentURLFiltering),e.permanentSwitches.fromString(t.hostnameSwitchesString),e.sessionSwitches.assign(e.permanentSwitches),function(t,n){if("string"==typeof t&&(t=t.split("\n")),n instanceof Object&&Array.isArray(n.trustedSiteDirectives))for(const s of n.trustedSiteDirectives)e.netWhitelistDefault.push(s),t.push(s);e.netWhitelist=e.whitelistFromArray(t),e.netWhitelistModifyTime=Date.now()}(t.netWhitelist,i),function(t){if(t===vAPI.app.version)return;e.redirectEngine.invalidateResourcesSelfie();const n=vAPI.app.intFromVersion(t);0!==n&&(vAPI.webextFlavor.soup.has("firefox")&&n<=1031003011&&(e.sessionSwitches.toggle("no-csp-reports","*",1),e.permanentSwitches.toggle("no-csp-reports","*",1),e.saveHostnameSwitches()),vAPI.storage.set({version:vAPI.app.version}))}(t.version)}(t,i)})),e.loadUserSettings().then((t=>{log.info(`User settings ready ${Date.now()-vAPI.T0} ms after launch`),function(t){"string"==typeof t.externalLists&&(t.externalLists=t.externalLists.trim().split(/[\n\r]+/)),n(e.userSettings,t),e.privacySettingsSupported&&vAPI.browserSettings.set({hyperlinkAuditing:!e.userSettings.hyperlinkAuditingDisabled,prefetching:!e.userSettings.prefetchingDisabled,webrtcIPAddress:!e.userSettings.webrtcIPAddressHidden})}(t)})),e.loadPublicSuffixList().then((()=>{log.info(`PSL ready ${Date.now()-vAPI.T0} ms after launch`)}))])}catch(e){console.trace(e)}e.staticNetFilteringEngine.prime();let i=!1;try{i=await e.selfieManager.load(),!0===i&&log.info(`Selfie ready ${Date.now()-vAPI.T0} ms after launch`)}catch(e){console.trace(e)}if(!0!==i)try{await e.loadFilterLists(),log.info(`Filter lists ready ${Date.now()-vAPI.T0} ms after launch`)}catch(e){console.trace(e)}if(e.readyToFilter=!0,e.webRequest.start(),e.lz4Codec.relinquish(),async function(){const t=browser.runtime.getManifest();if(t instanceof Object==0)return;const n=[],s=[];{const t={file:"js/scriptlets/should-inject-contentscript.js"},i=await vAPI.tabs.query({url:"<all_urls>"});for(const r of i){if(!0===r.discarded)continue;const{id:i,url:a}=r;e.tabContextManager.commit(i,a),e.bindTabToPageStore(i),n.push(!!/^https?:\/\//.test(a)&&vAPI.tabs.executeScript(i,t)),s.push(i)}}const i=await Promise.all(n);for(let e=0;e<i.length;e++){const n=i[e];if(0!==n.length&&!0===n[0])for(const n of t.content_scripts)for(const t of n.js)vAPI.tabs.executeScript(s[e],{file:t,allFrames:n.all_frames,runAt:n.run_at})}}(),e.assets.addObserver(e.assetObserver.bind(e)),e.scheduleAssetUpdater(e.userSettings.autoUpdate?1e3*e.hiddenSettings.autoUpdateDelayAfterLaunch:0),e.contextMenu.update(),browser.browserAction instanceof Object&&browser.browserAction.setPopup instanceof Function){const t=vAPI.webextFlavor;("classic"===e.hiddenSettings.uiFlavor||"unset"===e.hiddenSettings.uiFlavor&&(t.soup.has("chromium")&&t.major<66||t.soup.has("firefox")&&t.major<68))&&browser.browserAction.setPopup({popup:"popup.html"})}browser.runtime.onUpdateAvailable.addListener((e=>{const t=vAPI.app.intFromVersion;(!0===µBlock.hiddenSettings.extensionUpdateForceReload||t(e.version)<=t(vAPI.app.version))&&vAPI.app.restart()})),log.info(`All ready ${Date.now()-vAPI.T0} ms after launch`)})();