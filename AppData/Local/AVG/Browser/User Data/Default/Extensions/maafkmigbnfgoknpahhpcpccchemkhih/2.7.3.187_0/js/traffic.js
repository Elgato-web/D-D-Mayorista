"use strict";µBlock.webRequest=(()=>{let e=vAPI.webextFlavor.soup.has("firefox"),t=vAPI.webextFlavor.soup.has("firefox")&&vAPI.webextFlavor.major<59;window.addEventListener("webextFlavor",(function(){e=vAPI.webextFlavor.soup.has("firefox"),t=vAPI.webextFlavor.soup.has("firefox")&&vAPI.webextFlavor.major<59}),{once:!0});const n=function(e){const t=µBlock.filteringContext.fromWebrequestDetails(e);if(t.itype===t.MAIN_FRAME)return r(t);const n=e.tabId;if(n<0)return i(t);const o=µBlock;let s=o.pageStoreFromTabId(n);if(null===s){const e=o.tabContextManager.mustLookup(n);if(e.tabId<0)return i(t);vAPI.tabs.onNavigation({tabId:n,frameId:0,url:e.rawURL}),s=o.pageStoreFromTabId(n)}const a=s.filterRequest(t);return s.journalAddRequest(t.getHostname(),a),o.logger.enabled&&t.setRealm("network").toLogger(),void 0!==t.redirectURL?{redirectUrl:t.redirectURL}:1===a?{cancel:!0}:(t.itype===t.SUB_FRAME&&-1!==e.parentFrameId&&void 0===e.aliasURL&&s.setFrameURL(e),2===a?{cancel:!1}:void 0)},r=function(e){const t=µBlock,n=e.url,r=e.getHostname(),i=t.logger.enabled;let s,a=0;const l=!1===t.getNetFilteringSwitch(n);l&&(a=2,i&&(s={engine:"u",result:2,raw:"whitelisted"})),0===a&&t.sessionSwitches.evaluateZ("no-strict-blocking",r)&&(a=2,i&&(s={engine:"u",result:2,raw:`no-strict-blocking: ${t.sessionSwitches.z} true`})),0===a&&p.isBypassed(r)&&(a=2,i&&(s={engine:"u",result:2,raw:"no-strict-blocking: true (temporary)"}));const c=t.staticNetFilteringEngine;0===a&&(a=c.matchString(e,1),(0!==a||i)&&(s=c.toLogData())),0===a&&(e.type="no_type",a=c.matchString(e,1),(0!==a||i)&&(s=c.toLogData()),1===a&&!1===o(n,r,s)&&(a=0,s=void 0),e.type="main_frame");const u=t.bindTabToPageStore(e.tabId,"beforeRequest");if(null!==u&&(u.journalAddRootFrame("uncommitted",n),u.journalAddRequest(r,a)),i&&e.setFilter(s),1!==a&&!1===l&&null!==u&&c.hasQuery(e)&&u.redirectNonBlockedRequest(e),i&&e.setRealm("network").toLogger(),void 0!==e.redirectURL)return{redirectUrl:e.redirectURL};if(1!==a)return;if(void 0===s)return;const d=encodeURIComponent(JSON.stringify({url:n,hn:r,dn:e.getDomain()||r,fs:s.raw}));return vAPI.tabs.replace(e.tabId,vAPI.getURL("document-blocked.html?details=")+d),{cancel:!0}},o=function(e,t,n){if("string"!=typeof n.regex)return!1;if("string"==typeof n.raw&&!1===/\w/.test(n.raw))return!1;const r=new RegExp(n.regex,"i").exec(e.toLowerCase());if(null===r)return!1;const o=e.indexOf(t),i=t.length,s=r.index+r[0].length-o-i;return 0===s||1===s||2===s&&46===e.charCodeAt(o+i)},i=function(e){const t=µBlock,n=t.pageStoreFromTabId(e.tabId);if(null===n)return;let r=0;return(!1===e.tabOrigin.endsWith("-scheme")&&t.URI.isNetworkURI(e.tabOrigin)||t.userSettings.advancedUserEnabled||e.itype===e.CSP_REPORT)&&(r=n.filterRequest(e),1===r&&!1===t.getNetFilteringSwitch(e.tabOrigin)&&(r=2,e.filter={engine:"u",result:2,raw:"whitelisted"})),i.journalAddRequest(e,r),t.logger.enabled&&e.setRealm("network").toLogger(),void 0!==e.redirectURL?{redirectUrl:e.redirectURL}:1===r?{cancel:!0}:void 0};{let e,t="",n=new Set,r=0;const o=function(){t="",n=new Set,r=0},s=()=>{if(e=void 0,r!==µBlock.pageStoresToken)return o();e=vAPI.setTimeout(s,30011)};i.journalAddRequest=(o,i)=>{const a=o.getDocHostname();if(a!==t||r!==µBlock.pageStoresToken){t=a,n=new Set;for(const e of µBlock.pageStores.values())e.tabHostname===a&&n.add(e);r=µBlock.pageStoresToken,void 0!==e&&clearTimeout(e),e=vAPI.setTimeout(s,30011)}for(const e of n)e.journalAddRequest(o.getHostname(),i)}}const s=function(t){if(t.tabId<0&&!1===l(t))return;const n=µBlock,r=n.filteringContext.fromWebrequestDetails(t),o=r.itype===r.MAIN_FRAME;let i=n.pageStoreFromTabId(r.tabId);if(null===i){if(!1===o)return;i=n.bindTabToPageStore(r.tabId,"beforeRequest")}if(!1===i.getNetFilteringSwitch(r))return;if(r.itype===r.IMAGE||r.itype===r.MEDIA){const e=d(t,r,i);if(void 0!==e)return e}const s=t.responseHeaders;if(!1===o&&!0===n.hiddenSettings.filterOnHeaders){const e=i.filterOnHeaders(r,s);if(0!==e&&(n.logger.enabled&&r.setRealm("network").toLogger(),1===e))return i.journalAddRequest(r.getHostname(),1),{cancel:!0}}if(!1===o&&r.itype!==r.SUB_FRAME)return;if(o){const e=g("content-type",s);if(a.test(e))return void(i.allowLargeMediaElementsUntil=0)}const p=n.canFilterResponseData&&!0===c(i,r,t);let m=!0===u(r,i,s);if((p||m)&&e){let e=n.hiddenSettings.cacheControlForFirefox1376932;if("unset"!==e){let t=f("cache-control",s);-1!==t?s[t].value=e:s.push({name:"Cache-Control",value:e}),m=!0}}return m?{responseHeaders:s}:void 0},a=/^(?:audio|image|video)\//,l=function(e){if("xmlhttprequest"!==e.type)return!1;const t=e.responseHeaders;if(!1===Array.isArray(t))return!1;const n=g("content-type",t);return""!==n&&!1!==a.test(n)&&(n.startsWith("image")?e.type="image":e.type="media",!0)},c=function(){const e=µBlock,t=new Map;let n,r,o,i,s;const a=function(e,t){return void 0!==i&&i.encoding!==e&&(i=void 0),void 0===i&&(i=new TextDecoder(e)),i.decode(t)},l=/^(?:text\/html|application\/xhtml\+xml)/i,c=/charset=['"]?([^'" ]+)/i,u=function(e){const t=c.exec(e);if(null!==t)return t[1].toLowerCase()},d=function(e){let t=e.querySelector("meta[charset]");return null!==t?t.getAttribute("charset").toLowerCase():(t=e.querySelector('meta[http-equiv="content-type" i][content]'),null!==t?u(t.getAttribute("content")):void 0)},f=function(e,t){void 0!==t?e.stream.write(t):void 0!==e.buffer&&e.stream.write(e.buffer),e.stream.close()},p=function(e){const n=t.get(this);if(void 0===n)return this.write(e.data),void this.disconnect();if("transferringdata"!==this.status&&"finishedtransferringdata"!==this.status)return t.delete(this),void this.disconnect();if(null===n.buffer)return void(n.buffer=new Uint8Array(e.data));const r=new Uint8Array(n.buffer.byteLength+e.data.byteLength);r.set(n.buffer),r.set(new Uint8Array(e.data),n.buffer.byteLength),n.buffer=r},m=function(){const i=t.get(this);if(t.delete(this),void 0===i||null===i.buffer)return void this.close();if("finishedtransferringdata"!==this.status)return;let l;void 0===n&&(n=new DOMParser,r=new XMLSerializer),void 0===s&&(s=new TextEncoder);let c=i.charset,u=c;if(void 0===c&&(void 0===o&&(o=new TextDecoder),l=n.parseFromString(o.decode(i.buffer.slice(0,1024)),i.mime),c=d(l),u=e.textEncode.normalizeCharset(c),void 0===u))return f(i);if(l=n.parseFromString(a(u,i.buffer),i.mime),void 0===c&&(c=e.textEncode.normalizeCharset(d(l)),c!==u)){if(void 0===c)return f(i);u=c,l=n.parseFromString(a(c,i.buffer),i.mime)}let g=!1;if(void 0!==i.selectors&&e.htmlFilteringEngine.apply(l,i)&&(g=!0),!1===g)return f(i);const p=l.doctype instanceof Object?r.serializeToString(l.doctype)+"\n":"";let m=s.encode(p+l.documentElement.outerHTML);"utf-8"!==u&&(m=e.textEncode.encode(u,m)),f(i,m)},h=function(){t.delete(this)};return function(n,r,o){const i=o.statusCode||0;if(0!==i&&(i<200||i>=300))return;const s=r.getHostname();if(""===s)return;const a=r.getDomain(),c={stream:void 0,tabId:r.tabId,url:r.url,hostname:s,domain:a,entity:e.URI.entityFromDomain(a),selectors:void 0,buffer:null,mime:"text/html",charset:void 0};if(c.selectors=e.htmlFilteringEngine.retrieve(c),void 0===c.selectors)return;const d=o.responseHeaders,f=g("content-type",d);if(""!==f){if(c.mime=function(e){const t=l.exec(e);if(null!==t)return t[0].toLowerCase()}(f),void 0===c.mime)return;let t=u(f);if(void 0!==t){if(t=e.textEncode.normalizeCharset(t),void 0===t)return;c.charset=t}}if(g("content-disposition",d))return;const v=c.stream=browser.webRequest.filterResponseData(o.requestId);return v.ondata=p,v.onstop=m,v.onerror=h,t.set(v,c),!0}}(),u=function(e,n,r){const o=µBlock,i=o.logger.enabled,s=[],a=e.type,l=[];if(1===n.filterScripting(e,!0))l.push(µBlock.cspNoScripting),i&&e.setRealm("network").setType("scripting").toLogger();else{const t=e.duplicate();t.type="inline-script",t.setDocOriginFromURL(e.url);const r=n.filterRequest(t);1===r&&l.push(µBlock.cspNoInlineScript),2===r&&i&&t.setRealm("network").toLogger()}e.type="inline-font",1===n.filterRequest(e)&&(l.push(µBlock.cspNoInlineFont),i&&e.setRealm("network").toLogger()),0!==l.length&&(s[0]=l.join(", ")),e.type=a;const c=o.staticNetFilteringEngine.matchAndFetchModifiers(e,"csp");if(void 0!==c)for(const e of c)1===e.result&&s.push(e.modifier.value);if(0===s.length||2!==o.sessionURLFiltering.evaluateZ(e.getTabHostname(),e.url,"csp")){if(0!==s.length&&o.userSettings.advancedUserEnabled&&2===o.sessionFirewall.evaluateCellZY(e.getTabHostname(),e.getTabHostname(),"*"))i&&e.setRealm("network").setType("csp").setFilter(o.sessionFirewall.toLogData()).toLogger();else if(i&&void 0!==c&&e.setRealm("network").pushFilters(c.map((e=>e.logData()))).toLogger(),0!==s.length){if(o.updateToolbarIcon(e.tabId,2),t){const e=f("content-security-policy",r);-1!==e&&(s.unshift(r[e].value.trim()),r.splice(e,1))}return r.push({name:"Content-Security-Policy",value:s.join(", ")}),!0}}else i&&e.setRealm("network").setType("csp").setFilter(o.sessionURLFiltering.toLogData()).toLogger()},d=function(e,t,n){if(!0===e.fromCache)return;let r=0;if(0!==µBlock.userSettings.largeMediaSize){const t=e.responseHeaders,n=f("content-length",t);if(-1===n)return;r=parseInt(t[n].value,10)||0}return 0!==n.filterLargeMediaElement(t,r)?(µBlock.logger.enabled&&t.setRealm("network").toLogger(),{cancel:!0}):void 0},f=function(e,t){let n=t.length;for(;n--;)if(t[n].name.toLowerCase()===e)return n;return-1},g=function(e,t){const n=f(e,t);return-1!==n?t[n].value:""},p={hostnameToDeadlineMap:new Map,cleanupTimer:void 0,cleanup:function(){for(const[e,t]of this.hostnameToDeadlineMap)t<=Date.now()&&this.hostnameToDeadlineMap.delete(e)},bypass:function(e){"string"==typeof e&&""!==e&&this.hostnameToDeadlineMap.set(e,Date.now()+1e3*µBlock.hiddenSettings.strictBlockingBypassDuration)},isBypassed:function(e){if(0===this.hostnameToDeadlineMap.size)return!1;let t=1e3*µBlock.hiddenSettings.strictBlockingBypassDuration;for(void 0===this.cleanupTimer&&(this.cleanupTimer=vAPI.setTimeout((()=>{this.cleanupTimer=void 0,this.cleanup()}),t+1e4));;){const n=this.hostnameToDeadlineMap.get(e);if(void 0!==n){if(n>Date.now())return this.hostnameToDeadlineMap.set(e,Date.now()+t),!0;this.hostnameToDeadlineMap.delete(e)}const r=e.indexOf(".");if(-1===r)break;e=e.slice(r+1)}return!1}};return{start:(vAPI.net=new vAPI.Net,vAPI.net.suspend(),()=>{vAPI.net.setSuspendableListener(n),vAPI.net.addListener("onHeadersReceived",s,{urls:["http://*/*","https://*/*"]},["blocking","responseHeaders"]),vAPI.net.unsuspend(!0)}),strictBlockBypass:e=>{p.bypass(e)}}})();