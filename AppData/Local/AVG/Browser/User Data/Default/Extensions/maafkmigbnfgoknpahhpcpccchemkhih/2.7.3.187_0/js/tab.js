"use strict";µBlock.normalizePageURL=function(t,e){if(t<0)return"http://behind-the-scene/";const i=this.URI.set(e),o=i.scheme;if("https"===o||"http"===o)return i.normalizedURI();let n=o+"-scheme";return""!==i.hostname?n=i.hostname+"."+n:"about"===o&&""!==i.path&&(n=i.path+"."+n),`http://${n}/`},µBlock.onPopupUpdated=(()=>{const t=µBlock,e=function(e,i,o,n,r="popup"){let s;if(e.setTabOriginFromURL(i).setDocOriginFromURL(o||i).setURL(n).setType("popup"),""!==e.getTabHostname()&&"about:blank"!==n){if("popup"===r&&t.sessionSwitches.evaluateZ("no-popups",e.getTabHostname()))return e.filter={raw:"no-popups: "+t.sessionSwitches.z+" true",result:1,source:"switch"},1;if(s=t.sessionURLFiltering.evaluateZ(e.getTabHostname(),n,r),1===s&&t.sessionURLFiltering.type===r||2===s)return e.filter=t.sessionURLFiltering.toLogData(),s;if(s=t.sessionFirewall.evaluateCellZY(e.getTabHostname(),e.getHostname(),r),2===s)return e.filter=t.sessionFirewall.toLogData(),2}return t.getNetFilteringSwitch(n)&&(e.type=r,s=t.staticNetFilteringEngine.matchString(e,1),0!==s)?(e.filter=t.staticNetFilteringEngine.toLogData(),s):0},i=function(e,i,o,n){if(void 0===e.filter||"static"!==e.filter||e.filter.token===t.staticNetFilteringEngine.noTokenHash)return 0;if(e.filter.token===t.staticNetFilteringEngine.dotTokenHash)return n;const r=new RegExp(e.filter.regex,"i").exec(i);if(null===r)return 0;const s=r.index,a=s+r[0].length,c=i.indexOf(o);return-1===c?0:s>=c&&s<c+o.length&&a>c?n:0};return function(o,n){const r=n.tabId;let s=t.tabContextManager.lookup(r);if(null===s)return;const a=s.rawURL;if(""===a)return;const c=0!==n.frameId?n.frameURL:void 0;if(s=t.tabContextManager.lookup(o),null===s)return;let l=s.rawURL;if(""===l)return;if(!1===t.getNetFilteringSwitch(a))return;if(!1===t.getNetFilteringSwitch(t.normalizePageURL(r,a)))return;if(l.startsWith(vAPI.getURL("document-blocked.html"))){const t=/details=([^&]+)/.exec(l);null!==t&&(l=JSON.parse(decodeURIComponent(t[1])).url)}const u=t.filteringContext.duplicate();let h="popup",d=0;if(function(t,e){if(""===e)return!0;if(e.startsWith("about:"))return!1;let i=t.indexOf("://");return-1!==i&&(t=t.slice(i),i=e.indexOf("://"),-1!==i&&(e=e.slice(i)),e!==t)}(l,n.trustedURL)&&(d=e(u,a,c,l)),0===d&&n.popunder&&(d=function(o,n,r,s){let a=e(o,s,void 0,n,"popunder");if(1===a)return a;let c=n,l=t.URI.hostnameFromURI(c);return""===l?0:(a=i(o,c,l,e(o,s,void 0,c)),0!==a?a:(c=t.URI.originFromURI(c),""===c?0:i(o,c,l,e(o,s,void 0,c))))}(u,a,0,l),1===d&&(h="popunder")),t.logger.enabled&&(u.setRealm("network").setType(h),"popup"===h?u.setURL(l).setTabId(r).setTabOriginFromURL(a).setDocOriginFromURL(c||a):u.setURL(a).setTabId(o).setTabOriginFromURL(l).setDocOriginFromURL(l),u.toLogger()),1!==d)return;const g=t.pageStoreFromTabId(r);return g&&(g.journalAddRequest(u.getHostname(),d),g.popupBlockedCount+=1),t.userSettings.showIconBadge&&t.updateToolbarIcon(r,2),"popup"===h?(t.unbindTabFromPageStore(o),vAPI.tabs.remove(o,!1)):(t.unbindTabFromPageStore(r),vAPI.tabs.remove(r,!0)),!0}})(),µBlock.tabContextManager=(()=>{const t=µBlock,e=new Map;let i="",o=0;const n=new Map,r=async function(e){for(const[i,o]of n)e!==i&&e!==o.opener.tabId||(e===o.opener.tabId&&(o.opener.popunder=!0),!0===await t.onPopupUpdated(i,o.opener)?o.destroy():o.launchSelfDestruction())},s=6e5,a=function(t,e){this.url=t,this.committed=e,this.tstamp=Date.now()},c=function(t){this.tabId=t,this.stack=[],this.rawURL=this.normalURL=this.origin=this.rootHostname=this.rootDomain="",this.commitTimer=null,this.gcTimer=null,this.onGCBarrier=!1,this.netFiltering=!0,this.netFilteringReadTime=0,e.set(t,this)};c.prototype.destroy=function(){vAPI.isBehindTheSceneTabId(this.tabId)||(null!==this.gcTimer&&(clearTimeout(this.gcTimer),this.gcTimer=null),e.delete(this.tabId))},c.prototype.onGC=async function(){if(vAPI.isBehindTheSceneTabId(this.tabId))return;if(this.onGCBarrier)return;this.onGCBarrier=!0,this.gcTimer=null;const t=await vAPI.tabs.get(this.tabId);t instanceof Object==0||!0===t.discarded?this.destroy():this.gcTimer=vAPI.setTimeout((()=>this.onGC()),s),this.onGCBarrier=!1},c.prototype.onCommit=function(){if(vAPI.isBehindTheSceneTabId(this.tabId))return;this.commitTimer=null;let t=this.stack.length;for(;t--&&!this.stack[t].committed;);-1===t&&0!==this.stack.length&&(this.stack[0].committed=!0,t=0),t+=1,t<this.stack.length&&(this.stack.length=t,this.update())},c.prototype.autodestroy=function(){vAPI.isBehindTheSceneTabId(this.tabId)||(this.gcTimer=vAPI.setTimeout((()=>this.onGC()),s))},c.prototype.update=function(){if(this.netFilteringReadTime=0,0===this.stack.length)return void(this.rawURL=this.normalURL=this.origin=this.rootHostname=this.rootDomain="");const e=this.stack[this.stack.length-1];this.rawURL=e.url,this.normalURL=t.normalizePageURL(this.tabId,this.rawURL),this.origin=t.URI.originFromURI(this.normalURL),this.rootHostname=t.URI.hostnameFromURI(this.origin),this.rootDomain=t.URI.domainFromHostname(this.rootHostname)||this.rootHostname},c.prototype.push=function(t){if(vAPI.isBehindTheSceneTabId(this.tabId))return;const e=this.stack.length;0!==e&&this.stack[e-1].url===t||(this.stack.push(new a(t)),this.update(),r(this.tabId),null!==this.commitTimer&&clearTimeout(this.commitTimer),this.commitTimer=vAPI.setTimeout((()=>this.onCommit()),500))},c.prototype.commit=function(t){if(!vAPI.isBehindTheSceneTabId(this.tabId)){if(0!==this.stack.length){const e=this.stack[this.stack.length-1];if(e.url===t&&e.committed)return!1}return this.stack=[new a(t,!0)],this.update(),!0}},c.prototype.getNetFilteringSwitch=function(){return this.netFilteringReadTime>t.netWhitelistModifyTime||(this.netFiltering=t.getNetFilteringSwitch(this.normalURL),this.netFiltering&&this.rawURL!==this.normalURL&&""!==this.rawURL&&(this.netFiltering=t.getNetFilteringSwitch(this.rawURL)),this.netFilteringReadTime=Date.now()),this.netFiltering};const l=function(t,n){let r=e.get(t);return void 0===r&&(r=new c(t),r.autodestroy()),r.push(n),i=n,o=Date.now(),r},u=function(t){return e.get(t)||null};{const e=new c(vAPI.noTabId);e.stack.push(new a("",!0)),e.rawURL="",e.normalURL=t.normalizePageURL(e.tabId),e.origin=t.URI.originFromURI(e.normalURL),e.rootHostname=t.URI.hostnameFromURI(e.origin),e.rootDomain=t.URI.domainFromHostname(e.rootHostname)}const h=[];return{push:l,commit:function(t,i){let o=e.get(t);return void 0===o?o=l(t,i):o.commit(i)&&r(t),o},lookup:u,mustLookup:function(t){const n=e.get(t);return void 0!==n?n:(""!==i&&o+500<Date.now()&&(i=""),""!==i?l(t,i):e.get(vAPI.noTabId))},exists:function(t){return void 0!==e.get(t)},createContext:function(t){return h.length?h.pop().init(t):new class{constructor(t){this.init(t)}init(t){const e=u(t);return this.rootHostname=e.rootHostname,this.rootDomain=e.rootDomain,this.pageHostname=this.pageDomain=this.requestURL=this.origin=this.requestHostname=this.requestDomain="",this}dispose(){h.push(this)}}(t)},onTabCreated:async function(e){const{sourceTabId:i,sourceFrameId:o,tabId:s}=e;if(void 0===n.get(s)){let r;try{r=await Promise.all([webext.webNavigation.getFrame({tabId:e.sourceTabId,frameId:0}),webext.webNavigation.getFrame({tabId:i,frameId:o})])}catch(t){return}if(!1===Array.isArray(r)||2!==r.length||"about:newtab"===r[1].url)return;n.set(s,new class{constructor(e,i){this.targetTabId=e.tabId,this.opener={tabId:e.sourceTabId,tabURL:i[0].url,frameId:e.sourceFrameId,frameURL:i[1].url,popunder:!1,trustedURL:e.sourceTabId===t.maybeGoodPopup.tabId?t.maybeGoodPopup.url:""},this.selfDestructionTimer=null,this.launchSelfDestruction()}destroy(){null!==this.selfDestructionTimer&&clearTimeout(this.selfDestructionTimer),n.delete(this.targetTabId)}launchSelfDestruction(){null!==this.selfDestructionTimer&&clearTimeout(this.selfDestructionTimer),this.selfDestructionTimer=vAPI.setTimeout((()=>this.destroy()),1e4)}}(e,r))}r(s)}}})(),vAPI.Tabs=class extends vAPI.Tabs{onActivated(t){super.onActivated(t),vAPI.isBehindTheSceneTabId(t.tabId)||(µBlock.updateToolbarIcon(t.tabId),µBlock.contextMenu.update(t.tabId))}onClosed(t){super.onClosed(t),vAPI.isBehindTheSceneTabId(t)||(µBlock.unbindTabFromPageStore(t),µBlock.contextMenu.update())}onCreated(t){super.onCreated(t),µBlock.tabContextManager.onTabCreated(t)}onNavigation(t){super.onNavigation(t);const e=µBlock,{frameId:i,tabId:o,url:n}=t;if(0===i){e.tabContextManager.commit(o,n);const t=e.bindTabToPageStore(o,"tabCommitted");null!==t&&t.journalAddRootFrame("committed",n)}const r=e.pageStoreFromTabId(o);null!==r&&(r.setFrameURL(t),e.canInjectScriptletsNow&&e.URI.isNetworkURI(n)&&r.getNetFilteringSwitch()&&e.scriptletFilteringEngine.injectNow(t))}onUpdated(t,e,i){super.onUpdated(t,e,i),i.url&&""!==i.url&&e.url&&(µBlock.tabContextManager.commit(t,e.url),µBlock.bindTabToPageStore(t,"tabUpdated"))}},vAPI.tabs=new vAPI.Tabs,µBlock.bindTabToPageStore=function(t,e){if(this.updateToolbarIcon(t,7),!1===this.tabContextManager.exists(t))return this.unbindTabFromPageStore(t),null;let i=this.pageStores.get(t);return void 0===i?(this.updateTitle(t),i=this.PageStore.factory(t,e),this.pageStores.set(t,i),this.pageStoresToken=Date.now(),i):vAPI.isBehindTheSceneTabId(t)?i:"beforeRequest"===e?(i.netFilteringCache.empty(),i):(i.reuse(e),this.updateTitle(t),this.pageStoresToken=Date.now(),i)},µBlock.unbindTabFromPageStore=function(t){const e=this.pageStores.get(t);void 0!==e&&(e.dispose(),this.pageStores.delete(t),this.pageStoresToken=Date.now())},µBlock.pageStoreFromTabId=function(t){return this.pageStores.get(t)||null},µBlock.mustPageStoreFromTabId=function(t){return this.pageStores.get(t)||this.pageStores.get(vAPI.noTabId)};{const t=new class extends µBlock.PageStore{getNetFilteringSwitch(t){if(t&&0===t.docId){const e=t.getDocOrigin();if(e)return µBlock.getNetFilteringSwitch(e)}return super.getNetFilteringSwitch()}}(vAPI.noTabId);µBlock.pageStores.set(t.tabId,t),t.title=vAPI.i18n("logBehindTheScene")}µBlock.updateToolbarIcon=(()=>{const t=µBlock,e=new Map;return function(i,o=7){if("number"!=typeof i)return;if(vAPI.isBehindTheSceneTabId(i))return;let n=e.get(i);n!==o&&(void 0===n?self.requestIdleCallback((()=>(i=>{let o=e.get(i);e.delete(i);let n=0,r="",s="#666",a=t.pageStoreFromTabId(i);null!==a&&(n=a.getNetFilteringSwitch()?1:0,1===n&&(0!=(2&o)&&a.perLoadBlockedRequestCount&&(r=t.formatCount(a.perLoadBlockedRequestCount)),0!=(4&o)&&(s=(e=>{let i=t.blockingProfileColorCache.get(e);if(void 0!==i)return i;let o=0;for(const n of t.liveBlockingProfiles){const t=-2&e&n.bits;if(t<o)break;i=n.color,o=t}return void 0===i&&(i="#666"),t.blockingProfileColorCache.set(e,i),i})(t.blockingModeFromHostname(a.tabHostname))))),!1===t.userSettings.showIconBadge&&(o|=8),vAPI.setIcon(i,{parts:o,state:n,badge:r,color:s})})(i)),{timeout:701}):o|=n,e.set(i,o))}})(),µBlock.updateTitle=(()=>{const t=new Map,e=function(i){vAPI.setTimeout((()=>{!async function(i){let o=t.get(i);if(void 0===o)return;t.delete(i);const n=await vAPI.tabs.get(i);if(n instanceof Object==0||!0===n.discarded)return;const r=µBlock,s=r.pageStoreFromTabId(i);if(null===s)return;s.rawURL=n.url,r.pageStoresToken=Date.now();const a="string"==typeof n.title&&""!==n.title&&n.title===s.title;s.title=n.title||n.url||"",a||t.has(i)||(o-=1,0!==o&&(t.set(i,o),e(i)))}(i)}),499)};return function(i){if(vAPI.isBehindTheSceneTabId(i))return;const o=t.get(i);t.set(i,5),void 0===o&&e(i)}})();{const t=9e5;let e=0,i=10;const o=async t=>{const e=await vAPI.tabs.get(t);e instanceof Object&&!0!==e.discarded||µBlock.unbindTabFromPageStore(t)},n=function(){const r=Array.from(µBlock.pageStores.keys()).sort();e>=r.length&&(e=0);const s=Math.min(e+i,r.length);for(let t=e;t<s;t++){const e=r[t];vAPI.isBehindTheSceneTabId(e)||o(e)}e=s,vAPI.setTimeout(n,t)};vAPI.setTimeout(n,t)}