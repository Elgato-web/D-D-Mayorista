"use strict";µBlock.staticExtFilteringEngine=(()=>{const t=µBlock;return{get acceptedCount(){return t.cosmeticFilteringEngine.acceptedCount+t.scriptletFilteringEngine.acceptedCount+t.htmlFilteringEngine.acceptedCount},get discardedCount(){return t.cosmeticFilteringEngine.discardedCount+t.scriptletFilteringEngine.discardedCount+t.htmlFilteringEngine.discardedCount},HostnameBasedDB:class{constructor(t,e){this.nBits=t,this.timer=void 0,this.strToIdMap=new Map,this.hostnameToSlotIdMap=new Map,this.hostnameSlots=[],this.strSlots=[],this.size=0,void 0!==e&&this.fromSelfie(e)}store(t,e,i){this.size+=1;let s=this.strToIdMap.get(i);void 0===s&&(s=this.strSlots.length,this.strSlots.push(i),this.strToIdMap.set(i,s),void 0===this.timer&&this.collectGarbage(!0));const n=s<<this.nBits|e;let o=this.hostnameToSlotIdMap.get(t);if(void 0===o)return this.hostnameToSlotIdMap.set(t,this.hostnameSlots.length),void this.hostnameSlots.push(n,0);for(;0!==this.hostnameSlots[o+1];)o=this.hostnameSlots[o+1];this.hostnameSlots[o+1]=this.hostnameSlots.length,this.hostnameSlots.push(n,0)}clear(){this.hostnameToSlotIdMap.clear(),this.hostnameSlots.length=0,this.strSlots.length=0,this.strToIdMap.clear(),this.size=0}collectGarbage(t=!1){if(!1===t)return void 0!==this.timer&&(self.cancelIdleCallback(this.timer),this.timer=void 0),void this.strToIdMap.clear();void 0===this.timer&&(this.timer=self.requestIdleCallback((()=>{this.timer=void 0,this.strToIdMap.clear()}),{timeout:1e4}))}retrieve(t,e,i=0){2===i&&(t="");const s=e.length-1;for(;;){let n=this.hostnameToSlotIdMap.get(t);if(void 0!==n)do{const t=this.hostnameSlots[n+0];e[t&s].add(this.strSlots[t>>>this.nBits]),n=this.hostnameSlots[n+1]}while(0!==n);if(""===t)break;const o=t.indexOf(".");if(-1===o){if(1===i)break;t=""}else t=t.slice(o+1)}}toSelfie(){return{hostnameToSlotIdMap:Array.from(this.hostnameToSlotIdMap),hostnameSlots:this.hostnameSlots,strSlots:this.strSlots,size:this.size}}fromSelfie(t){this.hostnameToSlotIdMap=new Map(t.hostnameToSlotIdMap),this.hostnameSlots=t.hostnameSlots,this.strSlots=t.strSlots,this.size=t.size}},SessionDB:class{constructor(){this.db=new Map}compile(t){return t}add(t,e){const i=this.db.get(t);void 0===i?this.db.set(t,new Set([e])):i.add(e)}remove(t,e){const i=this.db.get(t);void 0!==i&&(i.delete(e),0===i.size&&this.db.delete(t))}retrieve(t){const e=t.length-1;for(const[i,s]of this.db){const n=i&e;if(t[n]instanceof Object!=0)for(const e of s)t[n].add(e)}}has(t,e){const i=this.db.get(t);return void 0!==i&&i.has(e)}clear(){this.db.clear()}get isNotEmpty(){return 0!==this.db.size}},reset:function(){t.cosmeticFilteringEngine.reset(),t.scriptletFilteringEngine.reset(),t.htmlFilteringEngine.reset()},freeze:function(){t.cosmeticFilteringEngine.freeze(),t.scriptletFilteringEngine.freeze(),t.htmlFilteringEngine.freeze()},compile:function(e,i){if(e.category!==e.CATStaticExtFilter)return!1;if(0!=(e.flavorBits&e.BITFlavorUnsupported)){const s=i.properties.get("assetKey")||"?";return t.logger.writeOne({realm:"message",type:"error",text:`Invalid extended filter in ${s}: ${e.raw}`}),!0}return 0!=(e.flavorBits&e.BITFlavorExtScriptlet)?(t.scriptletFilteringEngine.compile(e,i),!0):0!=(e.flavorBits&e.BITFlavorExtHTML)?(t.htmlFilteringEngine.compile(e,i),!0):(t.cosmeticFilteringEngine.compile(e,i),!0)},fromCompiledContent:function(e,i){t.cosmeticFilteringEngine.fromCompiledContent(e,i),t.scriptletFilteringEngine.fromCompiledContent(e,i),t.htmlFilteringEngine.fromCompiledContent(e,i)},toSelfie:function(e){return µBlock.assets.put(`${e}/main`,JSON.stringify({cosmetic:t.cosmeticFilteringEngine.toSelfie(),scriptlets:t.scriptletFilteringEngine.toSelfie(),html:t.htmlFilteringEngine.toSelfie()}))},fromSelfie:function(e){return µBlock.assets.get(`${e}/main`).then((e=>{let i;try{i=JSON.parse(e.content)}catch(t){}return i instanceof Object!=0&&(t.cosmeticFilteringEngine.fromSelfie(i.cosmetic),t.scriptletFilteringEngine.fromSelfie(i.scriptlets),t.htmlFilteringEngine.fromSelfie(i.html),!0)}))}}})();