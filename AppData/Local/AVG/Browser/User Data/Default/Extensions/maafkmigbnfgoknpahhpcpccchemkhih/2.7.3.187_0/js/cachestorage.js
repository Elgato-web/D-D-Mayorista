"use strict";µBlock.cacheStorage=function(){const e="uBlock0CacheStorage",o=webext.storage.local,t={name:"browser.storage.local",get:o.get,set:o.set,remove:o.remove,clear:o.clear,getBytesInUse:o.getBytesInUse,select:function(e){let o=e;return void 0!==o&&"unset"!==o||(o=vAPI.webextFlavor.soup.has("firefox")?"indexedDB":"browser.storage.local"),"indexedDB"===o?n().then((o=>o||"indexedDB"===e?(r(),"indexedDB"):(c(),"browser.storage.local"))):("browser.storage.local"===o&&c(),Promise.resolve("browser.storage.local"))},error:void 0},n=async function(){let o,n,r;const c=function(){},s=function(){return void 0!==r&&clearTimeout(r),r=vAPI.setTimeout((()=>{r=void 0,void 0!==r&&(clearTimeout(r),r=void 0),o instanceof IDBDatabase&&(o.close(),o=void 0)}),Math.max(2*µBlock.hiddenSettings.autoUpdateAssetFetchPeriod*1e3,18e4)),void 0!==o?Promise.resolve(o):(void 0!==n||(n=new Promise((t=>{let r;try{r=indexedDB.open(e,1),r.error&&(console.log(r.error),r=void 0)}catch(e){}if(void 0===r)return o=null,n=void 0,t(null);r.onupgradeneeded=function(o){if(1!==o.oldVersion)try{o.target.result.createObjectStore(e,{keyPath:"key"})}catch(e){r.onerror()}},r.onsuccess=function(e){void 0!==t&&(r=void 0,o=e.target.result,n=void 0,t(o),t=void 0)},r.onerror=r.onblocked=function(){void 0!==t&&(r=void 0,console.log(this.error),o=null,n=void 0,t(null),t=void 0)},setTimeout((()=>{void 0!==t&&(o=null,n=void 0,t(null),t=void 0)}),5e3)}))),n)},i=function(e){return e instanceof Blob==0?Promise.resolve(e):new Promise((o=>{const t=new FileReader;t.onloadend=e=>{o(new Uint8Array(e.target.result))},t.readAsArrayBuffer(e)}))},a=function(e){const o=e instanceof Uint8Array?new Blob([e]):e;return Promise.resolve(o)},l=function(e,o,t){return µBlock.lz4Codec.encode(t,a).then((t=>{e.push({key:o,value:t})}))},u=function(e,o,t){return µBlock.lz4Codec.decode(t,i).then((t=>{e[o]=t}))};return await s(),!!o&&(t.name="indexedDB",t.get=function(o){return new Promise((t=>{if(null===o)return function(o){if("function"!=typeof o)return;const t=[],n={};(async function(o){const t=await s();if(!t)return o();const n=t.transaction(e,"readonly");n.oncomplete=n.onerror=n.onabort=()=>o(),n.objectStore(e).openCursor().onsuccess=function(e){let t=e.target&&e.target.result;if(!t)return;let n=t.value;o(n),t.continue()}})((e=>{if(void 0===e)return void Promise.all(t).then((()=>{o(n)}));const{key:r,value:c}=e;n[r]=c,e.value instanceof Blob!=0&&t.push(u(n,r,c))})).catch((e=>{console.info(`cacheStorage.getAllFromDb() failed: ${e}`),o()}))}((e=>t(e)));let n,r={};"string"==typeof o?n=[o]:Array.isArray(o)?n=o:(n=Object.keys(o),r=o),async function(o,t,n){if(0===o.length)return n(t);const r=[],i=function(){if("object"!=typeof this.result)return;const{key:e,value:o}=this.result;t[e]=o,o instanceof Blob!=0&&r.push(u(t,e,o))};try{const a=await s();if(!a)return n();const l=a.transaction(e,"readonly");l.oncomplete=l.onerror=l.onabort=()=>{Promise.all(r).then((()=>{n(t)}))};const u=l.objectStore(e);for(const e of o){const o=u.get(e);o.onsuccess=i,o.onerror=c}}catch(e){console.info(`cacheStorage.getFromDb() failed: ${e}`),n()}}(n,r,(e=>t(e)))}))},t.set=function(o){return new Promise((t=>{!async function(o,t){"function"!=typeof t&&(t=c);const n=Object.keys(o);if(0===n.length)return t();const r=[s()],i=[],a=!0!==µBlock.hiddenSettings.cacheStorageCompression;for(const e of n){const t=o[e];0==("string"==typeof t)||a?i.push({key:e,value:t}):r.push(l(i,e,t))}const u=()=>{if(void 0===t)return;let e=t;t=void 0,e()};try{const o=(await Promise.all(r))[0];if(!o)return t();const n=o.transaction(e,"readwrite");n.oncomplete=n.onerror=n.onabort=u;const c=n.objectStore(e);for(const e of i)c.put(e)}catch(e){u()}}(o,(e=>t(e)))}))},t.remove=function(o){return new Promise((t=>{!async function(o,t){"function"!=typeof t&&(t=c);const n=Array.isArray(o)?o.slice():[o];if(0===n.length)return t();const r=()=>{if(void 0===t)return;let e=t;t=void 0,e()};try{const o=await s();if(!o)return t();const c=o.transaction(e,"readwrite");c.oncomplete=c.onerror=c.onabort=r;const i=c.objectStore(e);for(const e of n)i.delete(e)}catch(e){r()}}(o,(()=>t()))}))},t.clear=function(){return new Promise((o=>{!async function(o){"function"!=typeof o&&(o=c);try{const t=await s();if(!t)return o();const n=t.transaction(e,"readwrite");n.oncomplete=n.onerror=n.onabort=()=>{o()},n.objectStore(e).clear()}catch(e){console.info(`cacheStorage.clearDb() failed: ${e}`),o()}}((()=>o()))}))},t.getBytesInUse=function(){return Promise.resolve(0)},!0)},r=async function(){const e=await webext.storage.local.get("assetCacheRegistry");if(e instanceof Object==0||e.assetCacheRegistry instanceof Object==0)return;const o=["assetCacheRegistry","assetSourceRegistry","resourcesSelfie","selfie"];for(const t in e.assetCacheRegistry)e.assetCacheRegistry.hasOwnProperty(t)&&o.push("cache/"+t);webext.storage.local.remove(o)},c=function(){try{indexedDB.deleteDatabase(e)}catch(e){}};return t}();