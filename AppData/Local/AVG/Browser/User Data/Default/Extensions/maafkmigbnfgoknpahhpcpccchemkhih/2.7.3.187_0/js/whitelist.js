"use strict";(()=>{const e=/^\s*#\s*/,t=function(t){const n=e.exec(t);return null===n?t.trim():t.slice(n.index+n[0].length).trim()};let n,i;CodeMirror.defineMode("ubo-whitelist-directives",(function(){const r=/^\/.+\/$/;return{token:function(s){const l=s.string.trim();if(s.skipToEnd(),void 0===n)return null;if(e.test(l))return o.has(t(l))?"keyword comment":"comment";if(-1===l.indexOf("/"))return n.test(l)?"error":o.has(l.trim())?"keyword":null;if(r.test(l)){try{new RegExp(l.slice(1,-1))}catch(e){return"error"}return null}return!1===i.test(l)?"error":o.has(l.trim())?"keyword":null}}}));let o=new Set;const r=vAPI.messaging,s=function(){};let l="";const c=new CodeMirror(document.getElementById("whitelist"),{autofocus:!0,lineNumbers:!0,lineWrapping:!0,styleActiveLine:!0});uBlockDashboard.patchCodeMirrorEditor(c);const a=function(){let e=c.getValue().replace(/\s+$/,"");return""===e?e:e+"\n"},u=function(e){c.setValue(e.replace(/\s+$/,"")+"\n")};c.on("changes",(function(){const e=null!==uDom.nodeFromId("whitelist").querySelector(".cm-error"),t=a().trim()!==l;uDom.nodeFromId("whitelistApply").disabled=!t||e,uDom.nodeFromId("whitelistRevert").disabled=!t,CodeMirror.commands.save=t&&!e?m:s}));const d=async function(){const e=await r.send("dashboard",{what:"getWhitelist"}),s=void 0===n;s&&(n=new RegExp(e.reBadHostname),i=new RegExp(e.reHostnameExtractor),o=new Set(e.whitelistDefault));const a=new Set(o);for(const n of e.whitelist){const e=t(n);if(!1!==o.has(e)&&(a.delete(e),0===a.size))break}0!==a.size&&e.whitelist.push(...Array.from(a).map((e=>`# ${e}`))),e.whitelist.sort(((e,n)=>{const i=t(e),r=t(n),s=o.has(i);return s!==o.has(r)?s?-1:1:i.localeCompare(r)}));const d=e.whitelist.join("\n").trim();l=d,u(d),s&&c.clearHistory()},m=async function(){l=a().trim(),await r.send("dashboard",{what:"setWhitelist",whitelist:l}),d()};self.cloud.onPush=function(){return a()},self.cloud.onPull=function(e,t){"string"==typeof e&&(t&&(e=uBlockDashboard.mergeNewLines(a().trim(),e)),u(e.trim()))},self.hasUnsavedData=function(){return a().trim()!==l},uDom("#importWhitelistFromFile").on("click",(function(){const e=document.getElementById("importFilePicker");e.value="",e.click()})),uDom("#importFilePicker").on("change",(function(){const e=this.files[0];if(void 0===e||""===e.name)return;if(0!==e.type.indexOf("text"))return;const t=new FileReader;t.onload=e=>{"load"===e.type&&u([a().trim(),t.result.trim()].join("\n").trim())},t.readAsText(e)})),uDom("#exportWhitelistToFile").on("click",(function(){const e=a();if(""===e)return;const t=vAPI.i18n("whitelistExportFilename").replace("{{datetime}}",uBlockDashboard.dateNowToSensibleString()).replace(/ +/g,"_");vAPI.download({url:`data:text/plain;charset=utf-8,${encodeURIComponent(e+"\n")}`,filename:t})})),uDom("#whitelistApply").on("click",(()=>{m()})),uDom("#whitelistRevert").on("click",(function(){u(l)})),d()})();