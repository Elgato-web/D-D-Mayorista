"use strict";µBlock.assets=(()=>{const t=/^(?:[a-z-]+):\/\//,e=/^user-/,n=vAPI.i18n("errorCantConnectTo"),s={};let o=!1;const r=[];s.addObserver=function(t){-1===r.indexOf(t)&&r.push(t)},s.removeObserver=function(t){let e;for(;-1!==(e=r.indexOf(t));)r.splice(e,1)};const c=function(t,e){let n;for(const s of r){const o=s(t,e);void 0!==o&&(n=o)}return n};s.fetch=function(t,e={}){return new Promise(((s,o)=>{const r=1e3*µBlock.hiddenSettings.assetFetchTimeout||3e4,c=new XMLHttpRequest;let i,a=0;const u=function(){c.removeEventListener("load",l),c.removeEventListener("error",d),c.removeEventListener("abort",d),c.removeEventListener("progress",y),void 0!==i&&(clearTimeout(i),i=void 0)},f=function(t,e){µBlock.logger.writeOne({realm:"message",type:"error",text:e}),t.content="",t.error=e,o(t)},l=function(){u();const e={url:t,statusCode:this.status||200,statusText:this.statusText||""};if(e.statusCode<200||e.statusCode>=300)return f(e,`${t}: ${e.statusCode} ${e.statusText}`);e.content=this.response,s(e)},d=function(){u(),f({url:t},n.replace("{{msg}}",t))},h=function(){c.abort()},y=function(t){t.loaded!==a&&(a=t.loaded,void 0!==i&&clearTimeout(i),i=vAPI.setTimeout(h,r))};try{c.open("get",t,!0),c.addEventListener("load",l),c.addEventListener("error",d),c.addEventListener("abort",d),c.addEventListener("progress",y),c.responseType=e.responseType||"text",c.send(),i=vAPI.setTimeout(h,r)}catch(t){d.call(c)}}))},s.fetchText=async function(e){const n=t.test(e);let r=n?e:vAPI.getURL(e);if(n&&!0!==o){const t="_="+(µBlock.hiddenSettings.updateAssetBypassBrowserCache?Math.floor(Date.now()/1e3)%86413:Math.floor(Date.now()/36e5)%13);-1===r.indexOf("?")?r+="?":r+="&",r+=t}let c={content:""};try{c=await s.fetch(r),!1===L(c.content)&&(c.content="");const t=c.content.trim();t.startsWith("<")&&t.endsWith(">")&&(c.content="")}catch(t){c=t}return c.url=e,c},s.fetchFilterList=async function(e){const n=t=>{try{return new URL(t)}catch(t){}};let o=n(t.test(e)?e:vAPI.getURL(e));if(void 0!==o){const t=o.pathname.lastIndexOf("/");-1!==t?o.pathname=o.pathname.slice(0,t+1):o=void 0}const r=new Set,c=function(t){const e=[],c=/^!#include +(\S+)/gm;for(const i of t){if("string"==typeof i){e.push(i);continue}if(i instanceof Object==0)continue;const t=i.content,a=µBlock.preparseDirectives.split(t);for(let u=0,f=a.length-1;u<f;u++){const f=t.slice(a[u+0],a[u+1]);if(0!=(1&u)){e.push(f);continue}let l=0;for(;void 0!==o;){const t=c.exec(f);if(null===t)break;if(void 0!==n(t[1]))continue;if(-1!==t[1].indexOf(".."))continue;const o=i.url.lastIndexOf("/");if(-1===o)continue;const a=i.url.slice(0,o+1)+t[1];r.has(a)||(r.add(a),e.push(f.slice(l,t.index+t[0].length),`! >>>>>>>> ${a}`,s.fetchText(a),`! <<<<<<<< ${a}`),l=c.lastIndex)}e.push(0===l?f:f.slice(l))}}return e};let i=[this.fetchText(e)];for(;i=c(await Promise.all(i)),!i.every((t=>"string"==typeof t)););return{url:e,content:1===i.length?i[0]:i.map((t=>t.trim())).filter((t=>""!==t)).join("\n")+"\n"}};let i,a=Object.create(null);const u=function(){return void 0===i&&(i=µBlock.cacheStorage.get("assetSourceRegistry").then((t=>t instanceof Object&&t.assetSourceRegistry instanceof Object?(a=t.assetSourceRegistry,a):s.fetchText(µBlock.assetsBootstrapLocation||"assets/assets.json").then((t=>""!==t.content?t:s.fetchText("assets/assets.json"))).then((t=>(h(t.content,!0),a)))))),i},f=function(e,n){const s=a[e]||{};for(const t in n)!1!==n.hasOwnProperty(t)&&(void 0===n[t]?delete s[t]:s[t]=n[t]);let o=n.contentURL;if(void 0!==o){"string"==typeof o?o=s.contentURL=[o]:!1===Array.isArray(o)&&(o=s.contentURL=[]);let e=0;for(let n=0;n<o.length;n++)t.test(o[n])&&(e+=1);s.hasLocalURL=e!==o.length,s.hasRemoteURL=0!==e}else void 0===s.contentURL&&(s.contentURL=[]);"number"!=typeof s.updateAfter&&(s.updateAfter=5),s.submitter&&(s.submitTime=Date.now()),a[e]=s},l=function(t){w(t),delete a[t]},d=(()=>{let t;const e=function(){t=void 0,µBlock.cacheStorage.set({assetSourceRegistry:a})};return function(n){void 0!==t&&clearTimeout(t),n?t=vAPI.setTimeout(e,500):e()}})(),h=function(t,e){let n;try{n=JSON.parse(t)}catch(t){}if(n instanceof Object==0)return;const s=a;for(const t in s)void 0===n[t]&&void 0===s[t].submitter&&l(t);for(const t in n)void 0!==s[t]||e||c("builtin-asset-source-added",{assetKey:t,entry:n[t]}),f(t,n[t]);d()};s.registerAssetSource=async function(t,e){await u(),f(t,e),d(!0)},s.unregisterAssetSource=async function(t){await u(),l(t),d(!0)};const y=Date.now();let g,p={};const m=function(){return void 0===g&&(g=µBlock.cacheStorage.get("assetCacheRegistry").then((t=>(t instanceof Object&&t.assetCacheRegistry instanceof Object&&(0===Object.keys(p).length?p=t.assetCacheRegistry:(console.error("getAssetCacheRegistry(): assetCacheRegistry reassigned!"),Object.keys(t.assetCacheRegistry).sort().join()!==Object.keys(p).sort().join()&&console.error("getAssetCacheRegistry(): assetCacheRegistry changes overwritten!"))),p)))),g},v=(()=>{let t;const e=function(){t=void 0,µBlock.cacheStorage.set({assetCacheRegistry:p})};return function(n){void 0!==t&&clearTimeout(t),n?t=vAPI.setTimeout(e,3e4):e()}})(),R=async function(t,e){let n="",s={};if("string"==typeof e?n=e:e instanceof Object&&(n=e.content||"",s=e),""===n)return w(t);const o=await m();let r=o[t];void 0===r&&(r=o[t]={}),r.writeTime=r.readTime=Date.now(),"string"==typeof s.url&&(r.remoteURL=s.url),µBlock.cacheStorage.set({assetCacheRegistry:p,[`cache/${t}`]:n});const i={assetKey:t,content:n};return!0!==s.silent&&c("after-asset-updated",i),i},w=async function(t){const e=await m(),n=[],s=[];for(const o in e)t instanceof RegExp&&!t.test(o)||"string"==typeof t&&o!==t||(n.push(o),s.push("cache/"+o),delete e[o]);0!==s.length&&await Promise.all([µBlock.cacheStorage.remove(s),µBlock.cacheStorage.set({assetCacheRegistry:p})]);for(let t=0;t<n.length;t++)c("after-asset-updated",{assetKey:n[t]})},L=function(t){return"string"==typeof t&&""!==t};s.get=async function(e,n={}){if(e===µBlock.userFiltersPath)return async function(t){const e=await vAPI.storage.get(t),n=e instanceof Object&&"string"==typeof e[t]?e[t]:"";return vAPI.storage.remove("assets/user/filters.txt"),{assetKey:t,content:n}}(e);let o={};const r=(s,r="",c)=>{const i={assetKey:e,content:s};return void 0!==c?i.error=o.lastError=c:o.lastError=void 0,n.needSourceURL&&(""===r&&p instanceof Object&&p[e]instanceof Object&&(i.sourceURL=p[e].remoteURL),t.test(r)&&(i.sourceURL=r)),i},c=!1===/^(?:compiled|selfie)\//.test(e),i=await async function(t,e=!1){const n=`cache/${t}`,s=function(e){e instanceof Blob&&(e="");const n={assetKey:t,content:e};return""===e&&(n.error="ENOTFOUND"),n},[,o]=await Promise.all([m(),µBlock.cacheStorage.get(n)]);if(o instanceof Object==0||!1===o.hasOwnProperty(n))return s("");const r=p[t];return void 0===r?s(""):(r.readTime=Date.now(),e&&v(!0),s(o[n]))}(e,c);if(""!==i.content)return r(i.content);const a=await u();o=a[e]||{};let f=[];"string"==typeof o.contentURL?f=[o.contentURL]:Array.isArray(o.contentURL)?f=o.contentURL.slice(0):t.test(e)&&(o.content="filters",f=[e]);for(const c of f){if(t.test(c)&&o.hasLocalURL)continue;const i="filters"===o.content?await s.fetchFilterList(c):await s.fetchText(c);if(""!==i.content)return t.test(c)&&!0!==n.dontCache&&R(e,{content:i.content,url:c,silent:!0===n.silent}),r(i.content,c)}return r("","","ENOTFOUND")},s.put=async function(t,n){return e.test(t)?await function(t,e){return vAPI.storage.set({[t]:e}).then((()=>({assetKey:t,content:e})))}(t,n):await R(t,n)},s.metadata=async function(){await Promise.all([u(),m()]);const t=JSON.parse(JSON.stringify(a)),e=p,n=Date.now();for(const s in t){const o=t[s],r=e[s];if(r){o.cached=!0,o.writeTime=r.writeTime;const t=r.writeTime+864e5*o.updateAfter;o.obsolete=t<n,o.remoteURL=r.remoteURL}else o.contentURL&&0!==o.contentURL.length&&(o.writeTime=0,o.obsolete=!0)}return t},s.purge=async function(t,e){const n=await m();let s=!1;for(const o in n){if(t instanceof RegExp){if(!1===t.test(o))continue}else if("string"==typeof t){if(o!==t)continue}else if(Array.isArray(t)&&-1===t.indexOf(o))continue;if(e instanceof RegExp){if(e.test(o))continue}else if("string"==typeof e){if(o===e)continue}else if(Array.isArray(e)&&-1!==e.indexOf(o))continue;n[o].writeTime&&(n[o].writeTime=0,s=!0)}s&&µBlock.cacheStorage.set({assetCacheRegistry:p})},s.remove=function(t){return w(t)},s.rmrf=function(){return w(/./)};const T=12e4,O=[],U=new Set;let A,b,x=T,S=!1;const j=async function(){const[e,n]=await Promise.all([u(),m()]),r=Date.now(),i=[];for(const t in e){const s=e[t];if(!0!==s.hasRemoteURL)continue;if(U.has(t))continue;const o=n[t];o instanceof Object&&o.writeTime+864e5*s.updateAfter>r||(!0!==c("before-asset-updated",{assetKey:t,type:s.content})?o&&o.readTime<y&&w(t):i.push(t))}if(0===i.length)return k();i.sort(((t,e)=>(void 0!==n[t]?n[t].writeTime:0)-(void 0!==n[e]?n[e].writeTime:0))),U.add(i[0]),o=S;const a=await async function(e){const n=(await u())[e]||{},r=function(t,s){const o={assetKey:e,content:t};return s?o.error=n.lastError=s:n.lastError=void 0,o};let c=[];if("string"==typeof n.contentURL?c=[n.contentURL]:Array.isArray(n.contentURL)&&(c=n.contentURL.slice(0)),o&&Array.isArray(n.cdnURLs)){const t=n.cdnURLs.slice();for(let e=0,n=t.length;e<n;e++){const s=Math.floor(Math.random()*n);s!==e&&([t[s],t[e]]=[t[e],t[s]])}c.unshift(...t)}for(const o of c){if(!1===t.test(o))continue;const c="filters"===n.content?await s.fetchFilterList(o):await s.fetchText(o);if(!1!==L(c.content))return R(e,{content:c.content,url:o}),f(e,{error:void 0}),r(c.content);{let t=c.statusText;0===c.statusCode&&(t="network error"),f(e,{error:{time:Date.now(),error:t}})}}return r("","ENOTFOUND")}(i[0]);o=!1,""!==a.content?(O.push(a.assetKey),"assets.json"===a.assetKey&&h(a.content)):c("asset-update-failed",{assetKey:a.assetKey}),vAPI.setTimeout(j,x)},k=function(){const t=O.slice(0);U.clear(),O.length=0,A=void 0,x=T,c("after-assets-updated",{assetKeys:t})};return s.updateStart=function(t){const e=x,n="number"==typeof t.delay?t.delay:T;x=Math.min(e,n),S=!0===t.auto,void 0===A?(A="updating",U.clear(),O.length=0,c("before-assets-updated"),j()):n<e&&(clearTimeout(b),b=vAPI.setTimeout(j,x))},s.updateStop=function(){b&&(clearTimeout(b),b=void 0),void 0!==A&&k()},s.isUpdating=function(){return"updating"===A&&x<=µBlock.hiddenSettings.manualUpdateAssetFetchPeriod},s})();