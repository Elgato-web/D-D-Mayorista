"use strict";(()=>{if(self.WorkerGlobalScope instanceof Object&&self instanceof self.WorkerGlobalScope){const e=/^#block-start-(\d+)\n/gm;let t=Object.create(null);const i=function(t,i,s){e.lastIndex=0;const n=[];let r=e.exec(t);for(;null!==r;){const o=r.index+r[0].length,a=parseInt(r[1],10);if(a>=i&&a<s){const i=t.indexOf("#block-end-"+r[1],o);n.push(t.slice(o,i)),e.lastIndex=i}r=e.exec(t)}return n.join("\n")},s=function(e){const s=[],n=e.compiledFilter;for(const e in t){const r=t[e];if(void 0===r)continue;const o=i(r.content,100,101);let a=0;for(;a=o.indexOf(n,a),-1!==a;){const t=0!==a&&10!==o.charCodeAt(a-1);if(a+=n.length,!(t||a!==o.length&&10!==o.charCodeAt(a))){s.push({assetKey:e,title:r.title,supportURL:r.supportURL});break}}}const r={};r[e.rawFilter]=s,self.postMessage({id:e.id,response:r})},n=function(e){const s=/^#@?#\^?/.exec(e.rawFilter)[0],n="@"===s.charAt(1),r=e.rawFilter.slice(s.length),o=s.endsWith("^"),a=e.hostname,c=r.match(/\w+|\*/g).reduce((function(e,t){return e.length>t.length?e:t})),l=(e,t,i)=>new RegExp(e+t.split(".").reduce(((e,t)=>`(${e}\\.)?${t}`))+i),f=l("^",a,"$");let u;{const t=e.domain,i=t.indexOf(".");-1!==i&&(u=l("^(",a.slice(0,i+a.length-t.length),"\\.)?\\*$"))}const p=e=>""===e||f.test(e)||void 0!==u&&u.test(e),d=Object.create(null);for(const a in t){const l=t[a];if(void 0===l)continue;let f,u,g=i(l.content,200,1e3),k=0;for(;-1!==(k=g.indexOf(c,k));){let t=g.lastIndexOf("\n",k);-1===t&&(t=0);let i=g.indexOf("\n",k);-1===i&&(i=g.length),k=i;const c=JSON.parse(g.slice(t,i)),h=c[0];if(!(h>=0&&h<=5&&e.ignoreGeneric)&&64===h===o){switch(h){case 0:if(n)break;if(c[1]!==r.slice(1))break;if("#"!==r.charAt(0))break;u=s+r;break;case 2:if(n)break;if(c[1]!==r.slice(1))break;if("."!==r.charAt(0))break;u=s+r;break;case 1:case 3:if(n)break;if(c[2]!==r)break;u=s+r;break;case 4:case 5:if(n)break;if(c[1]!==r)break;u=s+r;break;case 8:case 64:if(n!==(0!=(1&c[2])))break;if(f=0!=(2&c[2]),!1===f&&c[3]!==r||f&&JSON.parse(c[3]).raw!==r)break;if(!1===p(c[1]))break;if(8===h&&!1===n&&e.ignoreSpecific)break;u=c[1]+s+r;break;case 32:if(n!==(0!=(1&c[2])))break;if(c[3]!==r)break;p(c[1])&&(u=c[1]+s+r)}if(void 0!==u){void 0===d[u]&&(d[u]=[]),d[u].push({assetKey:a,title:l.title,supportURL:l.supportURL});break}}}}self.postMessage({id:e.id,response:d})};self.onmessage=function(e){const i=e.data;switch(i.what){case"resetLists":t=Object.create(null);break;case"setList":t[i.details.assetKey]=i.details;break;case"fromNetFilter":s(i);break;case"fromCosmeticFilter":n(i)}}}else{if("object"!=typeof µBlock)return;const e=3e5,t=new Map;let i,s=null,n=!0,r=1;const o=function(e){const i=e.data,s=t.get(i.id);t.delete(i.id),s(i.response)},a=function(){if(void 0!==i&&(clearTimeout(i),i=void 0),null!==s){s.terminate(),s=null,n=!0;for(const e of t.values())e();t.clear()}},c=function(){if(null===s&&(s=new Worker("js/reverselookup.js"),s.onmessage=o),void 0!==i&&clearTimeout(i),i=vAPI.setTimeout(a,e),!1===n)return Promise.resolve();n=!1;const t=new Map,r=function(e){const i=t.get(e.assetKey);s.postMessage({what:"setList",details:{assetKey:e.assetKey,title:i.title||e.assetKey,supportURL:i.supportURL,content:e.content}})},c=µBlock;for(const e in c.availableFilterLists){if(!1===c.availableFilterLists.hasOwnProperty(e))continue;const i=c.availableFilterLists[e];!0!==i.off&&t.set(e,{title:e!==c.userFiltersPath?i.title:vAPI.i18n("1pPageName"),supportURL:i.supportURL||""})}if(0===t.size)return Promise.resolve();const l=[];for(const e of t.keys())l.push(c.getCompiledFilterList(e).then((e=>{r(e)})));return Promise.all(l)},l=async function(e){if("string"!=typeof e||""===e)return;const i=µBlock,n=new i.CompiledLineIO.Writer,o=new vAPI.StaticFilteringParser;if(o.setMaxTokenLength(i.staticNetFilteringEngine.MAX_TOKEN_LENGTH),o.analyze(e),!1===i.staticNetFilteringEngine.compile(o,n))return;await c();const a=r++;return s.postMessage({what:"fromNetFilter",id:a,compiledFilter:n.last(),rawFilter:e}),new Promise((e=>{t.set(a,e)}))},f=async function(e){if("string"!=typeof e.rawFilter||""===e.rawFilter)return;await c();const i=r++,n=µBlock.URI.hostnameFromURI(e.url);return s.postMessage({what:"fromCosmeticFilter",id:i,domain:µBlock.URI.domainFromHostname(n),hostname:n,ignoreGeneric:2===µBlock.staticNetFilteringEngine.matchStringReverse("generichide",e.url),ignoreSpecific:2===µBlock.staticNetFilteringEngine.matchStringReverse("specifichide",e.url),rawFilter:e.rawFilter}),new Promise((e=>{t.set(i,e)}))},u=function(){n=!0,null!==s&&s.postMessage({what:"resetLists"})};µBlock.staticFilteringReverseLookup={fromNetFilter:l,fromCosmeticFilter:f,resetLists:u,shutdown:a}}})();