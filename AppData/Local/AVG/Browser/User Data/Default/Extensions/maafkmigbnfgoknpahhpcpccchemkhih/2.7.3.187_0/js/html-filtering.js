"use strict";µBlock.htmlFilteringEngine=function(){const t=µBlock,e=new Map,s=new Set,n=new t.staticExtFilteringEngine.HostnameBasedDB(2),o=new t.staticExtFilteringEngine.SessionDB;let r,i=0,c=0;const l={get acceptedCount(){return i},get discardedCount(){return c}},a=class{constructor(t){this.pselector=new p(t[1])}transpose(t,e){this.pselector.test(t)===this.target&&e.push(t)}get invalid(){return this.pselector.invalid}};a.prototype.target=!0;const f=class extends a{};f.prototype.target=!1;const u=class{constructor(t){const e=t[1];"number"==typeof e?this.i=e:this.s=e}transpose(t,e){if(""!==this.s){const e=t.parentElement;if(null===e)return;if(null===(t=e.closest(this.s)))return}else{let e=this.i;for(;;){if(null===(t=t.parentElement))return;if(e-=1,0===e)break}}e.push(t)}};u.prototype.i=0,u.prototype.s="";const p=class{constructor(t){if(this.raw=t.raw,this.selector=t.selector,this.tasks=[],t.tasks)for(const e of t.tasks){const t=this.operatorToTaskMap.get(e[0]);if(void 0===t){this.invalid=!0;break}const s=new t(e);if(s instanceof a&&s.invalid){this.invalid=!0;break}this.tasks.push(s)}}prime(t){const e=t||r;return""===this.selector?[e]:Array.from(e.querySelectorAll(this.selector))}exec(t){if(this.invalid)return[];let e=this.prime(t);for(const t of this.tasks){if(0===e.length)break;const s=[];for(const n of e)t.transpose(n,s);e=s}return e}test(t){if(this.invalid)return!1;const e=this.prime(t);for(const t of e){let e=[t];for(const t of this.tasks){const s=[];for(const n of e)t.transpose(n,s);if(e=s,0===e.length)break}if(0!==e.length)return!0}return!1}};p.prototype.operatorToTaskMap=new Map([[":has",a],[":has-text",class{constructor(t){let e,s=t[1];Array.isArray(t[1])&&(e=s[1],s=s[0]),this.needle=new RegExp(s,e)}transpose(t,e){this.needle.test(t.textContent)&&e.push(t)}}],[":if",a],[":if-not",f],[":min-text-length",class{constructor(t){this.min=t[1]}transpose(t,e){t.textContent.length>=this.min&&e.push(t)}}],[":not",f],[":nth-ancestor",u],[":spath",class{constructor(t){this.spath=t[1]}transpose(t,e){const s=t.parentElement;if(null===s)return;let n=1;for(;null!==(t=t.previousElementSibling);)n+=1;const o=s.querySelectorAll(`:scope > :nth-child(${n})${this.spath}`);for(const t of o)e.push(t)}}],[":upward",u],[":xpath",class{constructor(t){this.xpe=t[1]}transpose(t,e){const s=r.evaluate(this.xpe,t,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);let n=s.snapshotLength;for(;n--;){const t=s.snapshotItem(n);1===t.nodeType&&e.push(t)}}}]]),p.prototype.invalid=!1;const h=function(t,e,s){µBlock.filteringContext.duplicate().fromTabId(t.tabId).setRealm("cosmetic").setType("dom").setURL(t.url).setDocOriginFromURL(t.url).setFilter({source:"cosmetic",raw:`${0===e?"##":"#@#"}^${s}`}).toLogger()},d=function(s,n){let o=e.get(n);void 0===o&&(o=new p(JSON.parse(n)),e.set(n,o));const r=o.exec();let i=!1;for(const t of r)t.remove(),i=!0;return i&&t.logger.enabled&&h(s,0,o.raw),i},g=function(e,s){const n=r.querySelectorAll(s);let o=!1;for(const t of n)t.remove(),o=!0;return o&&t.logger.enabled&&h(e,0,s),o};return l.reset=function(){n.clear(),e.clear(),s.clear(),i=0,c=0},l.freeze=function(){s.clear(),n.collectGarbage()},l.compile=function(e,s){const{raw:n,compiled:o,exception:r}=e.result;if(void 0!==o){s.select(t.compiledHTMLSection);for(const{hn:t,not:n,bad:i}of e.extOptions()){if(i)continue;let e=0;if(r){if(n)continue;e|=1}123===o.charCodeAt(0)&&(e|=2),s.push([64,t,e,o])}}else{const e=s.properties.get("assetKey")||"?";t.logger.writeOne({realm:"message",type:"error",text:`Invalid HTML filter in ${e}: ##${n}`})}},l.fromCompiledContent=function(e){if(!1!==t.canFilterResponseData)for(e.select(t.compiledHTMLSection);e.next();){i+=1;const t=e.fingerprint();if(s.has(t)){c+=1;continue}s.add(t);const o=e.args();n.store(o[1],o[2],o[3])}},l.getSession=function(){return o},l.retrieve=function(e){const s=e.hostname;if(t.userSettings.advancedUserEnabled&&2===t.sessionFirewall.evaluateCellZY(s,s,"*"))return;const r=new Set,i=new Set,c=new Set;o.isNotEmpty&&o.retrieve([null,c]),n.retrieve(s,[r,c,i,c]);const l=""!==e.entity?`${s.slice(0,-e.domain.length)}${e.entity}`:"*";if(n.retrieve(l,[r,c,i,c],1),0===r.size&&0===i.size)return;const a={plains:r,procedurals:i};if(0===c.size)return a;for(const t of c)r.has(t)?(r.delete(t),h(e,1,t)):i.has(t)&&(i.delete(t),h(e,1,JSON.parse(t).raw));return 0!==r.size||0!==i.size?a:void 0},l.apply=function(t,e){r=t;let s=!1;for(const t of e.selectors.plains)g(e,t)&&(s=!0);for(const t of e.selectors.procedurals)d(e,t)&&(s=!0);return r=void 0,s},l.toSelfie=function(){return n.toSelfie()},l.fromSelfie=function(t){n.fromSelfie(t),e.clear()},l}();