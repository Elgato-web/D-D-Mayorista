"use strict";{const t=µBlock,e=class{constructor(){this.init()}init(){return this.blocked=new Map,this.results=new Map,this.hash=0,this.timer=void 0,this}rememberResult(t,e){if(t.tabId<=0)return;0===this.results.size&&this.pruneAsync();const i=`${t.getDocHostname()} ${t.type} ${t.url}`;if(this.results.set(i,{result:e,redirectURL:t.redirectURL,logData:t.filter,tstamp:Date.now()}),1!==e||void 0!==t.redirectURL)return;const s=Date.now();this.blocked.set(i,s),this.hash=s}rememberBlock(t){if(t.tabId<=0)return;if(0===this.blocked.size&&this.pruneAsync(),void 0!==t.redirectURL)return;const e=Date.now();this.blocked.set(`${t.getDocHostname()} ${t.type} ${t.url}`,e),this.hash=e}forgetResult(t,e,i){const s=`${t} ${e} ${i}`;this.results.delete(s),this.blocked.delete(s)}empty(){this.blocked.clear(),this.results.clear(),this.hash=0,void 0!==this.timer&&(clearTimeout(this.timer),this.timer=void 0)}prune(){const t=Date.now()-this.shelfLife;for(const e of this.blocked)e[1]<=t&&(this.results.delete(e[0]),this.blocked.delete(e[0]));for(const e of this.results)e[1].tstamp<=t&&this.results.delete(e[0]);0===this.blocked.size&&0===this.results.size||this.pruneAsync()}pruneAsync(){void 0===this.timer&&(this.timer=vAPI.setTimeout((()=>{this.timer=void 0,this.prune()}),this.shelfLife))}lookupResult(t){const e=this.results.get(t.getDocHostname()+" "+t.type+" "+t.url);if(void 0!==e){if(void 0!==e.redirectURL&&e.redirectURL.startsWith(this.extensionOriginURL)){const t=new URL(e.redirectURL);t.searchParams.set("secret",vAPI.warSecret()),e.redirectURL=t.href}return e}}lookupAllBlocked(t){const e=[];for(const i of this.blocked){const s=i[0].indexOf(" ");i[0].slice(0,s)===t&&(e[e.length]=i[0].slice(s+1))}return e}static factory(){return new e}};e.prototype.shelfLife=15e3,e.prototype.extensionOriginURL=vAPI.getURL("/");const i=[],s=50,r=class{constructor(t,e){this.init(t,e)}init(t,e){return this.t0=Date.now(),this.parentId=e,this.exceptCname=void 0,this.clickToLoad=!1,this.rawURL=t,void 0!==t&&(this.hostname=vAPI.hostnameFromURI(t),this.domain=vAPI.domainFromHostname(this.hostname)||this.hostname),this}dispose(){return this.rawURL=this.hostname=this.domain="",i.length<s&&i.push(this),null}static factory(t,e=-1){const s=i.pop();return void 0===s?new r(t,e):s.init(t,e)}},o=[],a=10,n=class{constructor(t,i){this.extraData=new Map,this.journal=[],this.journalTimer=void 0,this.journalLastCommitted=this.journalLastUncommitted=-1,this.journalLastUncommittedOrigin=void 0,this.netFilteringCache=e.factory(),this.init(t,i)}static factory(t,e){let i=o.pop();return void 0===i?i=new n(t,e):i.init(t,e),i}init(e,i){const s=t.tabContextManager.mustLookup(e);this.tabId=e,"number"==typeof this.allowLargeMediaElementsUntil&&s.rootHostname===this.tabHostname||(this.allowLargeMediaElementsUntil=Date.now()),this.tabHostname=s.rootHostname,this.title=s.rawURL,this.rawURL=s.rawURL,this.hostnameToCountMap=new Map,this.contentLastModified=0,this.logData=void 0,this.perLoadBlockedRequestCount=0,this.perLoadAllowedRequestCount=0,this.remoteFontCount=0,this.popupBlockedCount=0,this.largeMediaCount=0,this.largeMediaTimer=null,this.allowLargeMediaElementsRegex=void 0,this.extraData.clear(),this.frameAddCount=0,this.frames=new Map,this.setFrameURL({url:s.rawURL});const r=s.getNetFilteringSwitch();return this.noCosmeticFiltering=!0===t.sessionSwitches.evaluateZ("no-cosmetic-filtering",s.rootHostname),r&&this.noCosmeticFiltering&&t.logger.enabled&&"tabCommitted"===i&&t.filteringContext.duplicate().fromTabId(e).setURL(s.rawURL).setRealm("cosmetic").setType("dom").setFilter(t.sessionSwitches.toLogData()).toLogger(),this}reuse(e){const i=t.tabContextManager.mustLookup(this.tabId);return i.rootHostname!==this.tabHostname&&(e=""),"tabUpdated"===e?(this.rawURL=i.rawURL,this.setFrameURL({url:this.rawURL}),this):(null!==this.largeMediaTimer&&(clearTimeout(this.largeMediaTimer),this.largeMediaTimer=null),this.disposeFrameStores(),this.init(this.tabId,e),this)}dispose(){return this.tabHostname="",this.title="",this.rawURL="",this.hostnameToCountMap=null,this.netFilteringCache.empty(),this.allowLargeMediaElementsUntil=Date.now(),this.allowLargeMediaElementsRegex=void 0,null!==this.largeMediaTimer&&(clearTimeout(this.largeMediaTimer),this.largeMediaTimer=null),this.disposeFrameStores(),void 0!==this.journalTimer&&(clearTimeout(this.journalTimer),this.journalTimer=void 0),this.journal=[],this.journalLastUncommittedOrigin=void 0,this.journalLastCommitted=this.journalLastUncommitted=-1,o.length<a&&o.push(this),null}disposeFrameStores(){for(const t of this.frames.values())t.dispose();this.frames.clear()}getFrameStore(t){return this.frames.get(t)||null}setFrameURL(t){let{frameId:e,url:i,parentFrameId:s}=t;void 0===e&&(e=0),void 0===s&&(s=-1);let o=this.frames.get(e);return void 0!==o?(i===o.rawURL?o.parentId=s:o.init(i,s),o):(o=r.factory(i,s),this.frames.set(e,o),this.frameAddCount+=1,0==(63&this.frameAddCount)&&this.pruneFrames(),o)}getEffectiveFrameURL(t){let{frameId:e}=t;for(;;){const t=this.getFrameStore(e);if(null===t)break;if(!1===t.rawURL.startsWith("about:"))return t.rawURL;if(e=t.parentId,-1===e)break}return t.frameURL}async pruneFrames(){let t;try{t=await webext.webNavigation.getAllFrames({tabId:this.tabId})}catch(t){}if(!1===Array.isArray(t))return;const e=new Set;for(const{frameId:i}of t)e.add(i);const i=Date.now()-6e4;for(const[t,{t0:s}]of this.frames)e.has(t)||s>=i||this.frames.delete(t)}getNetFilteringSwitch(){return t.tabContextManager.mustLookup(this.tabId).getNetFilteringSwitch()}getSpecificCosmeticFilteringSwitch(){return!0!==this.noCosmeticFiltering}toggleNetFilteringSwitch(e,i,s){t.toggleNetFilteringSwitch(e,i,s),this.netFilteringCache.empty()}injectLargeMediaElementScriptlet(){vAPI.tabs.executeScript(this.tabId,{file:"/js/scriptlets/load-large-media-interactive.js",allFrames:!0,runAt:"document_idle"}),t.contextMenu.update(this.tabId)}temporarilyAllowLargeMediaElements(e){this.largeMediaCount=0,t.contextMenu.update(this.tabId),e?(this.allowLargeMediaElementsUntil=0,this.allowLargeMediaElementsRegex=void 0):this.allowLargeMediaElementsUntil=Date.now(),t.scriptlets.injectDeep(this.tabId,"load-large-media-all")}journalAddRequest(e,i){""!==e&&(this.journal.push(e,1===i?1:65536),void 0===this.journalTimer&&(this.journalTimer=vAPI.setTimeout((()=>{this.journalProcess(!0)}),t.hiddenSettings.requestJournalProcessPeriod)))}journalAddRootFrame(e,i){if("committed"===e)this.journalLastCommitted=this.journal.length,-1!==this.journalLastUncommitted&&this.journalLastUncommitted<this.journalLastCommitted&&this.journalLastUncommittedOrigin===vAPI.hostnameFromURI(i)&&(this.journalLastCommitted=this.journalLastUncommitted);else if("uncommitted"===e){const t=vAPI.hostnameFromURI(i);-1!==this.journalLastUncommitted&&this.journalLastUncommittedOrigin===t||(this.journalLastUncommitted=this.journal.length,this.journalLastUncommittedOrigin=t)}void 0!==this.journalTimer&&clearTimeout(this.journalTimer),this.journalTimer=vAPI.setTimeout((()=>{this.journalProcess(!0)}),t.hiddenSettings.requestJournalProcessPeriod)}journalProcess(e=!1){!1===e&&clearTimeout(this.journalTimer),this.journalTimer=void 0;const i=this.journal,s=Math.max(0,this.journalLastCommitted),r=Date.now();let o=0;for(let t=s;t<i.length;t+=2){const e=i[t];let s=this.hostnameToCountMap.get(e);void 0===s&&(s=0,this.contentLastModified=r);let a=i[t+1];this.hostnameToCountMap.set(e,s+a),o+=a}this.perLoadBlockedRequestCount+=65535&o,this.perLoadAllowedRequestCount+=o>>>16&65535,this.journalLastUncommitted=this.journalLastCommitted=-1,65535&o&&t.userSettings.showIconBadge&&t.updateToolbarIcon(this.tabId,2);for(let t=0;t<s;t+=2)o+=i[t+1];0!==o&&(t.localSettings.blockedRequestCount+=65535&o,t.localSettings.allowedRequestCount+=o>>>16&65535,t.localSettingsLastModified=r,µBlock.saveLocalSettings()),i.length=0}filterRequest(e){if(e.filter=void 0,e.redirectURL=void 0,!1===this.getNetFilteringSwitch(e))return 0;if(e.itype===e.CSP_REPORT&&1===this.filterCSPReport(e))return 1;if(0!=(e.itype&e.FONT_ANY)&&1===this.filterFont(e))return 1;if(e.itype===e.SCRIPT&&1===this.filterScripting(e,!0))return 1;const i=this.cacheableResults.has(e.itype)&&void 0===e.aliasURL;if(i){const t=this.netFilteringCache.lookupResult(e);if(void 0!==t)return e.redirectURL=t.redirectURL,e.filter=t.logData,t.result}const s=e.type,r=t.logger.enabled;let o=t.sessionURLFiltering.evaluateZ(e.getTabHostname(),e.url,s);0!==o&&r&&(e.filter=t.sessionURLFiltering.toLogData()),0===o&&t.userSettings.advancedUserEnabled&&(o=t.sessionFirewall.evaluateCellZY(e.getTabHostname(),e.getHostname(),s),0!==o&&3!==o&&r&&(e.filter=t.sessionFirewall.toLogData()));const a=t.staticNetFilteringEngine;if((0===o||3===o)&&(o=a.matchString(e),0!==o&&(r&&e.setFilter(a.toLogData()),1===o&&void 0!==e.aliasURL&&!1===a.isBlockImportant()&&this.shouldExceptCname(e))))return 2;if(1===o&&-1!==e.frameId){const t=this.getFrameStore(e.frameId);null!==t&&t.clickToLoad&&(o=2,r&&e.pushFilter({result:o,source:"network",raw:"click-to-load"}))}return 0==(e.itype&e.INLINE_ANY)&&(1===o?this.redirectBlockedRequest(e):a.hasQuery(e)&&this.redirectNonBlockedRequest(e)),i?this.netFilteringCache.rememberResult(e,o):1===o&&this.collapsibleResources.has(e.itype)&&this.netFilteringCache.rememberBlock(e),o}filterOnHeaders(e,i){if(e.filter=void 0,!1===this.getNetFilteringSwitch(e))return 0;let s=t.staticNetFilteringEngine.matchHeaders(e,i);if(0===s)return 0;const r=t.logger.enabled;return r&&(e.filter=t.staticNetFilteringEngine.toLogData()),1===s&&2===t.sessionURLFiltering.evaluateZ(e.getTabHostname(),e.url,e.type)&&(s=2,r&&(e.filter=t.sessionURLFiltering.toLogData())),1===s&&t.userSettings.advancedUserEnabled&&2===t.sessionFirewall.evaluateCellZY(e.getTabHostname(),e.getHostname(),e.type)&&(s=2,r&&(e.filter=t.sessionFirewall.toLogData())),s}redirectBlockedRequest(e){if(!0===t.hiddenSettings.ignoreRedirectFilters)return;const i=t.staticNetFilteringEngine.redirectRequest(e);void 0!==i&&!0===t.logger.enabled&&(e.pushFilters(i.map((t=>t.logData()))),void 0!==e.redirectURL&&e.pushFilter({source:"redirect",raw:t.redirectEngine.resourceNameRegister}))}redirectNonBlockedRequest(e){const i=t.staticNetFilteringEngine.filterQuery(e);void 0!==i&&!0===t.logger.enabled&&(e.pushFilters(i.map((t=>t.logData()))),void 0!==e.redirectURL&&e.pushFilter({source:"redirect",raw:e.redirectURL}))}filterCSPReport(e){return t.sessionSwitches.evaluateZ("no-csp-reports",e.getHostname())?(t.logger.enabled&&(e.filter=t.sessionSwitches.toLogData()),1):0}filterFont(e){return e.itype===e.FONT&&(this.remoteFontCount+=1),!1!==t.sessionSwitches.evaluateZ("no-remote-fonts",e.getTabHostname())?(t.logger.enabled&&(e.filter=t.sessionSwitches.toLogData()),1):0}filterScripting(e,i){return e.filter=void 0,void 0===i&&(i=this.getNetFilteringSwitch(e)),!1===i||!1===t.sessionSwitches.evaluateZ("no-scripting",e.getTabHostname())?0:(t.logger.enabled&&(e.filter=t.sessionSwitches.toLogData()),1)}filterLargeMediaElement(e,i){if(e.filter=void 0,0===this.allowLargeMediaElementsUntil)return 0;if(this.allowLargeMediaElementsRegex instanceof RegExp&&this.allowLargeMediaElementsRegex.test(e.url))return 0;if(Date.now()<this.allowLargeMediaElementsUntil){const i=this.allowLargeMediaElementsRegex instanceof RegExp?[this.allowLargeMediaElementsRegex.source]:[];return i.push("^"+t.escapeRegex(e.url)),this.allowLargeMediaElementsRegex=new RegExp(i.join("|")),0}return!0!==t.sessionSwitches.evaluateZ("no-large-media",e.getTabHostname())?(this.allowLargeMediaElementsUntil=0,0):i>>>10<t.userSettings.largeMediaSize?0:(this.largeMediaCount+=1,null===this.largeMediaTimer&&(this.largeMediaTimer=vAPI.setTimeout((()=>{this.largeMediaTimer=null,this.injectLargeMediaElementScriptlet()}),500)),t.logger.enabled&&(e.filter=t.sessionSwitches.toLogData()),1)}clickToLoad(t,e){let i=this.getFrameStore(t);null===i&&(i=this.setFrameURL({frameId:t,url:e})),this.netFilteringCache.forgetResult(this.tabHostname,"sub_frame",e),i.clickToLoad=!0}shouldExceptCname(e){let i,s;return void 0!==e.docId&&(s=this.getFrameStore(e.docId),s instanceof Object&&(i=s.exceptCname)),void 0===i&&(i=2===t.staticNetFilteringEngine.matchStringReverse("cname",s instanceof Object?s.rawURL:e.getDocOrigin())&&t.staticNetFilteringEngine.toLogData(),s instanceof Object&&(s.exceptCname=i)),!1!==i&&(i instanceof Object&&e.setFilter(i),!0)}getBlockedResources(e,i){const s=t.normalizePageURL(this.tabId,e.frameURL),r=e.resources,o=t.filteringContext;if(o.fromTabId(this.tabId).setDocOriginFromURL(s),Array.isArray(r)&&0!==r.length)for(const t of r)this.filterRequest(o.setType(t.type).setURL(t.url));this.netFilteringCache.hash!==i.hash&&(i.hash=this.netFilteringCache.hash,i.blockedResources=this.netFilteringCache.lookupAllBlocked(o.getDocHostname()))}};n.prototype.cacheableResults=new Set([t.FilteringContext.SUB_FRAME]),n.prototype.collapsibleResources=new Set([t.FilteringContext.IMAGE,t.FilteringContext.MEDIA,t.FilteringContext.OBJECT,t.FilteringContext.SUB_FRAME]),t.PageStore=n}