"use strict";(()=>{const e=vAPI.i18n("3pLastUpdate"),t=/^[a-z-]+:\/\/(?:\S+\/\S*|\/\S+)/m;let s={},o="",n=new Set(["*"]);const r=vAPI.messaging;vAPI.broadcastListener.add((e=>{switch(e.what){case"assetUpdated":a(e);break;case"assetsUpdated":document.body.classList.remove("updating"),i();break;case"staticFilteringDataChanged":c()}}));const l=function(e){return e.toLocaleString()},c=function(t){const n=uDom("#templates .groupEntry"),c=uDom("#templates .listEntry"),a=vAPI.i18n("3pListsOfBlockedHostsPerListStats"),d=vAPI.i18n.renderElapsedTimeToString,m=new Map([["user",""]]),y=function(o,n,r){const i=s.available[o];n||(n=c.clone().nodeAt(0));const u=!0!==i.off;let m;n.classList.toggle("checked",u),n.getAttribute("data-listkey")!==o&&(n.setAttribute("data-listkey",o),m=n.querySelector('input[type="checkbox"]'),m.checked=u,m=n.querySelector(".listname"),m.textContent=function(e){const t=s.current[e]||s.available[e],o=t?t.title:"";return""===o?e:o}(o),m=n.querySelector("a.content"),m.setAttribute("href","asset-viewer.html?url="+encodeURIComponent(o)),m.setAttribute("type","text/html"),n.classList.remove("toRemove"),i.supportName?(n.classList.add("support"),m=n.querySelector("a.support"),m.setAttribute("href",i.supportURL),m.setAttribute("title",i.supportName)):n.classList.remove("support"),i.external?n.classList.add("external"):n.classList.remove("external"),i.instructionURL?(n.classList.add("mustread"),m=n.querySelector("a.mustread"),m.setAttribute("href",i.instructionURL)):n.classList.remove("mustread"),n.classList.toggle("unused",r&&!u)),t||(n.querySelector('input[type="checkbox"]').checked=u),m=n.querySelector("span.counts");let p="";isNaN(+i.entryUsedCount)||isNaN(+i.entryCount)||(p=a.replace("{{used}}",l(u?i.entryUsedCount:0)).replace("{{total}}",l(i.entryCount))),m.textContent=p;const y=s.cache[o]||{},g=y.remoteURL;return n.classList.toggle("unsecure","string"==typeof g&&0===g.lastIndexOf("http:",0)),n.classList.toggle("failed",void 0!==y.error),n.classList.toggle("obsolete",!0===y.obsolete),!0===y.cached?(n.classList.add("cached"),n.querySelector(".status.cache").setAttribute("title",e.replace("{{ago}}",d(y.writeTime)))):n.classList.remove("cached"),n.classList.remove("discard"),n},g=function(e,t){let o=document.querySelector(`#lists > .groupEntry[data-groupkey="${e}"]`);if(null===o){o=n.clone().nodeAt(0);let t=m.get(e);void 0===t&&(t=vAPI.i18n("3pGroup"+e.charAt(0).toUpperCase()+e.slice(1)),m.set(e,t)),""!==t&&(o.querySelector(".geName").textContent=t)}null===o.querySelector(".geName:empty")&&(o.querySelector(".geCount").textContent=function(e){if(!1===Array.isArray(e))return"";let t=0,o=0;for(const n of e)!0!==s.available[n].off&&(t+=1),o+=1;return 0!==o?`(${t.toLocaleString()}/${o.toLocaleString()})`:""}(t));let r=p(e);o.classList.toggle("hideUnused",r);let l=o.querySelector(".listEntries");if(!t)return o;t.sort((function(e,t){return(s.available[e].title||"").localeCompare(s.available[t].title||"")}));for(let e=0;e<t.length;e++){let s=y(t[e],l.children[e],r);null===s.parentElement&&l.appendChild(s)}return o};r.send("dashboard",{what:"getLists"}).then((e=>{!function(e){s=e,s.available["user-filters"].group="user",uDom("#lists .listEntries .listEntry[data-listkey]").addClass("discard");const n=uDom(".listEntry.toImport").detach(),r=document.querySelector("#lists"),c=function(e){let t=new Map,s=Object.keys(e);for(let o of s){let s=e[o].group||"nogroup";"social"===s&&(s="annoyances");let n=t.get(s);void 0===n&&t.set(s,n=[]),n.push(o)}return t}(e.available),a=["user","default","ads","privacy","malware","annoyances","multipurpose","regions","custom"];document.body.classList.toggle("hideUnused",p("*"));for(let e=0;e<a.length;e++){let t=a[e],s=g(t,c.get(t));s.setAttribute("data-groupkey",t),null===s.parentElement&&r.appendChild(s),c.delete(t)}for(const e of Object.keys(c))r.appendChild(g(e,e));uDom("#lists .listEntries .listEntry.discard").remove(),uDom('[data-groupkey="custom"] .listEntries').append(n),uDom.nodeFromId("autoUpdate").checked=!0===s.autoUpdate,uDom.nodeFromId("listsOfBlockedHostsPrompt").textContent=vAPI.i18n("3pListsOfBlockedHostsPrompt").replace("{{netFilterCount}}",l(e.netFilterCount)).replace("{{cosmeticFilterCount}}",l(e.cosmeticFilterCount)),uDom.nodeFromId("parseCosmeticFilters").checked=!0===s.parseCosmeticFilters,uDom.nodeFromId("ignoreGenericCosmeticFilters").checked=!0===s.ignoreGenericCosmeticFilters,t||(o=u()),document.body.classList.toggle("updating",s.isUpdating),i()}(e)}))},i=function(){let e=uDom.nodeFromId("buttonApply").classList;e.toggle("disabled",o===u());const t=document.body.classList.contains("updating");e=uDom.nodeFromId("buttonUpdate").classList,e.toggle("active",t),e.toggle("disabled",!1===t&&null===document.querySelector('#lists .listEntry.obsolete:not(.toRemove) input[type="checkbox"]:checked')),e=uDom.nodeFromId("buttonPurgeAll").classList,e.toggle("disabled",t||null===document.querySelector("#lists .listEntry.cached:not(.obsolete)"))},a=function(t){const s=document.querySelector('#lists .listEntry[data-listkey="'+t.key+'"]');null!==s&&(s.classList.toggle("failed",!!t.failed),s.classList.toggle("obsolete",!t.cached),s.classList.toggle("cached",!!t.cached),t.cached&&s.querySelector(".status.cache").setAttribute("title",e.replace("{{ago}}",vAPI.i18n.renderElapsedTimeToString(Date.now()))),i())},u=function(){const e=[uDom.nodeFromId("parseCosmeticFilters").checked,uDom.nodeFromId("ignoreGenericCosmeticFilters").checked],s=[],o=document.querySelectorAll("#lists .listEntry[data-listkey]:not(.toRemove)");for(const e of o)null!==e.querySelector('input[type="checkbox"]:checked')&&s.push(e.getAttribute("data-listkey"));return e.push(s.sort().join(),uDom.nodeFromId("importLists").checked&&t.test(uDom.nodeFromId("externalLists").value),null!==document.querySelector("#lists .listEntry.toRemove")),e.join()},d=function(){i()},m=async function(){r.send("dashboard",{what:"userSettings",name:"parseAllABPHideFilters",value:uDom.nodeFromId("parseCosmeticFilters").checked}),r.send("dashboard",{what:"userSettings",name:"ignoreGenericCosmeticFilters",value:uDom.nodeFromId("ignoreGenericCosmeticFilters").checked});const e=[];for(const t of document.querySelectorAll("#lists .listEntry[data-listkey]:not(.toRemove)"))null!==t.querySelector('input[type="checkbox"]:checked')&&e.push(t.getAttribute("data-listkey"));const t=[];for(const e of document.querySelectorAll("#lists .listEntry.toRemove[data-listkey]"))t.push(e.getAttribute("data-listkey"));const s=document.getElementById("externalLists"),n=s.value.trim();{const e=s.closest(".listEntry");e.classList.remove("checked"),e.querySelector('input[type="checkbox"]').checked=!1,s.value=""}await r.send("dashboard",{what:"applyFilterListSelection",toSelect:e,toImport:n,toRemove:t}),o=u()},p=function(e){const t=n.has("*");return"*"===e?t:n.has(e)!==t},y=function(e){const t=n.has("*");let s,o;if("*"===e)o=!1===t,s="",n.clear(),o&&n.add(e),document.body.classList.toggle("hideUnused",o),uDom(".groupEntry[data-groupkey]").toggleClass("hideUnused",o);else{const r=n.has(e);r?n.delete(e):n.add(e),o=r===t,s='.groupEntry[data-groupkey="'+e+'"] ',uDom(s).toggleClass("hideUnused",o)}uDom(s+'.listEntry input[type="checkbox"]:not(:checked)').ancestors(".listEntry[data-listkey]").toggleClass("unused",o),vAPI.localStorage.setItem("hideUnusedFilterLists",Array.from(n))};uDom("#listsOfBlockedHostsPrompt").on("click",(function(){y("*")})),uDom("#lists").on("click",".groupEntry[data-groupkey] > .geDetails",(function(e){y(uDom(e.target).ancestors(".groupEntry[data-groupkey]").attr("data-groupkey"))})),vAPI.localStorage.getItemAsync("hideUnusedFilterLists").then((e=>{Array.isArray(e)&&(n=new Set(e))})),self.cloud.onPush=function(){const e={parseCosmeticFilters:uDom.nodeFromId("parseCosmeticFilters").checked,ignoreGenericCosmeticFilters:uDom.nodeFromId("ignoreGenericCosmeticFilters").checked,selectedLists:[]},t=document.querySelectorAll("#lists .listEntry");for(const s of t)s.querySelector("input").checked&&e.selectedLists.push(s.getAttribute("data-listkey"));return e},self.cloud.onPull=function(e,o){if("object"!=typeof e||null===e)return;let n,r;n=uDom.nodeFromId("parseCosmeticFilters"),r=!0===e.parseCosmeticFilters||o&&n.checked,n.checked=s.parseCosmeticFilters=r,n=uDom.nodeFromId("ignoreGenericCosmeticFilters"),r=!0===e.ignoreGenericCosmeticFilters||o&&n.checked,n.checked=s.ignoreGenericCosmeticFilters=r;const l=new Set(e.selectedLists),c=uDom("#lists .listEntry");for(let e=0,t=c.length;e<t;e++){const t=c.at(e),s=t.attr("data-listkey"),n=l.has(s);l.delete(s);const r=t.descendants("input").first();o&&r.prop("checked")||r.prop("checked",n)}for(const e of l)!1===t.test(e)&&l.delete(e);0!==l.size&&(n=uDom.nodeFromId("externalLists"),o?""!==n.value.trim()&&(n.value+="\n"):n.value="",n.value+=Array.from(l).join("\n"),uDom.nodeFromId("importLists").checked=!0),uDom('#lists .listEntry.unused input[type="checkbox"]:checked').ancestors(".listEntry[data-listkey]").removeClass("unused"),i()},self.hasUnsavedData=function(){return u()!==o},uDom("#autoUpdate").on("change",(function(){r.send("dashboard",{what:"userSettings",name:"autoUpdate",value:this.checked})})),uDom("#parseCosmeticFilters").on("change",d),uDom("#ignoreGenericCosmeticFilters").on("change",d),uDom("#buttonApply").on("click",(()=>{!async function(){uDom("#buttonApply").removeClass("enabled"),await m(),i(),r.send("dashboard",{what:"reloadAllFilters"})}()})),uDom("#buttonUpdate").on("click",(()=>{!async function(){await m(),document.body.classList.add("updating"),i(),r.send("dashboard",{what:"forceUpdateAssets"})}()})),uDom("#buttonPurgeAll").on("click",(e=>{!async function(e){uDom("#buttonPurgeAll").removeClass("enabled"),await r.send("dashboard",{what:"purgeAllCaches",hard:e}),c(!0)}(e.ctrlKey&&e.shiftKey)})),uDom("#lists").on("change",".listEntry input",(function(e){const t=e.target;t.closest(".listEntry").classList.toggle("checked",t.checked),d()})),uDom("#lists").on("click",".listEntry .remove",(function(e){const t=e.target.closest("[data-listkey]");null!==t&&(t.classList.toggle("toRemove"),i())})),uDom("#lists").on("click","span.cache",(function(e){const t=e.target.closest("[data-listkey]"),s=t.getAttribute("data-listkey")||"";""!==s&&(r.send("dashboard",{what:"purgeCache",assetKey:s}),t.classList.add("obsolete"),t.classList.remove("cached"),t.querySelector('input[type="checkbox"]').checked&&i())})),uDom("#externalLists").on("input",d),uDom("#lists").on("click",".listEntry label *",(e=>{e.target.matches("a,input,.forinput")||e.preventDefault()})),c()})();