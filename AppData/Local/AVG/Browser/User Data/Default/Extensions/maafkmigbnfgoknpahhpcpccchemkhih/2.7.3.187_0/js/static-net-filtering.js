"use strict";µBlock.staticNetFilteringEngine=(()=>{const t=µBlock,e={no_type:0,stylesheet:32,image:64,object:96,object_subrequest:96,script:128,fetch:160,xmlhttprequest:160,sub_frame:192,font:224,media:256,websocket:288,beacon:320,ping:320,other:352,popup:384,popunder:416,main_frame:448,generichide:480,specifichide:512,"inline-font":544,"inline-script":576,cname:608,webrtc:704,unsupported:736},i=e.other,s=t=>1<<(e[t]>>>5)-1,n=(1<<(i>>>5))-1,r=n|1<<(e.popup>>>5)-1|1<<(e.main_frame>>>5)-1|1<<(e["inline-font"]>>>5)-1|1<<(e["inline-script"]>>>5)-1,o=1<<(e.unsupported>>>5)-1,a=["","stylesheet","image","object","script","xmlhttprequest","subdocument","font","media","websocket","ping","other","popup","popunder","document","generichide","specifichide","inline-font","inline-script","cname","webrtc","unsupported"];let h="",c="",l="",u="",p="",d=0,f=0,m=0;const g={entity:void 0,compute(){if(void 0===this.entity){const t=p.indexOf(".");this.entity=-1!==t?u.slice(0,t-p.length):""}return this.entity},reset(){this.entity=void 0}},T={init(t){this.headers=t,this.parsed.clear()},reset(){this.headers=[],this.parsed.clear()},lookup(t){if(0===this.parsed.size)for(let t=0,e=this.headers.length;t<e;t++){const{name:e,value:i}=this.headers[t];this.parsed.set(e,i)}return this.parsed.get(t)},headers:[],parsed:new Map},k="(?:[^%.0-9a-z_-]|$)",y=/[.*+?^${}()|[\]\\]/g,O=t=>t.replace(y,"\\$&"),C=function(t,e=0){let i=t.replace(C.rePlainChars,"\\$&").replace(C.reSeparators,k).replace(C.reDanglingAsterisks,"").replace(C.reAsterisks,"\\S*?");return 4&e?i=(i.startsWith("\\.")?C.restrHostnameAnchor2:C.restrHostnameAnchor1)+i:2&e&&(i="^"+i),1&e&&(i+="$"),i};C.rePlainChars=/[.+?${}()|[\]\\]/g,C.reSeparators=/\^/g,C.reDanglingAsterisks=/^\*+|\*+$/g,C.reAsterisks=/\*+/g,C.restrHostnameAnchor1="^[a-z-]+://(?:[^/?#]+\\.)?",C.restrHostnameAnchor2="^[a-z-]+://(?:[^/?#]+)?";const w=function(t,e,i){if(0===i)return;const s=[],n=[],r=[],o={pattern:[],regex:[],denyallow:n,domains:r,options:s,isRegex:!1};P[i].logData(o),0!=(2&t)&&o.options.unshift("important"),0!=(16&t)?o.options.unshift("3p"):0!=(8&t)&&o.options.unshift("1p");const h=992&t;0!==h&&o.options.unshift(a[h>>>5]);let c=o.pattern.join("");return!1===o.isRegex&&47===c.charCodeAt(0)&&47===c.charCodeAt(c.length-1)&&(c+="*"),0!=(1&t)&&(c="@@"+c),0!==n.length&&s.push(`denyallow=${n.join("|")}`),0!==r.length&&s.push(`domain=${r.join("|")}`),0!==s.length&&(c+="$"+s.join(",")),{raw:c,regex:o.regex.join("")}},S=new Uint32Array(128);{const t=/[^\w%.-]/;for(let e=0;e<128;e++)t.test(String.fromCharCode(e))&&(S[e]|=1)}const v=t=>0!=(1&S[t]),P=JSON.parse(`[${"null,".repeat(65535)}null]`);let b=1;const H=b,A=function(t){const e=b;return b+=1,b>P.length&&x(b),P[e]=t,e},x=function(t){if(t<=P.length)return;const e=t+4095&-4096;for(let t=P.length;t<e;t++)P[t]=null},F=JSON.parse(`[${"0,".repeat(163839)}0]`);let B=3;const $=B,I=function(t,e){const i=B;return B+=2,B>F.length&&R(B),F[i+0]=t,F[i+1]=e,i},R=function(t){if(t<=F.length)return;const e=t+16383&-16384;for(let t=F.length;t<e;t++)F[t]=0},D=new t.BidiTrieContainer((function(t,e,i){for(;;){f=t,m=e;const s=F[i+0];if(P[s].match())return s;if(0===(i=F[i+1]))break}return 0})),z=function(t=!1){vAPI.localStorage.setItem("SNFE.bidiTrie",D.optimize(t))},_=[],U=new Map;let E=0;const M=function(t){const e=E++;t.fid=t.prototype.fid=e,t.fidstr=`${e}`,_[e]=t},L=(t,...e)=>A(new t(...e)),N=t=>A(t),W=function(t){const e=_[t[0]],i=e.keyFromArgs;if(void 0===i)return A(e.fromCompiled(t));let s=e.fidstr;const n=i(t);void 0!==n&&(s+=`\t${n}`);let r=U.get(s);return void 0!==r||(r=A(e.fromCompiled(t)),U.set(s,r)),r},j={compile:function(t,e){if(t.isRegex)return void e.push(rt.compile(t));const i=t.pattern;if("*"===i)return void e.push(q.compile());if(t.tokenHash===t.noTokenHash)return void e.push(Z.compile(t));if(-1===t.firstWildcardPos&&-1===t.firstCaretPos)return void e.push(Q.compile(t));if(-1!==t.secondWildcardPos||-1!==t.secondCaretPos||-1!==t.firstCaretPos&&(-1===t.firstWildcardPos||t.firstWildcardPos!==t.firstCaretPos+1))return this.compileGeneric(t,e);const s=-1!==t.firstCaretPos,n=i.slice(t.firstWildcardPos+1),r=i.slice(0,s?t.firstCaretPos:t.firstWildcardPos);if(t.tokenBeg<t.firstWildcardPos)return t.pattern=r,e.push(Q.compile(t)),t.pattern=n,void e.push(Y.compile(t,s));t.pattern=n,t.tokenBeg-=t.firstWildcardPos+1,e.push(Q.compile(t)),t.pattern=r,e.push(J.compile(t,s))},compileGeneric:function(t,e){const i=t.pattern;if(-1===t.firstWildcardPos&&t.firstCaretPos===i.length-1)return t.pattern=i.slice(0,-1),e.push(Q.compile(t)),void e.push(nt.compile());e.push(Z.compile(t))}},q=class{match(){return!0}logData(t){t.pattern.push("*"),t.regex.push("^")}toSelfie(){return q.compile()}static compile(){return[q.fid]}static fromCompiled(){return new q}static fromSelfie(){return new q}static keyFromArgs(){}};M(q);const Q=class{constructor(t,e){this.i=0|t,this.n=0|e}match(){const t=d;return 0!==D.startsWith(t,D.haystackLen,this.i,this.n)&&(f=t,m=t+this.n,!0)}get isBidiTrieable(){return this.n<=255}toBidiTrie(){return{i:this.i,n:this.n,itok:this.tokenBeg}}logData(t){const e=D.extractString(this.i,this.n);t.pattern.push(e),t.regex.push(O(e))}toSelfie(){return[this.fid,this.i,this.n,this.tokenBeg]}static compile(t){return[Q.fid,t.pattern,t.tokenBeg]}static fromCompiled(t){const e=D.storeString(t[1]),i=t[1].length;return 0===t[2]?new Q(e,i):1===t[2]?new V(e,i):new K(e,i,t[2])}static fromSelfie(t){return 0===t[3]?new Q(t[1],t[2]):1===t[3]?new V(t[1],t[2]):new K(t[1],t[2],t[3])}};Q.prototype.tokenBeg=0,M(Q);const V=class extends Q{match(){const t=d-1;return 0!==D.startsWith(t,D.haystackLen,this.i,this.n)&&(f=t,m=t+this.n,!0)}};V.prototype.tokenBeg=1;const K=class extends Q{constructor(t,e,i){super(t,e),this.tokenBeg=i}match(){const t=d-this.tokenBeg;return 0!==D.startsWith(t,D.haystackLen,this.i,this.n)&&(f=t,m=t+this.n,!0)}},J=class{constructor(t,e){this.i=0|t,this.n=0|e}match(){const t=D.indexOf(0,f,this.i,this.n);return-1!==t&&(f=t,!0)}logData(t){if(t.pattern.unshift("*"),0===this.n)return;const e=D.extractString(this.i,this.n);t.pattern.unshift(e),t.regex.unshift(O(e),".*")}toSelfie(){return[this.fid,this.i,this.n]}static compile(t,e){return[e?G.fid:J.fid,t.pattern]}static fromCompiled(t){const e=D.storeString(t[1]);return new J(e,t[1].length)}static fromSelfie(t){return new J(t[1],t[2])}};M(J);const G=class extends J{match(){let t=0;for(;;){if(t=D.indexOf(t,f-1,this.i,this.n),-1===t)return!1;if(v(D.haystack[t+this.n]))break;t+=1}return f=t,!0}logData(t){const e=D.extractString(this.i,this.n);t.pattern.unshift(e,"^*"),t.regex.unshift(O(e),k,".*")}static fromCompiled(t){const e=D.storeString(t[1]);return new G(e,t[1].length)}static fromSelfie(t){return new G(t[1],t[2])}};M(G);const Y=class{constructor(t,e){this.i=0|t,this.n=0|e}match(){const t=D.lastIndexOf(m,D.haystackLen,this.i,this.n);return-1!==t&&(m=t+this.n,!0)}logData(t){const e=D.extractString(this.i,this.n);t.pattern.push("*",e),t.regex.push(".*",O(e))}toSelfie(){return[this.fid,this.i,this.n]}static compile(t,e){return[e?X.fid:Y.fid,t.pattern]}static fromCompiled(t){const e=D.storeString(t[1]);return new Y(e,t[1].length)}static fromSelfie(t){return new Y(t[1],t[2])}};M(Y);const X=class extends Y{match(){const t=m,e=D.lastIndexOf(t+1,D.haystackLen,this.i,this.n);return-1!==e&&!1!==v(D.haystack[t])&&(m=e+this.n,!0)}logData(t){const e=D.extractString(this.i,this.n);t.pattern.push("^*",e),t.regex.push(k,".*",O(e))}static fromCompiled(t){const e=D.storeString(t[1]);return new X(e,t[1].length)}static fromSelfie(t){return new X(t[1],t[2])}};M(X);const Z=class{constructor(t,e){this.s=t,0!==e&&(this.anchor=e)}match(){return null===this.re&&(this.re=new RegExp(C(this.s,this.anchor))),this.re.test(h)}logData(t){t.pattern.length=0,0!=(4&this.anchor)?t.pattern.push("||"):0!=(2&this.anchor)&&t.pattern.push("|"),t.pattern.push(this.s),0!=(1&this.anchor)&&t.pattern.push("|"),t.regex.length=0,t.regex.push(C(this.s,-5&this.anchor))}toSelfie(){return[this.fid,this.s,this.anchor]}static compile(t){const e=[Z.fid,t.pattern,t.anchor];return t.anchor=0,e}static fromCompiled(t){return new Z(t[1],t[2])}static fromSelfie(t){return new Z(t[1],t[2])}static keyFromArgs(t){return`${t[1]}\t${t[2]}`}};Z.prototype.re=null,Z.prototype.anchor=0,Z.isSlow=!0,M(Z);const tt=class{constructor(){this.lastLen=0,this.lastBeg=-1,this.lastEnd=-1}match(){const t=l.length,e=D.haystack;t===this.lastLen&&-1!==this.lastBeg&&58===e[this.lastBeg-3]&&47===e[this.lastBeg-2]&&47===e[this.lastBeg-1]||(this.lastBeg=0!==t?e.indexOf(58):-1,-1!==this.lastBeg&&(this.lastBeg>=D.haystackLen||47!==e[this.lastBeg+1]||47!==e[this.lastBeg+2])&&(this.lastBeg=-1),-1!==this.lastBeg?(this.lastBeg+=3,this.lastEnd=this.lastBeg+t):this.lastEnd=-1,this.lastLen=t);const i=f;return i<this.lastEnd&&(i===this.lastBeg||i>this.lastBeg&&46===e[i-1])}logData(t){t.pattern.unshift("||")}toSelfie(){return[this.fid]}static compile(){return[tt.fid]}static fromCompiled(){return new tt}static fromSelfie(){return new tt}static keyFromArgs(){}};M(tt);const et=class extends tt{match(){return super.match()&&this.lastEnd===m}logData(t){super.logData(t),t.pattern.push("^"),t.regex.push("\\.?",k)}toSelfie(){return[this.fid]}static compile(){return[et.fid]}static fromCompiled(){return new et}static fromSelfie(){return new et}static keyFromArgs(){}};M(et);const it=class{match(){return 0===f}logData(t){t.pattern.unshift("|"),t.regex.unshift("^")}toSelfie(){return[this.fid]}static compile(){return[it.fid]}static fromCompiled(){return new it}static fromSelfie(){return new it}static keyFromArgs(){}};M(it);const st=class{match(){return m===h.length}logData(t){t.pattern.push("|"),t.regex.push("$")}toSelfie(){return[this.fid]}static compile(){return[st.fid]}static fromCompiled(){return new st}static fromSelfie(){return new st}static keyFromArgs(){}};M(st);const nt=class{match(){return m===h.length||!!v(D.haystack[m])&&(m+=1,!0)}logData(t){t.pattern.push("^"),t.regex.push(k)}toSelfie(){return[this.fid]}static compile(){return[nt.fid]}static fromCompiled(){return new nt}static fromSelfie(){return new nt}static keyFromArgs(){}};M(nt);const rt=class{constructor(t,e=!1){this.s=t,e&&(this.matchCase=!0)}match(){return null===this.re&&(this.re=new RegExp(this.s,this.matchCase?"":"i")),!1!==this.re.test(c)&&(f=c.search(this.re),!0)}logData(t){t.pattern.push("/",this.s,"/"),t.regex.push(this.s),t.isRegex=!0,this.matchCase&&t.options.push("match-case")}toSelfie(){return[this.fid,this.s,this.matchCase]}static compile(t){return[rt.fid,t.pattern,t.patternMatchCase]}static fromCompiled(t){return new rt(t[1],t[2])}static fromSelfie(t){return new rt(t[1],t[2])}static keyFromArgs(t){return`${t[1]}\t${t[2]}`}};rt.prototype.re=null,rt.prototype.matchCase=!1,rt.isSlow=!0,M(rt);const ot=new class{constructor(t){this.reset(t)}reset(t){return this.domainOpt=t,this.i=0,this.value=void 0,this.done=!1,this}next(){if(-1===this.i)return this.domainOpt="",this.value=void 0,this.done=!0,this;const t=this.domainOpt.indexOf("|",this.i);return-1!==t?(this.value=this.domainOpt.slice(this.i,t),this.i=t+1):(this.value=this.domainOpt.slice(this.i),this.i=-1),this}[Symbol.iterator](){return this}}(""),at=new class{constructor(){this.trieContainer=new t.HNTrieContainer}compile(t,e,i){const s=[],n=[],r=[],o=[];for(const e of t){const t=e.length,i=t>1&&126===e.charCodeAt(0)?1:0,a=t>2&&42===e.charCodeAt(t-1)&&46===e.charCodeAt(t-2)?t-2:t;a<=i||(a===t?0===i?s.push(e):n.push(e.slice(1)):0===i?r.push(e.slice(0,-2)):o.push(e.slice(1,-2)))}const a=[];if(0!==r.length)for(const t of r)a.push(pt.compile(t));1===s.length?a.push(ht.compile(s[0])):s.length>1&&a.push(lt.compile(s.join("|"))),a.length>1&&(a[0]=kt.compile(a.slice()),a.length=1);const h=[];if(0!==o.length)for(const t of o)h.push(dt.compile(t));1===n.length?h.push(ct.compile(n[0])):n.length>1&&h.push(ut.compile(n.join("|"))),e?(0!==a.length&&i.unshift(a[0]),0!==h.length&&i.unshift(...h)):(0!==h.length&&i.push(...h),0!==a.length&&i.push(a[0]))}prime(){this.trieContainer.reset(vAPI.localStorage.getItem("SNFE.filterOrigin.trieDetails"))}reset(){this.trieContainer.reset()}optimize(){vAPI.localStorage.setItem("SNFE.filterOrigin.trieDetails",this.trieContainer.optimize())}toSelfie(){}fromSelfie(){}},ht=class{constructor(t,e){this.i=t,this.n=e}get domainOpt(){return at.trieContainer.extractHostname(this.i,this.n)}match(){return at.trieContainer.matchesHostname(u,this.i,this.n)}toSelfie(){return[this.fid,this.i,this.n]}logData(t){t.domains.push(this.domainOpt)}static compile(t){return[ht.fid,t]}static fromCompiled(t){return new ht(at.trieContainer.storeHostname(t[1]),t[1].length)}static fromSelfie(t){return new ht(t[1],t[2])}};ht.prototype.hasOriginHit=!0,M(ht);const ct=class extends ht{match(){return!1===super.match()}logData(t){t.domains.push(`~${this.domainOpt}`)}static compile(t){return[ct.fid,t]}static fromCompiled(t){return new ct(at.trieContainer.storeHostname(t[1]),t[1].length)}static fromSelfie(t){return new ct(t[1],t[2])}};ct.prototype.hasOriginHit=!1,M(ct);const lt=class{constructor(t,e=null){this.domainOpt=t,this.oneOf=null!==e?at.trieContainer.createOne(e):null}match(){return null===this.oneOf&&(this.oneOf=at.trieContainer.fromIterable(ot.reset(this.domainOpt))),-1!==this.oneOf.matches(u)}logData(t){t.domains.push(this.domainOpt)}toSelfie(){return[this.fid,this.domainOpt,null!==this.oneOf?at.trieContainer.compileOne(this.oneOf):null]}static compile(t){return[lt.fid,t]}static fromCompiled(t){return new lt(t[1])}static fromSelfie(t){return new lt(t[1],t[2])}static keyFromArgs(t){return t[1]}};lt.prototype.hasOriginHit=!0,M(lt);const ut=class extends lt{match(){return!1===super.match()}logData(t){t.domains.push("~"+this.domainOpt.replace(/\|/g,"|~"))}static compile(t){return[ut.fid,t]}static fromCompiled(t){return new ut(t[1])}static fromSelfie(t){return new ut(t[1],t[2])}static keyFromArgs(t){return t[1]}};ut.prototype.hasOriginHit=!1,M(ut);const pt=class{constructor(t){this.entity=t}get domainOpt(){return`${this.entity}.*`}match(){const t=g.compute();if(""===t)return!1;const e=t.length-this.entity.length;return!(e<0||t.charCodeAt(e)!==this.entity.charCodeAt(0)||!1===t.endsWith(this.entity)||0!==e&&46!==t.charCodeAt(e-1))}toSelfie(){return[this.fid,this.entity]}logData(t){t.domains.push(this.domainOpt)}static compile(t){return[pt.fid,t]}static fromCompiled(t){return new pt(t[1])}static fromSelfie(t){return new pt(t[1])}};pt.prototype.hasOriginHit=!0,M(pt);const dt=class extends pt{match(){return!1===super.match()}logData(t){t.domains.push(`~${this.entity}.*`)}static compile(t){return[dt.fid,t]}static fromCompiled(t){return new dt(t[1])}static fromSelfie(t){return new dt(t[1])}};dt.prototype.hasOriginHit=!1,M(dt);const ft=class extends lt{constructor(t,e,i=null){super(t,i),this.hasEntity=void 0===e?-1!==t.indexOf(".*"):e}match(){return null===this.oneOf&&(this.oneOf=at.trieContainer.fromIterable(ot.reset(this.domainOpt)),this.domainOpt=""),-1!==this.oneOf.matches(u)||!1!==this.hasEntity&&-1!==this.oneOf.matches(`${g.compute()}.*`)}toSelfie(){return[this.fid,this.domainOpt,this.hasEntity,null!==this.oneOf?at.trieContainer.compileOne(this.oneOf):null]}static fromSelfie(t){return new ft(t[1],t[2],t[3])}};M(ft);const mt=class{constructor(t,e,i){this.actionBits=t,this.type=e,this.value=i,this.cache=void 0}match(){return!0}matchAndFetchModifiers(t){this.type===t.modifier&&t.results.push(new gt(t.bits,t.th,t.iunit))}get modifier(){return this}logData(t){let e=vAPI.StaticFilteringParser.netOptionTokenNames.get(this.type);""!==this.value&&(e+=`=${this.value}`),t.options.push(e)}toSelfie(){return[this.fid,this.actionBits,this.type,this.value]}static compile(t){return[mt.fid,t.action,t.modifyType,t.modifyValue||""]}static fromCompiled(t){return new mt(t[1],t[2],t[3])}static fromSelfie(t){return new mt(t[1],t[2],t[3])}static keyFromArgs(t){return`${t[1]}\t${t[2]}\t${t[3]}`}};M(mt);const gt=class{constructor(t,e,i){this.iunit=i,this.th=e,this.bits=-8&t|this.modifier.actionBits}get filter(){return P[this.iunit]}get modifier(){return this.filter.modifier}get result(){return 0==(1&this.bits)?1:2}get value(){return this.modifier.value}logData(){const t=w(this.bits,this.th,this.iunit);return t.source="static",t.result=this.result,t.modifier=!0,t}},Tt=class{constructor(t=0){this.i=t}get size(){let t=0;return this.forEach((()=>{t+=1})),t}unshift(t){this.i=I(t,this.i)}shift(t=!1){t&&(P[F[this.i+0]]=null),this.i=F[this.i+1]}forEach(t){let e=this.i;if(0!==e)do{const i=t(F[e+0]);if(void 0!==i)return i;e=F[e+1]}while(0!==e)}logData(t){this.forEach((e=>{P[e].logData(t)}))}toSelfie(){return[this.fid,this.i]}static compile(t,e){return[t.fid,e]}static fromCompiled(t,e){const i=t[1];let s,n=0,r=i.length;for(;r--;)s=W(i[r]),n=I(s,n);return e.i=n,e}static fromSelfie(t,e){return e.i=t[1],e}},kt=class extends Tt{get domainOpt(){const t=[];return this.forEach((e=>{const i=P[e];!0===i.hasOriginHit&&t.push(i.domainOpt)})),t.join("|")}match(){let t=this.i;for(;0!==t;){if(P[F[t+0]].match())return!0;t=F[t+1]}return!1}static compile(t){return super.compile(kt,t)}static fromCompiled(t){return super.fromCompiled(t,new kt)}static fromSelfie(t,e){return void 0===e&&(e=new kt),super.fromSelfie(t,e)}};kt.prototype.hasOriginHit=!0,M(kt);const yt=class extends Tt{match(){let t=this.i;for(;0!==t;){if(!0!==P[F[t+0]].match())return!1;t=F[t+1]}return!0}matchAndFetchModifiers(t){const e=P[F[this.i]];e.matchAndFetchModifiers instanceof Function&&e.type===t.modifier&&this.match()&&e.matchAndFetchModifiers(t)}get modifier(){const t=P[F[this.i]];if(t.matchAndFetchModifiers instanceof Function)return t.modifier}get isBidiTrieable(){return!0===P[F[this.i]].isBidiTrieable}get hasOriginHit(){return this.forEach((t=>{if(!0===P[t].hasOriginHit)return!0}))}get domainOpt(){return this.forEach((t=>{const e=P[t];if(!0===e.hasOriginHit)return e.domainOpt}))}toBidiTrie(){const t=P[F[this.i]].toBidiTrie();return this.shift(!0),t}static compile(t){return super.compile(yt,t)}static fromCompiled(t){return super.fromCompiled(t,new yt)}static fromSelfie(t,e){return void 0===e&&(e=new yt),super.fromSelfie(t,e)}};M(yt);const Ot=class{constructor(t){this.$h="",this.dict=Ot.trieContainer.createOne(t)}get size(){return this.dict.size}add(t){return this.dict.add(t)}match(){const t=this.dict.matches(l);return-1!==t&&(this.$h=l.slice(t),!0)}logData(t){t.pattern.push("||",this.$h,"^"),t.regex.push(O(this.$h),"\\.?",k)}toSelfie(){return[this.fid,Ot.trieContainer.compileOne(this.dict)]}static prime(){return Ot.trieContainer.reset(vAPI.localStorage.getItem("SNFE.FilterHostnameDict.trieDetails"))}static reset(){return Ot.trieContainer.reset()}static optimize(){vAPI.localStorage.setItem("SNFE.FilterHostnameDict.trieDetails",Ot.trieContainer.optimize())}static fromSelfie(t){return new Ot(t[1])}};Ot.trieContainer=new t.HNTrieContainer,M(Ot);const Ct=class{constructor(t,e){this.s=t,this.hndict=Ot.trieContainer.createOne(e)}match(){return-1===this.hndict.matches(l)}logData(t){t.denyallow.push(this.s)}toSelfie(){return[this.fid,this.s,Ot.trieContainer.compileOne(this.hndict)]}static compile(t){return[Ct.fid,t.denyallowOpt]}static fromCompiled(t){const e=new Ct(t[1]);for(const i of ot.reset(t[1]))""!==i&&e.hndict.add(i);return e}static fromSelfie(t){return new Ct(...t.slice(1))}static keyFromArgs(t){return t[1]}};M(Ct);const wt=class{constructor(t){this.$h="",this.dict=at.trieContainer.createOne(t)}get size(){return this.dict.size}add(t){return this.dict.add(t)}match(){const t=this.dict.matches(u);return-1!==t&&(this.$h=u.slice(t),!0)}logData(t){t.pattern.push("*"),t.regex.push("^"),t.domains.push(this.$h)}toSelfie(){return[this.fid,at.trieContainer.compileOne(this.dict)]}static fromCompiled(t){return new wt(t[1])}static fromSelfie(t){return new wt(t[1])}};M(wt);const St=class extends wt{match(){return h.startsWith("https://")&&super.match()}logData(t){t.pattern.push("|https://"),t.regex.push("^https://"),t.domains.push(this.$h)}static fromCompiled(t){return new St(t[1])}static fromSelfie(t){return new St(t[1])}};M(St);const vt=class extends wt{match(){return h.startsWith("http://")&&super.match()}logData(t){t.pattern.push("|http://"),t.regex.push("^http://"),t.domains.push(this.$h)}static fromCompiled(t){return new vt(t[1])}static fromSelfie(t){return new vt(t[1])}};M(vt);const Pt=class{constructor(t){this.plainTrie=void 0!==t?t:D.createOne(),this.$matchedUnit=0}match(){return 0!==this.plainTrie.matches(d)&&(this.$matchedUnit=this.plainTrie.$iu,!0)}matchAndFetchModifiers(){}logData(t){const e=h.slice(this.plainTrie.$l,this.plainTrie.$r);t.pattern.push(e),t.regex.push(O(e)),-1!==this.$matchedUnit&&P[this.$matchedUnit].logData(t)}addUnitToTrie(t){const e=P[t],i=e.toBidiTrie(),s=this.plainTrie.add(i.i,i.n,i.itok),n=this.plainTrie.getExtra(s);if(1!==n){if(e instanceof Q)return this.plainTrie.setExtra(s,1),void(P[t]=null);1===e.n&&(P[t]=null,t=F[e.i]),this.plainTrie.setExtra(s,I(t,n))}else P[t]=null}toSelfie(){return[this.fid,D.compileOne(this.plainTrie)]}static fromSelfie(t){return new Pt(D.createOne(t[1]))}};M(Pt);const bt=class extends Tt{constructor(t=0){super(),this.n=t,this.$matchedUnit=0}get size(){return this.n}match(){let t=this.i;for(;0!==t;){if(P[F[t+0]].match())return this.$matchedUnit=F[t+0],!0;t=F[t+1]}return!1}matchAndFetchModifiers(t){let e=this.i;for(;0!==e;)t.iunit=F[e+0],P[t.iunit].matchAndFetchModifiers(t),e=F[e+1]}unshift(t){super.unshift(t),this.n+=1}shift(){super.shift(),this.n-=1}logData(t){P[this.$matchedUnit].logData(t)}toSelfie(){return[this.fid,this.n,super.toSelfie()]}static fromSelfie(t,e){return void 0===e&&(e=new bt(t[1])),super.fromSelfie(t[2],e)}optimize(t=3){if(this.n>=3&&0!=(1&t)){const t=this.optimizePatternTests();if(void 0!==t){if(0===this.i)return t;this.unshift(N(t))}}if(this.n>=10&&0!=(2&t)){const t=this.optimizeOriginHitTests();if(void 0!==t){if(0===this.i)return t;this.unshift(N(t))}}}optimizePatternTests(){let t=0,e=this.i;do{P[F[e+0]].isBidiTrieable&&(t+=1),e=F[e+1]}while(0!==e&&t<3);if(t<3)return;const i=new Pt;e=this.i;let s=0;for(;;){const t=F[e+0],n=F[e+1];if(P[t].isBidiTrieable?(i.addUnitToTrie(t),0!==s?F[s+1]=n:this.i=n,this.n-=1):s=e,0===n)break;e=n}return i}optimizeOriginHitTests(){let t=0;if(!0!==this.forEach((e=>{if(!0===P[e].hasOriginHit)return t+=1,t>=10||void 0})))return;const e=new Ht,i=[];let s=this.i,n=0;for(;;){const t=F[s+0],r=F[s+1],o=P[t];if(!0===o.hasOriginHit?(i.push(o.domainOpt),F[s+1]=e.i,e.i=s,e.n+=1,0!==n?F[n+1]=r:this.i=r,this.n-=1):n=s,0===r)break;s=r}return e.originTestUnit=L(ft,i.join("|")),e}};M(bt);const Ht=class extends bt{constructor(t=0){super(),this.originTestUnit=t}match(){return P[this.originTestUnit].match()&&super.match()}matchAndFetchModifiers(t){P[this.originTestUnit].match()&&super.matchAndFetchModifiers(t)}toSelfie(){return[this.fid,this.originTestUnit,super.toSelfie()]}static fromSelfie(t){const e=new Ht(t[1]);return super.fromSelfie(t[2],e)}};M(Ht);const At=class{constructor(t){this.not=t}match(){return l===u!==this.not}logData(t){t.options.push(this.not?"strict3p":"strict1p")}toSelfie(){return[this.fid,this.not]}static compile(t){return[At.fid,t.strictParty<0]}static fromCompiled(t){return new At(t[1])}static fromSelfie(t){return new At(t[1])}static keyFromArgs(t){return`${t[1]}`}};M(At);const xt=class{constructor(t){this.headerOpt=t,this.parsed=void 0}match(){void 0===this.parsed&&(this.parsed=vAPI.StaticFilteringParser.parseHeaderValue(this.headerOpt));const{bad:t,name:e,not:i,re:s,value:n}=this.parsed;if(t)return!1;const r=T.lookup(e);return void 0!==r&&(""===n||(void 0===s?r===n!==i:s.test(r)!==i))}logData(t){let e="header";""!==this.headerOpt&&(e+=`=${this.headerOpt}`),t.options.push(e)}toSelfie(){return[this.fid,this.headerOpt]}static compile(t){return[xt.fid,t.headerOpt]}static fromCompiled(t){return new xt(t[1])}static fromSelfie(t){return new xt(t[1])}};M(xt);const Ft=new class{constructor(){this._chars="0123456789%abcdefghijklmnopqrstuvwxyz",this._validTokenChars=new Uint8Array(128);for(let t=0,e=this._chars.length;t<e;t++)this._validTokenChars[this._chars.charCodeAt(t)]=t+1;this.dotTokenHash=268435456,this.anyTokenHash=536870912,this.anyHTTPSTokenHash=805306368,this.anyHTTPTokenHash=1073741824,this.noTokenHash=1342177280,this.emptyTokenHash=4026531840,this._urlIn="",this._urlOut="",this._tokenized=!1,this._hasQuery=0,this._tokens=new Uint32Array(2064),this.knownTokens=new Uint8Array(65536),this.resetKnownTokens(),this.MAX_TOKEN_LENGTH=7}setURL(t){return t!==this._urlIn&&(this._urlIn=t,this._urlOut=t.toLowerCase(),this._hasQuery=0,this._tokenized=!1),this._urlOut}resetKnownTokens(){this.knownTokens.fill(0),this.addKnownToken(this.dotTokenHash),this.addKnownToken(this.anyTokenHash),this.addKnownToken(this.anyHTTPSTokenHash),this.addKnownToken(this.anyHTTPTokenHash),this.addKnownToken(this.noTokenHash)}addKnownToken(t){this.knownTokens[65535&t^t>>>16]=1}getTokens(t){if(this._tokenized)return this._tokens;let e=this._tokenize(t);return this._tokens[e+0]=this.anyTokenHash,this._tokens[e+1]=0,e+=2,this._urlOut.startsWith("https://")?(this._tokens[e+0]=this.anyHTTPSTokenHash,this._tokens[e+1]=0,e+=2):this._urlOut.startsWith("http://")&&(this._tokens[e+0]=this.anyHTTPTokenHash,this._tokens[e+1]=0,e+=2),this._tokens[e+0]=this.noTokenHash,this._tokens[e+1]=0,this._tokens[e+2]=0,this._tokenized=!0,this._tokens}hasQuery(){if(0===this._hasQuery){const t=this._urlOut.indexOf("?");this._hasQuery=-1!==t?t+1:-1}return this._hasQuery>0}tokenHashFromString(t){const e=t.length;if(0===e)return this.emptyTokenHash;const i=this._validTokenChars;let s=i[t.charCodeAt(0)];for(let n=1;7!==n&&n!==e;n++)s=s<<4^i[t.charCodeAt(n)];return s}stringFromTokenHash(t){return 0===t?"":t.toString(16)}toSelfie(){return µBlock.base64.encode(this.knownTokens.buffer,this.knownTokens.byteLength)}fromSelfie(t){return µBlock.base64.decode(t,this.knownTokens.buffer)}_tokenize(t){const e=this._tokens;let i=this._urlOut,s=i.length;if(0===s)return 0;s>2048&&(i=i.slice(0,2048),s=2048),t.haystackLen=s;let n=0,r=-1;t:{const o=this.knownTokens,a=this._validTokenChars,h=t.haystack;let c=0,l=0,u=0,p=0;for(;;){for(;;){if(c===s)break t;const t=i.charCodeAt(c);if(h[c]=t,c+=1,p=a[t],0!==p)break;63===t&&(r=c)}for(u=c-1,l=1;c!==s;){const t=i.charCodeAt(c);h[c]=t,c+=1;const e=a[t];if(0===e){63===t&&(r=c);break}7!==l&&(p=p<<4^e,l+=1)}0!==o[65535&p^p>>>16]&&(e[n+0]=p,e[n+1]=u,n+=2)}}return this._hasQuery=r,n}},Bt=class{constructor(t,e){if(void 0!==e)return Object.assign(this,e);this.noTokenHash=Ft.noTokenHash,this.reBadCSP=/(?:=|;)\s*report-(?:to|uri)\b/,this.reToken=/[%0-9A-Za-z]+/g,this.domainOptList=[],this.tokenIdToNormalizedType=new Map([[t.OPTTokenCname,s("cname")],[t.OPTTokenCss,s("stylesheet")],[t.OPTTokenDoc,s("main_frame")],[t.OPTTokenFont,s("font")],[t.OPTTokenFrame,s("sub_frame")],[t.OPTTokenGenericblock,s("unsupported")],[t.OPTTokenGhide,s("generichide")],[t.OPTTokenImage,s("image")],[t.OPTTokenInlineFont,s("inline-font")],[t.OPTTokenInlineScript,s("inline-script")],[t.OPTTokenMedia,s("media")],[t.OPTTokenObject,s("object")],[t.OPTTokenOther,s("other")],[t.OPTTokenPing,s("ping")],[t.OPTTokenPopunder,s("popunder")],[t.OPTTokenPopup,s("popup")],[t.OPTTokenScript,s("script")],[t.OPTTokenShide,s("specifichide")],[t.OPTTokenXhr,s("xmlhttprequest")],[t.OPTTokenWebrtc,s("unsupported")],[t.OPTTokenWebsocket,s("websocket")]]),this.badTokens=new Map([["https",123617],["com",76987],["js",43620],["www",33129],["jpg",32221],["images",31812],["css",19715],["png",19140],["static",15724],["net",15239],["de",13155],["img",11109],["assets",10746],["min",7807],["cdn",7568],["content",6900],["wp",6444],["fonts",6095],["svg",5976],["http",5813],["ssl",5735],["amazon",5440],["ru",5427],["fr",5199],["facebook",5178],["en",5146],["image",5028],["html",4837],["media",4833],["co",4783],["php",3972],["2019",3943],["org",3924],["jquery",3531],["02",3438],["api",3382],["gif",3350],["eu",3322],["prod",3289],["woff2",3200],["logo",3194],["themes",3107],["icon",3048],["google",3026],["v1",3019],["uploads",2963],["googleapis",2860],["v3",2816],["tv",2762],["icons",2748],["core",2601],["gstatic",2581],["ac",2509],["utag",2466],["id",2459],["ver",2448],["rsrc",2387],["files",2361],["uk",2357],["us",2271],["pl",2262],["common",2205],["public",2076],["01",2016],["na",1957],["v2",1954],["12",1914],["thumb",1895],["web",1853],["ui",1841],["default",1825],["main",1737],["false",1715],["2018",1697],["embed",1639],["player",1634],["dist",1599],["woff",1593],["global",1593],["json",1572],["11",1566],["600",1559],["app",1556],["styles",1533],["plugins",1526],["274",1512],["random",1505],["sites",1505],["imasdk",1501],["bridge3",1501],["news",1496],["width",1494],["thumbs",1485],["ttf",1470],["ajax",1463],["user",1454],["scripts",1446],["twitter",1440],["crop",1431],["new",1412]]),this.maxTokenLen=Ft.MAX_TOKEN_LENGTH,this.reset(t)}reset(t){return this.parser=t,this.action=0,this.anchor=0,this.badFilter=!1,this.modifyType=void 0,this.modifyValue=void 0,this.invalid=!1,this.pattern="",this.patternMatchCase=!1,this.party=0,this.optionUnitBits=0,this.domainOpt="",this.denyallowOpt="",this.headerOpt=void 0,this.isPureHostname=!1,this.isRegex=!1,this.strictParty=0,this.token="*",this.tokenHash=this.noTokenHash,this.tokenBeg=0,this.typeBits=0,this.notTypes=0,this.firstWildcardPos=-1,this.secondWildcardPos=-1,this.firstCaretPos=-1,this.secondCaretPos=-1,this.unsupported=!1,this}clone(){return new Bt(this.parser,this)}normalizeRegexSource(t){try{return new RegExp(t).source}catch(t){}return""}parseTypeOption(t,e){const i=-1!==t?this.tokenIdToNormalizedType.get(t):r;e?this.notTypes|=i:this.typeBits|=i}parsePartyOption(t,e){e&&(t=!t),this.party|=t?8:16}parseHostnameList(t,e,i=[]){let s=0,n=t.length,r=0;for(;s<n;){let o=t.indexOf("|",s);-1===o&&(o=n);const a=this.parser.normalizeHostnameValue(t.slice(s,o),e);void 0!==a&&(i[r]=a,r+=1),s=o+1}return i.length=r,1===r?i[0]:i.join("|")}parseModifierOption(t,e){return void 0===this.modifyType&&(this.modifyType=t,void 0!==e?this.modifyValue=e:1===this.action&&(this.modifyValue=""),!0)}parseOptions(){for(let{id:t,val:e,not:i}of this.parser.netOptions())switch(t){case this.parser.OPTToken1p:this.parsePartyOption(!0,i);break;case this.parser.OPTToken1pStrict:this.strictParty=-1===this.strictParty?0:1,this.optionUnitBits|=this.STRICT_PARTY_BIT;break;case this.parser.OPTToken3p:this.parsePartyOption(!1,i);break;case this.parser.OPTToken3pStrict:this.strictParty=1===this.strictParty?0:-1,this.optionUnitBits|=this.STRICT_PARTY_BIT;break;case this.parser.OPTTokenAll:this.parseTypeOption(-1);break;case this.parser.OPTTokenBadfilter:this.badFilter=!0;break;case this.parser.OPTTokenCsp:if(!1===this.parseModifierOption(t,e))return!1;if(void 0!==e&&this.reBadCSP.test(e))return!1;this.optionUnitBits|=this.CSP_BIT;break;case this.parser.OPTTokenDomain:if(this.domainOpt=this.parseHostnameList(e,10,this.domainOptList),""===this.domainOpt)return!1;this.optionUnitBits|=this.DOMAIN_BIT;break;case this.parser.OPTTokenDenyAllow:if(this.denyallowOpt=this.parseHostnameList(e,0),""===this.denyallowOpt)return!1;this.optionUnitBits|=this.DENYALLOW_BIT;break;case this.parser.OPTTokenEhide:this.parseTypeOption(this.parser.OPTTokenShide,i),this.parseTypeOption(this.parser.OPTTokenGhide,i);break;case this.parser.OPTTokenHeader:this.headerOpt=void 0!==e?e:"",this.optionUnitBits|=this.HEADER_BIT;break;case this.parser.OPTTokenImportant:if(1===this.action)return!1;this.action=2;break;case this.parser.OPTTokenEmpty:if(t=1===this.action?this.parser.OPTTokenRedirectRule:this.parser.OPTTokenRedirect,!1===this.parseModifierOption(t,"empty"))return!1;this.optionUnitBits|=this.REDIRECT_BIT;break;case this.parser.OPTTokenMatchCase:this.patternMatchCase=!0;break;case this.parser.OPTTokenMp4:if(t=1===this.action?this.parser.OPTTokenRedirectRule:this.parser.OPTTokenRedirect,!1===this.parseModifierOption(t,"noopmp4-1s"))return!1;this.optionUnitBits|=this.REDIRECT_BIT;break;case this.parser.OPTTokenNoop:break;case this.parser.OPTTokenQueryprune:if(!1===this.parseModifierOption(t,e))return!1;this.optionUnitBits|=this.QUERYPRUNE_BIT;break;case this.parser.OPTTokenRedirect:if(1===this.action&&(t=this.parser.OPTTokenRedirectRule),!1===this.parseModifierOption(t,e))return!1;this.optionUnitBits|=this.REDIRECT_BIT;break;case this.parser.OPTTokenRedirectRule:if(!1===this.parseModifierOption(t,e))return!1;this.optionUnitBits|=this.REDIRECT_BIT;break;case this.parser.OPTTokenInvalid:return!1;default:if(!1===this.tokenIdToNormalizedType.has(t))return!1;this.parseTypeOption(t,i)}return 24===this.party&&(this.party=0),0!=(this.notTypes&n)&&(this.typeBits|=n),!(0!==this.notTypes&&(this.typeBits&=~this.notTypes,0===this.typeBits)||(this.modifyType===this.parser.OPTTokenCsp&&0===this.typeBits&&(this.parseTypeOption(this.parser.OPTTokenDoc,!1),this.parseTypeOption(this.parser.OPTTokenFrame,!1)),this.typeBits&o&&(this.typeBits&=~o,0===this.typeBits)))}parse(t){if(this.reset(t),t.hasError())return this.invalid=!0,this;if(t.patternIsDubious())return this.invalid=!0,this;if(t.isException()&&(this.action=1),this.isPureHostname=t.patternIsPlainHostname(),this.isPureHostname&&!1===t.hasOptions())return this.pattern=t.patternToLowercase(),this.anchor|=4,this;if(t.hasOptions()&&!1===this.parseOptions())return this.unsupported=!0,this;if(t.patternIsRegex())return this.isRegex=!0,this.pattern=this.normalizeRegexSource(t.getNetPattern()),""===this.pattern&&(this.unsupported=!0),this;let e;return e=t.patternIsMatchAll()?"*":t.patternToLowercase(),t.patternIsLeftHostnameAnchored()?this.anchor|=4:t.patternIsLeftAnchored()&&(this.anchor|=2),t.patternIsRightAnchored()&&(this.anchor|=1),t.patternHasWildcard()&&(this.firstWildcardPos=e.indexOf("*"),-1!==this.firstWildcardPos&&(this.secondWildcardPos=e.indexOf("*",this.firstWildcardPos+1))),t.patternHasCaret()&&(this.firstCaretPos=e.indexOf("^"),-1!==this.firstCaretPos&&(this.secondCaretPos=e.indexOf("^",this.firstCaretPos+1))),e.length>1024?(this.unsupported=!0,this):(this.pattern=e,this)}makeToken(){if("*"===this.pattern){if(this.modifyType!==this.parser.OPTTokenQueryprune)return;return this.extractTokenFromQuerypruneValue()}if(this.isRegex)return this.extractTokenFromRegex(this.pattern);this.extractTokenFromPattern(this.pattern)}extractTokenFromPattern(t){this.reToken.lastIndex=0;let e=null,i=2147483647;for(;;){const s=this.reToken.exec(t);if(null===s)break;const n=s[0],r=n.length>1?this.badTokens.get(n)||0:1;if(!(r>=i)){if(s.index>0&&42===t.charCodeAt(s.index-1))continue;if(n.length<this.maxTokenLen){const e=this.reToken.lastIndex;if(e<t.length&&42===t.charCodeAt(e))continue}if(e=s,0===r)break;i=r}}null!==e&&(this.token=e[0],this.tokenHash=Ft.tokenHashFromString(this.token),this.tokenBeg=e.index)}extractTokenFromRegex(t){let e;t=vAPI.StaticFilteringParser.regexUtils.toTokenizableStr(t),this.reToken.lastIndex=0;let i=2147483647;for(;;){const s=this.reToken.exec(t);if(null===s)break;const{0:n,index:r}=s;if(0===r||""===t.charAt(r-1))continue;const{lastIndex:o}=this.reToken;if(n.length<this.maxTokenLen&&(o===t.length||""===t.charAt(o)))continue;const a=n.length>1?this.badTokens.get(n)||0:1;if(a<i){if(e=n,0===a)break;i=a}}void 0!==e&&(this.token=e.toLowerCase(),this.tokenHash=Ft.tokenHashFromString(this.token))}extractTokenFromQuerypruneValue(){const t=this.modifyValue;if("*"===t||126===t.charCodeAt(0))return;const e=/^\/(.+)\/i?$/.exec(t);return null!==e?this.extractTokenFromRegex(e[1]):t.startsWith("|")?this.extractTokenFromRegex("\\b"+t.slice(1)):void this.extractTokenFromPattern(encodeURIComponent(t).toLowerCase())}hasNoOptionUnits(){return 0===this.optionUnitBits}isJustOrigin(){return this.optionUnitBits===this.DOMAIN_BIT&&!1===this.isRegex&&("*"===this.pattern||2===this.anchor&&/^(?:http[s*]?:(?:\/\/)?)$/.test(this.pattern))&&-1===this.domainOpt.indexOf("~")}domainIsEntity(t){const e=t.length;return e>2&&42===t.charCodeAt(e-1)&&46===t.charCodeAt(e-2)}};Bt.prototype.DOMAIN_BIT=1,Bt.prototype.DENYALLOW_BIT=2,Bt.prototype.HEADER_BIT=4,Bt.prototype.STRICT_PARTY_BIT=8,Bt.prototype.CSP_BIT=16,Bt.prototype.QUERYPRUNE_BIT=32,Bt.prototype.REDIRECT_BIT=64,Bt.parse=(()=>{let t,e,i=0;const s=()=>{e=void 0,Date.now()-i>1e4?t=void 0:e=vAPI.setTimeout(s,10007)};return n=>(void 0===t&&(t=new Bt(n)),i=Date.now(),void 0===e&&(e=vAPI.setTimeout(s,10007)),t.parse(n))})();const $t=function(){this.MAX_TOKEN_LENGTH=Ft.MAX_TOKEN_LENGTH,this.noTokenHash=Ft.noTokenHash,this.dotTokenHash=Ft.dotTokenHash,this.anyTokenHash=Ft.anyTokenHash,this.anyHTTPSTokenHash=Ft.anyHTTPSTokenHash,this.anyHTTPTokenHash=Ft.anyHTTPTokenHash,this.optimizeTimerId=void 0,this.categories=(()=>{const t=[];for(let e=0;e<2048;e++)t[e]=void 0;return t})(),this.reset()};return $t.prototype.prime=function(){Ot.prime(),at.prime(),D.reset(vAPI.localStorage.getItem("SNFE.bidiTrie"))},$t.prototype.reset=function(){this.processedFilterCount=0,this.acceptedCount=0,this.rejectedCount=0,this.allowFilterCount=0,this.blockFilterCount=0,this.discardedCount=0,this.goodFilters=new Set,this.badFilters=new Set,this.categories.fill(void 0),Ft.resetKnownTokens(),Ot.reset(),at.reset(),D.reset(),U.clear(),b=H,B=$,void 0!==this.optimizeTimerId&&(self.cancelIdleCallback(this.optimizeTimerId),this.optimizeTimerId=void 0),this.$catBits=0,this.$tokenHash=0,this.$filterUnit=0},$t.prototype.freeze=function(){const e=bt.fid,i=t.CompiledLineIO.unserialize,s=Date.now();for(const t of this.goodFilters){if(this.badFilters.has(t)){this.discardedCount+=1;continue}const s=i(t),n=s[0],r=s[1],o=s[2];let a=this.categories[n];void 0===a&&(a=new Map,this.categories[n]=a);let h=a.get(r);if(r===this.dotTokenHash){void 0===h&&(h=L(Ot),a.set(this.dotTokenHash,h)),P[h].add(o);continue}if(r===this.anyTokenHash){void 0===h&&(h=L(wt),a.set(this.anyTokenHash,h)),P[h].add(o);continue}if(r===this.anyHTTPSTokenHash){void 0===h&&(h=L(St),a.set(this.anyHTTPSTokenHash,h)),P[h].add(o);continue}if(r===this.anyHTTPTokenHash){void 0===h&&(h=L(vt),a.set(this.anyHTTPTokenHash,h)),P[h].add(o);continue}Ft.addKnownToken(r);const c=W(o);if(void 0===h){a.set(r,c);continue}let l=P[h];if(l.fid===e){l.unshift(c);continue}const u=L(bt);l=P[u],l.unshift(h),l.unshift(c),a.set(r,u)}this.badFilters.clear(),this.goodFilters.clear(),U.clear(),this.optimizeTimerId=self.requestIdleCallback((()=>{this.optimizeTimerId=void 0,this.optimize()}),{timeout:5e3}),log.info(`staticNetFilteringEngine.freeze() took ${Date.now()-s} ms`)},$t.prototype.optimize=function(){const t=Date.now();for(let t=0,e=this.categories.length;t<e;t++){const e=this.categories[t];if(void 0!==e)for(const[i,s]of e){const e=P[s];if(e instanceof bt==0)continue;const n=i===this.noTokenHash||0!=(4&t)?2:1,r=e.optimize(n);void 0!==r&&(P[s]=r)}}Ot.optimize(),z();for(let t=b,e=P.length;t<e;t++)P[t]=null;log.info(`staticNetFilteringEngine.optimize() took ${Date.now()-t} ms`)},$t.prototype.toSelfie=function(e){return z(!0),at.optimize(),Promise.all([t.assets.put(`${e}/FilterHostnameDict.trieContainer`,Ot.trieContainer.serialize(t.base64)),t.assets.put(`${e}/FilterOrigin.trieContainer`,at.trieContainer.serialize(t.base64)),t.assets.put(`${e}/bidiTrie`,D.serialize(t.base64)),t.assets.put(`${e}/filterSequences`,t.base64.encode(Uint32Array.from(F).buffer,B<<2)),t.assets.put(`${e}/main`,JSON.stringify({processedFilterCount:this.processedFilterCount,acceptedCount:this.acceptedCount,rejectedCount:this.rejectedCount,allowFilterCount:this.allowFilterCount,blockFilterCount:this.blockFilterCount,discardedCount:this.discardedCount,categories:(()=>{const t=[];for(let e=0,i=this.categories.length;e<i;e++){const i=this.categories[e];void 0!==i&&t.push([e,Array.from(i)])}return t})(),urlTokenizer:Ft.toSelfie(),filterUnits:P.slice(0,b).map((t=>null!==t?t.toSelfie():null))}))])},$t.prototype.fromSelfie=function(e){return Promise.all([t.assets.get(`${e}/FilterHostnameDict.trieContainer`).then((e=>Ot.trieContainer.unserialize(e.content,t.base64))),t.assets.get(`${e}/FilterOrigin.trieContainer`).then((e=>at.trieContainer.unserialize(e.content,t.base64))),t.assets.get(`${e}/bidiTrie`).then((e=>D.unserialize(e.content,t.base64))),t.assets.get(`${e}/filterSequences`).then((e=>{const i=t.base64.decodeSize(e.content)>>2;if(0===i)return!1;R(i),B=i;const s=t.base64.decode(e.content);for(let t=0;t<i;t++)F[t]=s[t];return!0})),t.assets.get(`${e}/main`).then((t=>{let e;try{e=JSON.parse(t.content)}catch(t){}if(e instanceof Object==0)return!1;this.processedFilterCount=e.processedFilterCount,this.acceptedCount=e.acceptedCount,this.rejectedCount=e.rejectedCount,this.allowFilterCount=e.allowFilterCount,this.blockFilterCount=e.blockFilterCount,this.discardedCount=e.discardedCount,Ft.fromSelfie(e.urlTokenizer);{const t=e.filterUnits;b=t.length,x(b);for(let e=0,s=t.length;e<s;e++){const s=t[e];P[e]=null!==s?_[(i=s)[0]].fromSelfie(i):null}}var i;for(const[t,i]of e.categories)this.categories[t]=new Map(i);return!0}))]).then((t=>t.every((t=>!0===t))))},$t.prototype.compile=function(e,i){const s=Bt.parse(e);if(s.invalid)return!1;if(s.unsupported){const s=i.properties.get("assetKey")||"?";return t.logger.writeOne({realm:"message",type:"error",text:`Invalid network filter in ${s}: ${e.raw}`}),!1}if(i.select(s.badFilter?t.compiledNetworkSection+t.compiledBadSubsection:t.compiledNetworkSection),s.modifyType===e.OPTTokenRedirect){s.modifyType=e.OPTTokenRedirectRule;const t=s.clone();t.modifyType=void 0,t.optionUnitBits&=~s.REDIRECT_BIT,this.compileParsed(t,i)}return this.compileParsed(s,i),!0},$t.prototype.compileParsed=function(t,e){if(t.isPureHostname&&t.hasNoOptionUnits())return t.tokenHash=this.dotTokenHash,void this.compileToAtomicFilter(t,t.pattern,e);if(t.makeToken(),t.isJustOrigin()){const i=t.tokenHash;"*"===t.pattern||t.pattern.startsWith("http*")?t.tokenHash=this.anyTokenHash:t.pattern.startsWith("https")?t.tokenHash=this.anyHTTPSTokenHash:t.tokenHash=this.anyHTTPTokenHash;const s=[];for(const i of t.domainOptList)!1===t.domainIsEntity(i)?this.compileToAtomicFilter(t,i,e):s.push(i);if(0===s.length)return;t.tokenHash=i;const n=0!=(2&t.anchor);for(const i of s){const s=[];j.compile(t,s),n&&s.push(it.compile()),at.compile([i],!0,s),this.compileToAtomicFilter(t,yt.compile(s),e)}return}const i=[];j.compile(t,i),0!=(4&t.anchor)?t.isPureHostname?i.push(et.compile()):i.push(tt.compile()):0!=(2&t.anchor)&&i.push(it.compile()),0!=(1&t.anchor)&&i.push(st.compile()),0!==t.strictParty&&i.push(At.compile(t)),""!==t.domainOpt&&at.compile(t.domainOptList,0!==i.length&&!0===_[i[0][0]].isSlow,i),""!==t.denyallowOpt&&i.push(Ct.compile(t)),void 0!==t.headerOpt&&(i.push(xt.compile(t)),t.action|=1024),void 0!==t.modifyType&&(i.unshift(mt.compile(t)),t.action=-4&t.action|4);const s=1===i.length?i[0]:yt.compile(i);this.compileToAtomicFilter(t,s,e)},$t.prototype.compileToAtomicFilter=function(t,e,i){const s=t.action|t.party;let r=t.typeBits;if(0===r)return void i.push([s,t.tokenHash,e]);(r&n)===n&&(i.push([s,t.tokenHash,e]),r&=~n);let o=1;do{1&r&&i.push([s|o<<5,t.tokenHash,e]),o+=1,r>>>=1}while(0!==r)},$t.prototype.fromCompiledContent=function(e){for(e.select(t.compiledNetworkSection);e.next();)this.acceptedCount+=1,this.goodFilters.has(e.line)?this.discardedCount+=1:this.goodFilters.add(e.line);for(e.select(t.compiledNetworkSection+t.compiledBadSubsection);e.next();)this.badFilters.add(e.line)},$t.prototype.matchAndFetchModifiers=function(t,s){h=Ft.setURL(t.url),c=t.url,u=t.getDocHostname(),p=t.getDocDomain(),g.reset(),l=t.getHostname();const n=e[t.type]||i,r=t.is3rdPartyToDoc()?16:8,o=4|n,a=4|r,f=4|n|r,m=this.categories[4],T=0!==n?this.categories[o]:void 0,k=0!==r?this.categories[a]:void 0,y=0!==n&&0!==r?this.categories[f]:void 0;if(void 0===m&&void 0===T&&void 0===k&&void 0===y)return;const O=[],C={modifier:vAPI.StaticFilteringParser.netOptionTokenIds.get(s)||0,bits:0,th:0,iunit:0,results:O},w=Ft.getTokens(D);let S=0;for(;;){const t=w[S];if(0===t)break;if(C.th=t,d=w[S+1],void 0!==m){const e=m.get(t);void 0!==e&&(C.bits=4,C.iunit=e,P[e].matchAndFetchModifiers(C))}if(void 0!==T){const e=T.get(t);void 0!==e&&(C.bits=o,C.iunit=e,P[e].matchAndFetchModifiers(C))}if(void 0!==k){const e=k.get(t);void 0!==e&&(C.bits=a,C.iunit=e,P[e].matchAndFetchModifiers(C))}if(void 0!==y){const e=y.get(t);void 0!==e&&(C.bits=f,C.iunit=e,P[e].matchAndFetchModifiers(C))}S+=2}if(0===O.length)return;if(1===O.length){const t=O[0];if(0!=(1&t.bits))return;return[t]}const v=new Map,b=new Map,H=new Map;for(const t of O){const e=3&t.bits,i=t.modifier.value;2===e?v.set(i,t):0===e?b.set(i,t):H.set(i,t)}if(0===v.size&&0===b.size)return;if(0!==v.size)for(const t of v.keys())b.delete(t),H.delete(t);if(0!==H.size)if(!1===H.has(""))for(const t of H.keys())b.has(t)?b.delete(t):H.delete(t);else if(0!==b.size){if(b.clear(),1!==H.size){const t=H.get("");H.clear(),H.set("",t)}}else H.clear();if(0===b.size&&0===v.size&&0===H.size)return;const A=Array.from(b.values());return 0!==v.size&&A.push(...v.values()),0!==H.size&&A.push(...H.values()),A},$t.prototype.realmMatchString=function(t,e,i){const s=2147483648&e,n=t,r=t|(e&=2147483647),o=t|i,a=t|e|i,h=0===s?this.categories[n]:void 0,c=0!==s||0!==e?this.categories[r]:void 0,l=0===s&&0!==i?this.categories[o]:void 0,u=0===s&&0===e||0===i?void 0:this.categories[a];if(void 0===h&&void 0===c&&void 0===l&&void 0===u)return!1;let p=0,f=0,m=this.dotTokenHash;if(void 0!==h&&0!==(f=h.get(m)||0)&&!0===P[f].match())p=n;else if(void 0!==c&&0!==(f=c.get(m)||0)&&!0===P[f].match())p=r;else if(void 0!==l&&0!==(f=l.get(m)||0)&&!0===P[f].match())p=o;else if(void 0!==u&&0!==(f=u.get(m)||0)&&!0===P[f].match())p=a;else{const t=Ft.getTokens(D);let e=0;for(;;){if(m=t[e],0===m)return!1;if(d=t[e+1],void 0!==h&&0!==(f=h.get(m)||0)&&!0===P[f].match()){p=n;break}if(void 0!==c&&0!==(f=c.get(m)||0)&&!0===P[f].match()){p=r;break}if(void 0!==l&&0!==(f=l.get(m)||0)&&!0===P[f].match()){p=o;break}if(void 0!==u&&0!==(f=u.get(m)||0)&&!0===P[f].match()){p=a;break}e+=2}}return this.$catBits=p,this.$tokenHash=m,this.$filterUnit=f,!0},$t.prototype.matchStringReverse=function(t,i){const s=2147483648|e[t];return h=Ft.setURL(i),c=i,this.$filterUnit=0,u=l=vAPI.hostnameFromNetworkURL(i),p=vAPI.domainFromHostname(u),g.reset(),this.realmMatchString(1,s,8)?this.realmMatchString(2,s,8)?1:2:0},$t.prototype.matchString=function(t,s=0){let n=e[t.type];if(0===s&&(void 0===n?n=i:(0===n||n>i)&&(s|=1)),0!=(1&s)){if(void 0===n)return 0;n|=2147483648}const r=t.is3rdPartyToDoc()?16:8;return h=Ft.setURL(t.url),c=t.url,this.$filterUnit=0,u=t.getDocHostname(),p=t.getDocDomain(),g.reset(),l=t.getHostname(),this.realmMatchString(2,n,r)?1:this.realmMatchString(0,n,r)?this.realmMatchString(1,n,r)?2:1:0},$t.prototype.matchHeaders=function(t,s){const n=e[t.type]||i,r=t.is3rdPartyToDoc()?16:8;h=Ft.setURL(t.url),c=t.url,this.$filterUnit=0,u=t.getDocHostname(),p=t.getDocDomain(),g.reset(),l=t.getHostname(),T.init(s);let o=0;return this.realmMatchString(1026,n,r)?o=1:this.realmMatchString(1024,n,r)&&(o=this.realmMatchString(1025,n,r)?2:1),T.reset(),o},$t.prototype.redirectRequest=function(e){const i=this.matchAndFetchModifiers(e,"redirect-rule");if(void 0===i)return;const s=i.length-1;0!==s&&i.sort($t.compareRedirectRequests);const n=i[s];if(0==(1&n.bits)){const{token:i}=$t.parseRedirectRequestValue(n.modifier);if(e.redirectURL=t.redirectEngine.tokenToURL(e,i),void 0===e.redirectURL)return}return i},$t.parseRedirectRequestValue=function(t){return void 0===t.cache&&(t.cache=vAPI.StaticFilteringParser.parseRedirectValue(t.value)),t.cache},$t.compareRedirectRequests=function(e,i){const{token:s,priority:n,bits:r}=$t.parseRedirectRequestValue(e.modifier);if(!1===t.redirectEngine.hasToken(s))return-1;const{token:o,priority:a,bits:h}=$t.parseRedirectRequestValue(i.modifier);if(!1===t.redirectEngine.hasToken(o))return 1;if(r!==h){if(0!=(2&r))return 1;if(0!=(2&h))return-1;if(0!=(1&r))return-1;if(0!=(1&h))return 1}return n-a},$t.prototype.filterQuery=function(t){const e=this.matchAndFetchModifiers(t,"queryprune");if(void 0===e)return;const i=t.url,s=i.indexOf("?");if(-1===s)return;let n=i.indexOf("#",s+1);-1===n&&(n=i.length);const r=new Map(new self.URLSearchParams(i.slice(s+1,n))),o=[];for(const t of e){if(0===r.size)break;const e=t.modifier,i=0!=(1&t.bits);if(i&&""===e.value){o.push(t);break}const{all:s,bad:n,name:a,not:h,re:c}=this.parseQueryPruneValue(e);if(n)continue;if(s){!1===i&&r.clear(),o.push(t);break}if(void 0!==a){const e=r.get(a);if(!1===h){void 0!==e&&(!1===i&&r.delete(a),o.push(t));continue}void 0!==e&&r.delete(a),0!==r.size&&(!1===i&&r.clear(),o.push(t)),void 0!==e&&r.set(a,e);continue}if(void 0===c)continue;let l=!1;for(const[t,e]of r)c.test(`${t}=${e}`)!==h&&(!1===i&&r.delete(t),l=!0);l&&o.push(t)}return 0!==o.length?(t.redirectURL=i.slice(0,s),0!==r.size&&(t.redirectURL+="?"+Array.from(r).map((t=>""===t[1]?t[0]:`${t[0]}=${encodeURIComponent(t[1])}`)).join("&")),n!==i.length&&(t.redirectURL+=i.slice(n)),o):void 0},$t.prototype.parseQueryPruneValue=function(t){return void 0===t.cache&&(t.cache=vAPI.StaticFilteringParser.parseQueryPruneValue(t.value)),t.cache},$t.prototype.hasQuery=function(t){return Ft.setURL(t.url),Ft.hasQuery()},$t.prototype.toLogData=function(){if(0===this.$filterUnit)return;const t=w(this.$catBits,this.$tokenHash,this.$filterUnit);return t.source="static",t.tokenHash=this.$tokenHash,t.result=0===this.$filterUnit?0:0==(1&this.$catBits)?1:2,t},$t.prototype.isBlockImportant=function(){return 2==(3&this.$catBits)},$t.prototype.getFilterCount=function(){return this.acceptedCount-this.discardedCount},$t.prototype.enableWASM=function(){return Promise.all([D.enableWASM(),at.trieContainer.enableWASM(),Ot.trieContainer.enableWASM()])},$t.prototype.benchmark=async function(e,i){const s=await t.loadBenchmarkDataset();if(!1===Array.isArray(s)||0===s.length){const t="No dataset found to benchmark";return console.info(t),t}const n=log.print;n("Benchmarking staticNetFilteringEngine.matchString()...");const r=t.filteringContext.duplicate();if("number"==typeof i){const t=s[i];r.setURL(t.url),r.setDocOriginFromURL(t.frameUrl),r.setType(t.cpt);const e=this.matchString(r);return n(`Result=${e}:`),n(`\ttype=${r.type}`),n(`\turl=${r.url}`),n(`\tdocOrigin=${r.getDocOrigin()}`),void(0!==e&&console.log(this.toLogData()))}let o,a;if(1===e)try{o=JSON.parse(vAPI.localStorage.getItem("FilterContainer.benchmark.results"))}catch(t){}2===e&&(a=[]);const h=self.performance.now();let c=0;for(let t=0;t<s.length;t++){const e=s[t];r.setURL(e.url),r.setDocOriginFromURL(e.frameUrl),r.setType(e.cpt),this.redirectURL=void 0;const i=this.matchString(r);c+=1,void 0!==a&&a.push(i),void 0!==o&&i!==o[t]&&(n(`Mismatch with reference results at ${t}:`),n(`\tExpected ${o[t]}, got ${i}:`),n(`\ttype=${r.type}`),n(`\turl=${r.url}`),n(`\tdocOrigin=${r.getDocOrigin()}`)),1!==i?(this.hasQuery(r)&&this.filterQuery(r,"queryprune"),"main_frame"!==r.type&&"sub_frame"!==r.type||this.matchAndFetchModifiers(r,"csp"),this.matchHeaders(r,[])):this.redirectRequest(r)}const l=self.performance.now()-h;void 0!==a&&vAPI.localStorage.setItem("FilterContainer.benchmark.results",JSON.stringify(a));const u=["Benchmarked static network filtering engine:",`\tEvaluated ${c} match calls in ${l.toFixed(0)} ms`,`\tAverage: ${(l/c).toFixed(3)} ms per request`];void 0!==o&&u.push(`\tBlocked: ${o.reduce(((t,e)=>1===e?t+1:t),0)}`,`\tExcepted: ${o.reduce(((t,e)=>2===e?t+1:t),0)}`);const p=u.join("\n");return n(p),p},$t.prototype.test=function(e,i,s){const n=t.filteringContext.duplicate();n.setDocOriginFromURL(e),n.setType(i),n.setURL(s);const r=this.matchString(n);console.log(`${r}`),0!==r&&console.log(this.toLogData())},$t.prototype.bucketHistogram=function(){const t=[];for(let e=0,i=this.categories.length;e<i;e++){const i=this.categories[e];if(void 0!==i)for(const[s,n]of i){const i=Ft.stringFromTokenHash(s),r=P[n];r instanceof bt||r instanceof Ot||r instanceof wt?t.push({bits:e.toString(16),token:i,size:r.size,f:r}):t.push({bits:e.toString(16),token:i,size:1,f:r})}}t.sort(((t,e)=>e.size-t.size)),console.log(t)},$t.prototype.filterClassHistogram=function(){const t=new Map;for(const e of _)t.set(e.fid,{name:e.name,count:0});t.set(1e3,{name:"FilterPlainTrie Content",count:0}),t.set(1001,{name:"FilterHostnameDict Content",count:0});const e=function(e){e instanceof Object!=0&&(t.get(e.fid).count+=1)};for(const i of P)if(null!==i)if(e(i),i instanceof Tt){let s=i.i;for(;0!==s;)e(P[F[s+0]]),s=F[s+1];i.plainTrie&&(t.get(1e3).count+=i.plainTrie.size)}else if(i instanceof Ot)t.get(1001).count+=i.size;else if(i instanceof yt){let t=i.i;for(;0!==t;)e(P[F[t+0]]),t=F[t+1]}else i instanceof Pt&&(t.get(1e3).count+=i.plainTrie.size);const i=Array.from(t.values()).sort(((t,e)=>e.count-t.count));console.log(i)},$t.prototype.tokenHistograms=async function(){const e=await t.loadBenchmarkDataset();if(!1===Array.isArray(e)||0===e.length)return void console.info("No requests found to benchmark");console.info("Computing token histograms...");const i=t.filteringContext.duplicate(),s=new Map,n=new Map,r=/[0-9a-z%]{2,}/g;for(let t=0;t<e.length;t++){const o=e[t];i.setURL(o.url),i.setDocOriginFromURL(o.frameUrl),i.setType(o.cpt);const a=this.matchString(i);for(let[t]of o.url.toLowerCase().matchAll(r)){const e=t;0===a?s.set(e,(s.get(e)||0)+1):1===a&&n.set(e,(n.get(e)||0)+1)}}const o=(t,e)=>e[1]-t[1],a=Array.from(s).sort(o).slice(0,100);for(const[t]of a)n.delete(t);const h=Array.from(n).sort(o).slice(0,100);console.log("Misses:",JSON.stringify(a)),console.log("Hits:",JSON.stringify(h))},new $t})();