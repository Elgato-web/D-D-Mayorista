"use strict";{const e=µBlock,t=function(t,i){const{tabId:s,frameId:n}=i;if(void 0===s||void 0===n)return!1;const r=e.pageStoreFromTabId(s);return null!==r&&(r.clickToLoad(n,t.frameURL),!0)},i=function(t){const i=e.URI;return t.map((e=>"string"!=typeof e?"":-1!==e.indexOf("/")?i.domainFromURI(e)||"":i.domainFromHostname(e)||e))},s=function(s,n,r){switch(s.what){case"getAssetContent":return void e.assets.get(s.url,{dontCache:!0,needSourceURL:!0}).then((e=>{r(e)}));case"listsFromNetFilter":return void e.staticFilteringReverseLookup.fromNetFilter(s.rawFilter).then((e=>{r(e)}));case"listsFromCosmeticFilter":return void e.staticFilteringReverseLookup.fromCosmeticFilter(s).then((e=>{r(e)}));case"reloadAllFilters":return void e.loadFilterLists().then((()=>{r()}));case"scriptlet":return void e.scriptlets.inject(s.tabId,s.scriptlet,r);case"sfneBenchmark":return void e.staticNetFilteringEngine.benchmark().then((e=>{r(e)}))}let o;switch(s.what){case"applyFilterListSelection":o=e.applyFilterListSelection(s);break;case"clickToLoad":o=t(s,n);break;case"createUserFilter":e.createUserFilters(s);break;case"forceUpdateAssets":e.scheduleAssetUpdater(0),e.assets.updateStart({delay:e.hiddenSettings.manualUpdateAssetFetchPeriod});break;case"getAppData":o={name:browser.runtime.getManifest().name,version:vAPI.app.version,canBenchmark:"unset"!==e.hiddenSettings.benchmarkDatasetURL};break;case"getDomainNames":o=i(s.targets);break;case"getWhitelist":o={whitelist:e.arrayFromWhitelist(e.netWhitelist),whitelistDefault:e.netWhitelistDefault,reBadHostname:e.reWhitelistBadHostname.source,reHostnameExtractor:e.reWhitelistHostnameExtractor.source};break;case"launchElementPicker":e.epickerArgs.mouse=!1,e.elementPickerExec(s.tabId,0,s.targetURL,s.zap);break;case"gotoURL":e.openNewTab(s.details);break;case"reloadTab":!1===vAPI.isBehindTheSceneTabId(s.tabId)&&(vAPI.tabs.reload(s.tabId,!0===s.bypassCache),s.select&&vAPI.tabs.select&&vAPI.tabs.select(s.tabId));break;case"setWhitelist":e.netWhitelist=e.whitelistFromString(s.whitelist),e.saveWhitelist();break;case"toggleHostnameSwitch":e.toggleHostnameSwitch(s);break;case"uiStyles":o={uiStyles:e.hiddenSettings.uiStyles,uiTheme:vAPI.webextFlavor.soup.has("devbuild")?e.hiddenSettings.uiTheme:"unset"};break;case"userSettings":o=e.changeUserSettings(s.name,s.value);break;default:return vAPI.messaging.UNHANDLED}r(o)};vAPI.messaging.setup(s)}{const e=µBlock,t=function(e,t){const i=Object.create(null),s=[];for(const[t,n]of e){if(void 0!==i[t])continue;const r=vAPI.domainFromHostname(t)||t,o=e.get(r)||0;let a=65535&o,l=o>>>16&65535;if(void 0===i[r]){i[r]={domain:r,blockCount:a,allowCount:l,totalBlockCount:a,totalAllowCount:l};const e=vAPI.net.canonicalNameFromHostname(r);void 0!==e&&s.push([e,r])}const c=i[r];if(a=65535&n,l=n>>>16&65535,c.totalBlockCount+=a,c.totalAllowCount+=l,t===r)continue;i[t]={domain:r,blockCount:a,allowCount:l,totalBlockCount:0,totalAllowCount:0};const u=vAPI.net.canonicalNameFromHostname(t);void 0!==u&&s.push([u,t])}t.hostnameDict=i,t.cnameMap=s},i=function(t,i){const s={},n=e.sessionFirewall;if(s["/ * *"]=n.lookupRuleData("*","*","*"),s["/ * image"]=n.lookupRuleData("*","*","image"),s["/ * 3p"]=n.lookupRuleData("*","*","3p"),s["/ * inline-script"]=n.lookupRuleData("*","*","inline-script"),s["/ * 1p-script"]=n.lookupRuleData("*","*","1p-script"),s["/ * 3p-script"]=n.lookupRuleData("*","*","3p-script"),s["/ * 3p-frame"]=n.lookupRuleData("*","*","3p-frame"),"string"!=typeof t)return s;s[". * *"]=n.lookupRuleData(t,"*","*"),s[". * image"]=n.lookupRuleData(t,"*","image"),s[". * 3p"]=n.lookupRuleData(t,"*","3p"),s[". * inline-script"]=n.lookupRuleData(t,"*","inline-script"),s[". * 1p-script"]=n.lookupRuleData(t,"*","1p-script"),s[". * 3p-script"]=n.lookupRuleData(t,"*","3p-script"),s[". * 3p-frame"]=n.lookupRuleData(t,"*","3p-frame");for(const e in i)s[`/ ${e} *`]=n.lookupRuleData("*",e,"*"),s[`. ${e} *`]=n.lookupRuleData(t,e,"*");return s},s=function(s,n){const r=e.tabContextManager.mustLookup(s),o=r.rootHostname,a=e.userSettings,l=e.hiddenSettings,c={advancedUserEnabled:a.advancedUserEnabled,appName:vAPI.app.name,appVersion:vAPI.app.version,colorBlindFriendly:a.colorBlindFriendly,cosmeticFilteringSwitch:!1,firewallPaneMinimized:a.firewallPaneMinimized,globalAllowedRequestCount:e.localSettings.allowedRequestCount,globalBlockedRequestCount:e.localSettings.blockedRequestCount,fontSize:l.popupFontSize,godMode:l.filterAuthorMode,netFilteringSwitch:!1,rawURL:r.rawURL,pageURL:r.normalURL,pageHostname:o,pageDomain:r.rootDomain,pageAllowedRequestCount:0,pageBlockedRequestCount:0,popupBlockedCount:0,popupPanelSections:a.popupPanelSections,popupPanelDisabledSections:l.popupPanelDisabledSections,popupPanelLockedSections:l.popupPanelLockedSections,popupPanelHeightMode:l.popupPanelHeightMode,tabId:s,tabTitle:n,tooltipsDisabled:a.tooltipsDisabled};"undocumented"!==l.uiPopupConfig&&(c.uiPopupConfig=l.uiPopupConfig);const u=e.pageStoreFromTabId(s);return u?(!1===u.hostnameToCountMap.has(o)&&e.URI.isNetworkURI(r.rawURL)&&u.hostnameToCountMap.set(o,0),c.pageBlockedRequestCount=u.perLoadBlockedRequestCount,c.pageAllowedRequestCount=u.perLoadAllowedRequestCount,c.netFilteringSwitch=u.getNetFilteringSwitch(),t(u.hostnameToCountMap,c),c.contentLastModified=u.contentLastModified,c.firewallRules=i(o,c.hostnameDict),c.canElementPicker=e.URI.isNetworkURI(c.rawURL),c.noPopups=e.sessionSwitches.evaluateZ("no-popups",o),c.popupBlockedCount=u.popupBlockedCount,c.noCosmeticFiltering=e.sessionSwitches.evaluateZ("no-cosmetic-filtering",o),c.noLargeMedia=e.sessionSwitches.evaluateZ("no-large-media",o),c.largeMediaCount=u.largeMediaCount,c.noRemoteFonts=e.sessionSwitches.evaluateZ("no-remote-fonts",o),c.remoteFontCount=u.remoteFontCount,c.noScripting=e.sessionSwitches.evaluateZ("no-scripting",o)):(c.hostnameDict={},c.firewallRules=i()),c.matrixIsDirty=!1===e.sessionFirewall.hasSameRules(e.permanentFirewall,o,c.hostnameDict),!1===c.matrixIsDirty&&(c.matrixIsDirty=!1===e.sessionSwitches.hasSameRules(e.permanentSwitches,o)),c},n=async function(e){if(e.tabId)return s(e.tabId,"");const t=await vAPI.tabs.getCurrent();let i="",n="";return t instanceof Object&&(i=t.id,n=t.title||""),s(i,n)},r=async function(e,t){const i=await vAPI.tabs.executeScript(e,{allFrames:!0,file:`/js/scriptlets/dom-survey-${t}.js`,runAt:"document_end"});let s=0;for(const e of i)if("number"==typeof e){if(-1===e)return-1;s+=e}return s},o=function(t,i,o){switch(t.what){case"getHiddenElementCount":return void r(t.tabId,"elements").then((e=>{o(e)}));case"getScriptCount":return void r(t.tabId,"scripts").then((e=>{o(e)}));case"getPopupData":return void n(t).then((e=>{o(e)}))}let a,l;switch(t.what){case"hasPopupContentChanged":l=e.pageStoreFromTabId(t.tabId),a=(l?l.contentLastModified:0)!==t.contentLastModified;break;case"revertFirewallRules":e.sessionFirewall.copyRules(e.permanentFirewall,t.srcHostname,t.desHostnames),e.sessionSwitches.copyRules(e.permanentSwitches,t.srcHostname),e.cosmeticFilteringEngine.removeFromSelectorCache(t.srcHostname,"net"),e.updateToolbarIcon(t.tabId,4),a=s(t.tabId);break;case"saveFirewallRules":e.permanentFirewall.copyRules(e.sessionFirewall,t.srcHostname,t.desHostnames)&&e.savePermanentFirewallRules(),e.permanentSwitches.copyRules(e.sessionSwitches,t.srcHostname)&&e.saveHostnameSwitches();break;case"toggleHostnameSwitch":e.toggleHostnameSwitch(t),a=s(t.tabId);break;case"toggleFirewallRule":e.toggleFirewallRule(t),a=s(t.tabId);break;case"toggleNetFiltering":l=e.pageStoreFromTabId(t.tabId),l&&(l.toggleNetFilteringSwitch(t.url,t.scope,t.state),e.updateToolbarIcon(t.tabId,7));break;default:return vAPI.messaging.UNHANDLED}o(a)};vAPI.messaging.listen({name:"popupPanel",listener:o,privileged:!0}),e.v2.popupDataFromTabId=s}{const e=µBlock,t=function(t,i){if(!0!==e.readyToFilter)return;const{tabId:s,frameId:n}=t;if(void 0===s||void 0===n)return;const r=e.pageStoreFromTabId(s);if(null===r||!1===r.getNetFilteringSwitch())return;0!==n&&i.url.startsWith("about:")&&(i.url=r.getEffectiveFrameURL(t));const o=!0===r.noCosmeticFiltering,a={collapseBlocked:e.userSettings.collapseBlocked,noCosmeticFiltering:o,noGenericCosmeticFiltering:o,noSpecificCosmeticFiltering:o};if(!1===o){const t=e.staticNetFilteringEngine.matchStringReverse("generichide",i.url);a.noGenericCosmeticFiltering=2===t,0!==t&&e.logger.enabled&&µBlock.filteringContext.duplicate().fromTabId(s).setURL(i.url).setRealm("network").setType("generichide").setFilter(e.staticNetFilteringEngine.toLogData()).toLogger()}if(i.tabId=s,i.frameId=n,i.hostname=e.URI.hostnameFromURI(i.url),i.domain=e.URI.domainFromHostname(i.hostname),i.entity=e.URI.entityFromDomain(i.domain),!1===o){const t=e.staticNetFilteringEngine.matchStringReverse("specifichide",i.url);a.noSpecificCosmeticFiltering=2===t,0!==t&&e.logger.enabled&&µBlock.filteringContext.duplicate().fromTabId(s).setURL(i.url).setRealm("network").setType("specifichide").setFilter(e.staticNetFilteringEngine.toLogData()).toLogger()}return!1===o&&a.noGenericCosmeticFiltering&&a.noSpecificCosmeticFiltering&&(a.noCosmeticFiltering=!0),a.specificCosmeticFilters=e.cosmeticFilteringEngine.retrieveSpecificSelectors(i,a),!1!==e.canInjectScriptletsNow&&!1!==e.URI.isNetworkURI(t.frameURL)||(a.scriptlets=e.scriptletFilteringEngine.retrieve(i)),e.logger.enabled&&!0!==a.noCosmeticFiltering&&e.logCosmeticFilters(s,n),a},i=function(i,s,n){i.what;const r=e.pageStoreFromTabId(s.tabId);let o;switch(i.what){case"cosmeticFiltersInjected":e.cosmeticFilteringEngine.addToSelectorCache(i);break;case"getCollapsibleBlockedRequests":o={id:i.id,hash:i.hash,netSelectorCacheCountMax:e.cosmeticFilteringEngine.netSelectorCacheCountMax},e.userSettings.collapseBlocked&&r&&r.getNetFilteringSwitch()&&r.getBlockedResources(i,o);break;case"maybeGoodPopup":e.maybeGoodPopup.tabId=s.tabId,e.maybeGoodPopup.url=i.url;break;case"shouldRenderNoscriptTags":if(null===r)break;const n=e.filteringContext.fromTabId(s.tabId);r.filterScripting(n,void 0)&&vAPI.tabs.executeScript(s.tabId,{file:"/js/scriptlets/noscript-spoof.js",frameId:s.frameId,runAt:"document_end"});break;case"retrieveContentScriptParameters":o=t(s,i);break;case"retrieveGenericCosmeticSelectors":i.tabId=s.tabId,i.frameId=s.frameId,o={result:e.cosmeticFilteringEngine.retrieveGenericSelectors(i)};break;default:return vAPI.messaging.UNHANDLED}n(o)};vAPI.messaging.listen({name:"contentscript",listener:i})}{const e=function(e,t,i){const s=µBlock;let n;switch(e.what,e.what){case"elementPickerArguments":n={target:s.epickerArgs.target,mouse:s.epickerArgs.mouse,zap:s.epickerArgs.zap,eprom:s.epickerArgs.eprom,pickerURL:vAPI.getURL(`/web_accessible_resources/epicker-ui.html?secret=${vAPI.warSecret()}`)},s.epickerArgs.target="";break;case"elementPickerEprom":s.epickerArgs.eprom=e;break;default:return vAPI.messaging.UNHANDLED}i(n)};vAPI.messaging.listen({name:"elementPicker",listener:e})}{const e=function(e){if("string"!=typeof e)return Promise.resolve(e);let t;try{t=µBlock.denseBase64.decode(e)}catch(e){}return Promise.resolve(void 0!==t?t:e)},t=function(e){const t=e instanceof Uint8Array?µBlock.denseBase64.encode(e):e;return Promise.resolve(t)},i=function(e){return µBlock.lz4Codec.encode(e,t)},s=function(t){return µBlock.lz4Codec.decode(t,e)},n=function(e,t,n){if(!0===µBlock.cloudStorageSupported){switch(e.what){case"cloudGetOptions":return void vAPI.cloud.getOptions((function(e){e.enabled=!0===µBlock.userSettings.cloudStorageEnabled,n(e)}));case"cloudSetOptions":return void vAPI.cloud.setOptions(e.options,n);case"cloudPull":return e.decode=s,vAPI.cloud.pull(e).then((e=>{n(e)}));case"cloudPush":return µBlock.hiddenSettings.cloudStorageCompression&&(e.encode=i),vAPI.cloud.push(e).then((e=>{n(e)}));case"cloudUsed":return vAPI.cloud.used(e.datakey).then((e=>{n(e)}))}switch(e.what){case"cloudPull":case"cloudPush":break;default:return vAPI.messaging.UNHANDLED}n(void 0)}else n()};vAPI.messaging.listen({name:"cloudWidget",listener:n,privileged:!0})}{const e=µBlock,t=async function(){const t=Object.assign({},e.restoreBackupSettings);return t.storageUsed=await e.getBytesInUse(),t.cloudStorageSupported=e.cloudStorageSupported,t.privacySettingsSupported=e.privacySettingsSupported,t},i=async function(){const i=await e.loadUserFilters(),s={timeStamp:Date.now(),version:vAPI.app.version,userSettings:e.getModifiedSettings(e.userSettings,e.userSettingsDefault),selectedFilterLists:e.selectedFilterLists,hiddenSettings:e.getModifiedSettings(e.hiddenSettings,e.hiddenSettingsDefault),whitelist:e.arrayFromWhitelist(e.netWhitelist),dynamicFilteringString:e.permanentFirewall.toString(),urlFilteringString:e.permanentURLFiltering.toString(),hostnameSwitchesString:e.permanentSwitches.toString(),userFilters:i.content},n=vAPI.i18n("aboutBackupFilename").replace("{{datetime}}",e.dateNowToSensibleString()).replace(/ +/g,"_");return e.restoreBackupSettings.lastBackupFile=n,e.restoreBackupSettings.lastBackupTime=Date.now(),vAPI.storage.set(e.restoreBackupSettings),{localData:await t(),userData:s}},s=async function(t){const i=t.userData;vAPI.webextFlavor.soup.has("firefox")&&vAPI.app.intFromVersion(i.version)<=1031003011&&(i.hostnameSwitchesString+="\nno-csp-reports: * true"),"string"==typeof i.externalLists&&(i.externalLists=i.externalLists.trim().split(/[\n\r]+/)),e.assets.rmrf(),await Promise.all([e.cacheStorage.clear(),vAPI.storage.clear()]),µBlock.saveLocalSettings(),vAPI.storage.set(i.userSettings);let s=i.hiddenSettings;s instanceof Object==0&&(s=µBlock.hiddenSettingsFromString(i.hiddenSettingsString||""));for(const t in s)!1!==e.hiddenSettingsDefault.hasOwnProperty(t)&&s[t]!==e.hiddenSettingsDefault[t]||delete s[t];let n=i.whitelist;!1===Array.isArray(n)&&"string"==typeof i.netWhitelist&&""!==i.netWhitelist&&(n=i.netWhitelist.split("\n")),vAPI.storage.set({hiddenSettings:s,netWhitelist:n||[],dynamicFilteringString:i.dynamicFilteringString||"",urlFilteringString:i.urlFilteringString||"",hostnameSwitchesString:i.hostnameSwitchesString||"",lastRestoreFile:t.file||"",lastRestoreTime:Date.now(),lastBackupFile:"",lastBackupTime:0}),e.saveUserFilters(i.userFilters),Array.isArray(i.selectedFilterLists)&&await e.saveSelectedFilterLists(i.selectedFilterLists),vAPI.app.restart()},n=async function(){await Promise.all([e.cacheStorage.clear(),vAPI.storage.clear()]),await e.saveLocalSettings(),vAPI.app.restart()},r=function(t){const i=e.URI;for(const e in t){if(!1===t.hasOwnProperty(e))continue;const s=t[e];if("string"==typeof s.supportURL&&""!==s.supportURL)s.supportName=i.hostnameFromURI(s.supportURL);else if("string"==typeof s.homeURL&&""!==s.homeURL){const e=i.hostnameFromURI(s.homeURL);s.supportURL=`http://${e}/`,s.supportName=i.domainFromHostname(e)}}},o=async function(t){const i={autoUpdate:e.userSettings.autoUpdate,available:null,cache:null,cosmeticFilterCount:e.cosmeticFilteringEngine.getFilterCount(),current:e.availableFilterLists,ignoreGenericCosmeticFilters:e.userSettings.ignoreGenericCosmeticFilters,isUpdating:e.assets.isUpdating(),netFilterCount:e.staticNetFilteringEngine.getFilterCount(),parseCosmeticFilters:e.userSettings.parseAllABPHideFilters,userFiltersPath:e.userFiltersPath},[s,n]=await Promise.all([e.getAvailableLists(),e.assets.metadata()]);i.available=s,r(i.available),i.cache=n,r(i.cache),t(i)},a=function(){const t=self.punycode,i=new Set;for(const s of e.pageStores.keys()){if(-1===s)continue;const n=e.tabContextManager.lookup(s);if(null===n)continue;let{rootDomain:r,rootHostname:o}=n;if(r.endsWith("-scheme"))continue;const a=o.includes("xn--");i.add(a?t.toUnicode(r):r),o!==r&&i.add(a?t.toUnicode(o):o)}return Array.from(i)},l=function(){return{permanentRules:e.permanentFirewall.toArray().concat(e.permanentSwitches.toArray(),e.permanentURLFiltering.toArray()),sessionRules:e.sessionFirewall.toArray().concat(e.sessionSwitches.toArray(),e.sessionURLFiltering.toArray()),pslSelfie:self.publicSuffixList.toSelfie()}},c=function(t){let i,s,n;t.permanent?(i=e.permanentSwitches,s=e.permanentFirewall,n=e.permanentURLFiltering):(i=e.sessionSwitches,s=e.sessionFirewall,n=e.sessionURLFiltering);let r=new Set(t.toRemove.trim().split(/\s*[\n\r]+\s*/));for(let e of r){if(""===e)continue;let t=e.split(/\s+/);!1===s.removeFromRuleParts(t)&&!1===i.removeFromRuleParts(t)&&n.removeFromRuleParts(t)}let o=new Set(t.toAdd.trim().split(/\s*[\n\r]+\s*/));for(let e of o){if(""===e)continue;let t=e.split(/\s+/);!1===s.addFromRuleParts(t)&&!1===i.addFromRuleParts(t)&&n.addFromRuleParts(t)}t.permanent&&(i.changed&&(e.saveHostnameSwitches(),i.changed=!1),s.changed&&(e.savePermanentFirewallRules(),s.changed=!1),n.changed&&(e.savePermanentURLFilteringRules(),n.changed=!1))},u=function(t){if(!1===e.canUseShortcuts)return t([]);vAPI.commands.getAll((e=>{let i=[];for(let t of e){let e=t.description,s=/^__MSG_(.+?)__$/.exec(e);null!==s&&(e=vAPI.i18n(s[1])),""!==e&&(t.description=e,i.push(t))}t(i)}))},d=function(t){!1!==e.canUpdateShortcuts&&(void 0===t.shortcut?(vAPI.commands.reset(t.name),e.commandShortcuts.delete(t.name)):(vAPI.commands.update({name:t.name,shortcut:t.shortcut}),e.commandShortcuts.set(t.name,t.shortcut)),vAPI.storage.set({commandShortcuts:Array.from(e.commandShortcuts)}))},p=function(r,p,g){switch(r.what){case"backupUserData":return i().then((e=>{g(e)}));case"getLists":return o(g);case"getLocalData":return t().then((e=>{g(e)}));case"getShortcuts":return u(g);case"readUserFilters":return e.loadUserFilters().then((e=>{g(e)}));case"writeUserFilters":return e.saveUserFilters(r.content).then((e=>{g(e)}))}let m;switch(r.what){case"dashboardConfig":m={canUpdateShortcuts:e.canUpdateShortcuts,noDashboard:e.noDashboard};break;case"getAutoCompleteDetails":m={},0===(r.hintUpdateToken||0)&&(m.redirectResources=e.redirectEngine.getResourceDetails(),m.preparseDirectiveTokens=e.preparseDirectives.getTokens(),m.preparseDirectiveHints=e.preparseDirectives.getHints(),m.expertMode=e.hiddenSettings.filterAuthorMode),r.hintUpdateToken!==e.pageStoresToken&&(m.originHints=a(),m.hintUpdateToken=e.pageStoresToken);break;case"getRules":m=l();break;case"modifyRuleset":e.cosmeticFilteringEngine.removeFromSelectorCache("*"),c(r),m=l();break;case"purgeAllCaches":r.hard?e.assets.remove(/./):e.assets.purge(/./,"public_suffix_list.dat");break;case"purgeCache":e.assets.purge(r.assetKey),e.assets.remove("compiled/"+r.assetKey);break;case"readHiddenSettings":m={default:e.hiddenSettingsDefault,admin:e.hiddenSettingsAdmin,current:e.hiddenSettings};break;case"restoreUserData":s(r);break;case"resetUserData":n();break;case"setShortcut":d(r);break;case"writeHiddenSettings":e.changeHiddenSettings(e.hiddenSettingsFromString(r.content));break;default:return vAPI.messaging.UNHANDLED}g(m)};vAPI.messaging.listen({name:"dashboard",listener:p,privileged:!0})}{const e=µBlock,t=vAPI.getURL(""),i=async function(i,s,n){const r={activeTabId:s,colorBlind:e.userSettings.colorBlindFriendly,entries:e.logger.readAll(i.ownerId),filterAuthorMode:e.hiddenSettings.filterAuthorMode,tabIdsToken:e.pageStoresToken,tooltips:!1===e.userSettings.tooltipsDisabled};if(e.pageStoresToken!==i.tabIdsToken){const i=new Map;for(const s of e.pageStores){const e=s[1];e.rawURL.startsWith(t)||i.set(s[0],e.title)}r.tabIds=Array.from(i)}if(s){const i=e.pageStoreFromTabId(s);(null===i||i.rawURL.startsWith(t))&&(r.activeTabId=void 0)}if(i.popupLoggerBoxChanged&&vAPI.windows instanceof Object){const e=await vAPI.tabs.query({url:vAPI.getURL("/logger-ui.html?popup=1")});if(0!==e.length){const t=await vAPI.windows.get(e[0].windowId);if(null===t)return;vAPI.localStorage.setItem("popupLoggerBox",JSON.stringify({left:t.left,top:t.top,width:t.width,height:t.height}))}}n(r)},s=function(t){const i={},s={dirty:!1,colors:i},n=e.sessionURLFiltering,r=e.permanentURLFiltering,o=t.urls,a=t.context,l=t.type;for(const e of o){const t=i[e]={r:0,own:!1};0!==n.evaluateZ(a,e,l).r&&(t.r=n.r,t.own=0!==n.r&&n.context===a&&n.url===e&&n.type===l),s.dirty||(r.evaluateZ(a,e,l),s.dirty=t.own!==(0!==r.r&&r.context===a&&r.url===e&&r.type===l))}return s},n=function(t){const i=new vAPI.StaticFilteringParser;if(i.analyze(t),i.shouldDiscard())return{};let s,n=i.result.compiled;return s=0!=(i.flavorBits&i.BITFlavorExtScriptlet)?e.scriptletFilteringEngine.getSession():0!=(i.flavorBits&i.BITFlavorExtHTML)?e.htmlFilteringEngine.getSession():e.cosmeticFilteringEngine.getSession(),{session:s,selector:n}},r=function(e){const{session:t,selector:i}=n(e.filter);return t.has(1,i)?(t.remove(1,i),!1):(t.add(1,i),!0)},o=function(e){const{session:t,selector:i}=n(e.filter);return t&&t.has(1,i)},a=function(t,n,a){if("readAll"===t.what)return void 0!==e.logger.ownerId&&e.logger.ownerId!==t.ownerId?a({unavailable:!0}):void vAPI.tabs.getCurrent().then((e=>{i(t,e&&e.id,a)}));let l;switch(t.what){case"hasTemporaryException":l=o(t);break;case"releaseView":t.ownerId===e.logger.ownerId&&(e.logger.ownerId=void 0);break;case"saveURLFilteringRules":l=e.permanentURLFiltering.copyRules(e.sessionURLFiltering,t.context,t.urls,t.type),l&&e.savePermanentURLFilteringRules();break;case"setURLFilteringRule":e.toggleURLFilteringRule(t);break;case"getURLFilteringData":l=s(t);break;case"toggleTemporaryException":l=r(t);break;default:return vAPI.messaging.UNHANDLED}a(l)};vAPI.messaging.listen({name:"loggerUI",listener:a,privileged:!0})}{const e=function(e,t,i){const s=t.tabId||0;switch(e.what,e.what){case"closeThisTab":vAPI.tabs.remove(s);break;case"temporarilyWhitelistDocument":µBlock.webRequest.strictBlockBypass(e.hostname);break;default:return vAPI.messaging.UNHANDLED}i(void 0)};vAPI.messaging.listen({name:"documentBlocked",listener:e,privileged:!0})}{const e=µBlock,t=function(t,i){if(!1===e.logger.enabled)return;const s={source:"cosmetic",raw:""},n=e.filteringContext.duplicate();n.fromTabId(t).setRealm("cosmetic").setType("dom").setURL(i.frameURL).setDocOriginFromURL(i.frameURL).setFilter(s);for(const e of i.matchedSelectors.sort())s.raw=e,n.toLogger()},i=function(t,s){if(!1===e.logger.enabled||null===t)return!1;if(0===s.violations.length)return!0;const n=e.filteringContext.duplicate();n.fromTabId(t.tabId).setRealm("network").setDocOriginFromURL(s.docURL).setURL(s.docURL);let r=t.extraData.get("cspData");if(void 0===r){r=new Map;const i=e.staticNetFilteringEngine.matchAndFetchModifiers(n,"csp");if(void 0!==i)for(const e of i)1===e.result&&r.set(e.value,e.logData());if(n.type="inline-script",n.filter=void 0,1===t.filterRequest(n)&&r.set(e.cspNoInlineScript,n.filter),n.type="script",n.filter=void 0,1===t.filterScripting(n,!0)&&r.set(e.cspNoScripting,n.filter),n.type="inline-font",n.filter=void 0,1===t.filterRequest(n)&&r.set(e.cspNoInlineFont,n.filter),0===r.size)return!1;t.extraData.set("cspData",r)}const o=i.policyDirectiveToTypeMap;for(const e of s.violations){const t=JSON.parse(e);let i=o.get(t.directive);if(void 0===i)continue;const a=r.get(t.policy);void 0!==a&&(!1===/^[\w.+-]+:\/\//.test(t.url)&&(t.url=s.docURL,"script"===i?i="inline-script":"font"===i&&(i="inline-font")),a.modifier=void 0,n.setURL(t.url).setType(i).setFilter(a).toLogger())}return!0};i.policyDirectiveToTypeMap=new Map([["img-src","image"],["connect-src","xmlhttprequest"],["font-src","font"],["frame-src","sub_frame"],["media-src","media"],["object-src","object"],["script-src","script"],["script-src-attr","script"],["script-src-elem","script"],["style-src","stylesheet"],["style-src-attr","stylesheet"],["style-src-elem","stylesheet"]]);const s=function(s,n,r){const o=n.tabId||0,a=e.pageStoreFromTabId(o);let l;switch(s.what,s.what){case"inlinescriptFound":if(e.logger.enabled&&null!==a){const t=e.filteringContext.duplicate();t.fromTabId(o).setType("inline-script").setURL(s.docURL).setDocOriginFromURL(s.docURL),0===a.filterRequest(t)&&t.setRealm("network").toLogger()}break;case"logCosmeticFilteringData":t(o,s);break;case"securityPolicyViolation":l=i(a,s);break;case"temporarilyAllowLargeMediaElement":null!==a&&(a.allowLargeMediaElementsUntil=Date.now()+5e3);break;case"subscribeTo":const n=encodeURIComponent(s.location),r=encodeURIComponent(s.title),c=-1!==e.selectedFilterLists.indexOf(s.location)?"#subscribed":"";vAPI.tabs.open({url:`/asset-viewer.html?url=${n}&title=${r}&subscribe=1${c}`,select:!0});break;default:return vAPI.messaging.UNHANDLED}r(l)};vAPI.messaging.listen({name:"scriptlets",listener:s})}