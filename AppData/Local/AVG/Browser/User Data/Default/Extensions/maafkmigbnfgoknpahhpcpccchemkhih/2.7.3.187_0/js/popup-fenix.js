"use strict";{let t="unset";vAPI.localStorage.getItemAsync("popupFontSize").then((e=>{"string"==typeof e&&"unset"!==e&&(document.body.style.setProperty("--font-size",e),t=e)})),vAPI.localStorage.getItemAsync("popupPanelSections").then((t=>{"number"==typeof t&&U(t)}));const e=vAPI.messaging,o=/^\d+(?:\.\d+){1,3}$/,n={"/":"*",".":""},a=new Map,s=vAPI.i18n("popupBlockedStats"),i=vAPI.i18n("popupHitDomainCount");let c={},l=!1,r=null,u={},d=0,p=[],m=0,g="";const f=/[\u0400-\u042b\u042d-\u042f\u0431\u0432\u0434\u0436-\u043d\u0442\u0444\u0446-\u0449\u044b-\u0454\u0457\u0459-\u0460\u0462-\u0474\u0476-\u04ba\u04bc\u04be-\u04ce\u04d0-\u0500\u0502-\u051a\u051c\u051e-\u052f]/,h=/[\u042c\u0430\u0433\u0435\u043e\u043f\u0440\u0441\u0443\u0445\u044a\u0455\u0456\u0458\u0461\u0475\u04bb\u04bd\u04cf\u0501\u051b\u051d]/,b=function(t){if(c={},n["."]="",a.clear(),"object"!=typeof t)return c;c=t,c.cnameMap=new Map(c.cnameMap),n["."]=c.pageHostname||"";const e=c.hostnameDict;if("object"!=typeof e)return c;for(const t in e){if(!1===e.hasOwnProperty(t))continue;let o=e[t].domain,n=t.slice(0,0-o.length-1);o===c.pageDomain&&(o=" "),a.set(t,o+" "+n.split(".").reverse().join("."))}return c},y=function(t){if("behind-the-scene"===c.pageHostname)return void document.body.classList.remove("needReload");const e=[],o=c.firewallRules;for(const t in o){const n=o[t];null!==n&&e.push(n.src+" "+n.des+" "+n.type+" "+n.action)}e.sort(),e.push(uDom("body").hasClass("off")),e.push(uDom.nodeFromId("no-large-media").classList.contains("on")),e.push(uDom.nodeFromId("no-cosmetic-filtering").classList.contains("on")),e.push(uDom.nodeFromId("no-remote-fonts").classList.contains("on")),e.push(uDom.nodeFromId("no-scripting").classList.contains("on"));const n=e.join("");t&&(g=n),document.body.classList.toggle("needReload",n!==g)},w=function(t){if("number"!=typeof t)return"";if(t<1e6)return t.toLocaleString();if(void 0===v&&Intl.NumberFormat instanceof Function){const t=new Intl.NumberFormat(void 0,{notation:"compact",maximumSignificantDigits:4});t.resolvedOptions instanceof Function&&t.resolvedOptions().hasOwnProperty("notation")&&(v=t)}return v?v.format(t):(t=(t/=1e6)>=100?Math.floor(10*t)/10:t>10?Math.floor(100*t)/100:Math.floor(1e3*t)/1e3).toLocaleString(void 0)+" M"};let v;const P=function(t){const e=punycode.toUnicode(t);return e===t||!1===h.test(e)||f.test(e)?e:t},I=function(t,e){let n=t.slice(2,t.indexOf(" ",2));o.test(n)||(n=a.get(n)||" ");let s=e.slice(2,e.indexOf(" ",2));o.test(s)||(s=a.get(s)||" ");const i=n.charCodeAt(0),c=s.charCodeAt(0);return i!==c?i-c:n.localeCompare(s)},S=function(t,e,o,a){const s=document.querySelector(`#firewall div[data-des="${e}"][data-type="${o}"]`);if(null===s)return;const i=s.querySelectorAll(`:scope > span[data-src="${t}"]`);if(0===i.length)return;if(null!==a?i.forEach((t=>{t.setAttribute("class",a.action+"Rule")})):i.forEach((t=>{t.removeAttribute("class")})),null===a||"*"===a.des&&a.type!==o||a.des!==e||a.src!==n[t]||i.forEach((t=>{t.classList.add("ownRule")})),"."!==t||"*"===e)return;if(!1===c.hostnameDict.hasOwnProperty(e))return void i.forEach((t=>{t.removeAttribute("data-acount"),t.removeAttribute("data-bcount")}));const l=c.hostnameDict[e];let r=i[0];0!==l.allowCount?r.setAttribute("data-acount",Math.min(Math.ceil(Math.log(l.allowCount+1)/Math.LN10),3)):r.setAttribute("data-acount","0"),0!==l.blockCount?r.setAttribute("data-bcount",Math.min(Math.ceil(Math.log(l.blockCount+1)/Math.LN10),3)):r.setAttribute("data-bcount","0"),l.domain===e&&(r=i[1],0!==l.totalAllowCount?r.setAttribute("data-acount",Math.min(Math.ceil(Math.log(l.totalAllowCount+1)/Math.LN10),3)):r.setAttribute("data-acount","0"),0!==l.totalBlockCount?r.setAttribute("data-bcount",Math.min(Math.ceil(Math.log(l.totalBlockCount+1)/Math.LN10),3)):r.setAttribute("data-bcount","0"))},L=function(){const t=c.firewallRules;for(const e in t)!1!==t.hasOwnProperty(e)&&S(e.charAt(0),e.slice(2,e.indexOf(" ",2)),e.slice(e.lastIndexOf(" ")+1),t[e]);document.body.classList.toggle("needSave",!0===c.matrixIsDirty)},C=function(){null===r&&(r=uDom.nodeFromId("actionSelector"),r.addEventListener("click",V)),r.remove();const t=document.getElementById("firewall"),e=document.createDocumentFragment(),o=document.querySelector("#templates > div:nth-of-type(1)");let n=t.querySelector("div:nth-of-type(7) + div");for(const t of p){null===n&&(n=o.cloneNode(!0),e.appendChild(n)),n.setAttribute("data-des",t);const a=c.hostnameDict[t]||{},s=t===a.domain,i=punycode.toUnicode(t),l=i!==t,r=n.querySelector("span:first-of-type");r.querySelector("span").textContent=i;const u=n.classList;let d="";u.toggle("isCname",c.cnameMap.has(t))?d=punycode.toUnicode(c.cnameMap.get(t)):s&&l&&h.test(i)&&!1===f.test(i)&&(d=t),r.querySelector("sub").textContent=d,u.toggle("isRootContext",t===c.pageHostname),u.toggle("isDomain",s),u.toggle("isSubDomain",!s),u.toggle("allowed",0!==a.allowCount),u.toggle("blocked",0!==a.blockCount),u.toggle("totalAllowed",0!==a.totalAllowCount),u.toggle("totalBlocked",0!==a.totalBlockCount),u.toggle("expandException",G.has(a.domain)),n=n.nextElementSibling}if(null!==n){for(;null!==n.nextElementSibling;)t.removeChild(n.nextElementSibling);t.removeChild(n)}0!==e.childElementCount&&t.appendChild(e),!0!==l&&c.advancedUserEnabled&&(uDom("#firewall").on("click","span[data-src]",Z).on("mouseenter","[data-src]",$).on("mouseleave","[data-src]",j),l=!0),L()},D=function(){u={},d=m=0,p=[];const t={},e=Object.keys(c.firewallRules).sort(I);for(const o of e){const e=o.slice(2,o.indexOf(" ",2));if("*"===e||t.hasOwnProperty(e))continue;const n=c.hostnameDict[e]||{};!1===u.hasOwnProperty(n.domain)&&(u[n.domain]=!1,d+=1),0!==n.allowCount&&!1===u[n.domain]&&(u[n.domain]=!0,m+=1),p.push(e),t[e]=!0}const o=i.replace("{{count}}",m.toLocaleString()).replace("{{total}}",d.toLocaleString());uDom.nodeFromSelector('[data-i18n^="popupDomainsConnected"] + span').textContent=o},A=function(){uDom.nodeFromId("no-popups").classList.toggle("on",!0===c.noPopups),uDom.nodeFromId("no-large-media").classList.toggle("on",!0===c.noLargeMedia),uDom.nodeFromId("no-cosmetic-filtering").classList.toggle("on",!0===c.noCosmeticFiltering),uDom.nodeFromId("no-remote-fonts").classList.toggle("on",!0===c.noRemoteFonts),uDom.nodeFromId("no-scripting").classList.toggle("on",!0===c.noScripting)},x=function(){c.tabTitle&&(document.title=c.appName+" - "+c.tabTitle);const t=c.netFilteringSwitch,e=document.body;e.classList.toggle("advancedUser",!0===c.advancedUserEnabled),e.classList.toggle("off",""===c.pageURL||!0!==t),e.classList.toggle("needSave",!0===c.matrixIsDirty);{const[t,e]=uDom.nodeFromId("hostname").children,{pageDomain:o,pageHostname:n}=c;""!==o?(e.textContent=P(o),t.textContent=n!==o?P(n.slice(0,-o.length-1))+".":""):t.textContent=e.textContent=""}const o=!0===c.canElementPicker&&t;uDom.nodeFromId("gotoPick").classList.toggle("enabled",o),uDom.nodeFromId("gotoZap").classList.toggle("enabled",o);let n,a=c.pageBlockedRequestCount,i=c.pageAllowedRequestCount+a;n=0===i?w(0):s.replace("{{count}}",w(a)).replace("{{percent}}",w(Math.floor(100*a/i))),uDom.nodeFromSelector('[data-i18n^="popupBlockedOnThisPage"] + span').textContent=n,a=c.globalBlockedRequestCount,i=c.globalAllowedRequestCount+a,n=0===i?w(0):s.replace("{{count}}",w(a)).replace("{{percent}}",w(Math.floor(100*a/i))),uDom.nodeFromSelector('[data-i18n^="popupBlockedSinceInstall"] + span').textContent=n,D(),A(),i=c.popupBlockedCount,uDom.nodeFromSelector("#no-popups .fa-icon-badge").textContent=i?Math.min(i,99).toLocaleString():"",i=c.largeMediaCount,uDom.nodeFromSelector("#no-large-media .fa-icon-badge").textContent=i?Math.min(i,99).toLocaleString():"",i=c.remoteFontCount,uDom.nodeFromSelector("#no-remote-fonts .fa-icon-badge").textContent=i?Math.min(i,99).toLocaleString():"",document.documentElement.classList.toggle("colorBlind",!0===c.colorBlindFriendly),Q(!1===c.firewallPaneMinimized,!0),0!=(O()&N)&&C(),M()},M=function(t){for(const[e,o]of F){if(void 0!==t&&e!==t)continue;const n=uDom.nodeFromSelector(e);if(!1===n.hasAttribute("title"))continue;const a=vAPI.i18n(o.i18n+(null===uDom.nodeFromSelector(o.state)?"1":"2"));n.setAttribute("aria-label",a),n.setAttribute("title",a)}},F=new Map([["#switch",{state:"body.off",i18n:"popupPowerSwitchInfo"}],["#no-popups",{state:"#no-popups.on",i18n:"popupTipNoPopups"}],["#no-large-media",{state:"#no-large-media.on",i18n:"popupTipNoLargeMedia"}],["#no-cosmetic-filtering",{state:"#no-cosmetic-filtering.on",i18n:"popupTipNoCosmeticFiltering"}],["#no-remote-fonts",{state:"#no-remote-fonts.on",i18n:"popupTipNoRemoteFonts"}],["#no-scripting",{state:"#no-scripting.on",i18n:"popupTipNoScripting"}]]);let k=function(){k=function(){};const e=document.body;c.fontSize!==t&&(t=c.fontSize,"unset"!==t?(e.style.setProperty("--font-size",t),vAPI.localStorage.setItem("popupFontSize",t)):(e.style.removeProperty("--font-size"),vAPI.localStorage.removeItem("popupFontSize"))),uDom.nodeFromId("version").textContent=c.appVersion,U(O()),void 0!==c.uiPopupConfig&&document.body.setAttribute("data-ui",c.uiPopupConfig),e.classList.toggle("no-tooltips",!0===c.tooltipsDisabled),!0===c.tooltipsDisabled&&uDom("[title]").removeAttr("title"),!0!==c.advancedUserEnabled&&uDom("#firewall [title][data-src]").removeAttr("title"),1===c.popupPanelHeightMode&&e.classList.add("vMin"),c.godMode&&e.classList.add("godMode")};const E=(()=>{let t=!0;{const o=uDom.nodeFromId("no-cosmetic-filtering"),n=o.querySelector(":scope .fa-icon-badge");n.textContent="⋯";const a=()=>{!1!==t&&(t=!1,o.classList.contains("hnSwitchBusy")||(o.classList.add("hnSwitchBusy"),e.send("popupPanel",{what:"getHiddenElementCount",tabId:c.tabId}).then((t=>{let e;e=0===(t||0)?"":-1===t?"?":Math.min(t,99).toLocaleString(),n.textContent=e,o.classList.remove("hnSwitchBusy")}))))};o.addEventListener("mouseenter",a,{passive:!0})}return async function(){const o=await e.send("popupPanel",{what:"getScriptCount",tabId:c.tabId});uDom.nodeFromSelector("#no-scripting .fa-icon-badge").textContent=0!==(o||0)?Math.min(o,99).toLocaleString():"",t=!0}})(),R=function(t){c&&c.pageURL&&(e.send("popupPanel",{what:"toggleNetFiltering",url:c.pageURL,scope:t.ctrlKey||t.metaKey?"page":"",state:!uDom("body").toggleClass("off").hasClass("off"),tabId:c.tabId}),M("#switch"),y())},B=function(){e.send("popupPanel",{what:"launchElementPicker",tabId:c.tabId,zap:!0}),vAPI.closePopup()},H=function(){e.send("popupPanel",{what:"launchElementPicker",tabId:c.tabId}),vAPI.closePopup()},q=function(t){if(!1===this.hasAttribute("href"))return;t.preventDefault();let o=this.getAttribute("href");"logger-ui.html#_"===o&&"number"==typeof c.tabId&&(o+="+"+c.tabId),e.send("popupPanel",{what:"gotoURL",details:{url:o,select:!0,index:-1,shiftKey:t.shiftKey}}),vAPI.closePopup()},K=6,N=16,O=()=>c.popupPanelSections&~c.popupPanelDisabledSections|c.popupPanelLockedSections,z=function(){const t=document.body.dataset.more;if(""===t)return 0;let e=0;for(const o of t.split(" "))e|=1<<o.charCodeAt(0)-97;return e},U=function(t){const e=[];for(let o=0;o<K;o++)0!=(t&1<<o)&&e.push(String.fromCharCode(97+o));document.body.dataset.more=e.join(" ")},T=function(t){const o=~c.popupPanelDisabledSections,n=c.popupPanelLockedSections;let a=z(),s=a;for(let e=0;e<K;e++){const i=1<<(t?e:K-e-1);if(t?s|=i:s&=~i,s=s&o|n,s!==a)break}s!==a&&(U(s),c.popupPanelSections=s,e.send("popupPanel",{what:"userSettings",name:"popupPanelSections",value:s}),vAPI.localStorage.setItem("popupPanelSections",s),0!=(s&N)&&!1===l&&C())};uDom("#moreButton").on("click",(()=>{T(!0)})),uDom("#lessButton").on("click",(()=>{T(!1)}));const $=function(t){const e=t.target;e.classList.contains("ownRule")||e.appendChild(r)},j=function(){r.remove()},W=async function(t,o,n,a,s){if("string"!=typeof c.pageHostname||""===c.pageHostname)return;const i=await e.send("popupPanel",{what:"toggleFirewallRule",tabId:c.tabId,pageHostname:c.pageHostname,srcHostname:t,desHostname:o,requestType:n,action:a,persist:s});0!==a&&r.remove(),b(i),L(),y()},Z=function(t){const e=t.target,o=e.closest("[data-des]");W("/"===e.getAttribute("data-src")?"*":c.pageHostname,o.getAttribute("data-des"),o.getAttribute("data-type"),0,t.ctrlKey||t.metaKey),e.appendChild(r)},V=function(t){const e=t.target,o=e.closest("[data-src]");if(null===o)return;const n=o.closest("[data-des]");let a=0;a="dynaAllow"===e.id?2:"dynaNoop"===e.id?3:1,W("/"===o.getAttribute("data-src")?"*":c.pageHostname,n.getAttribute("data-des"),n.getAttribute("data-type"),a,t.ctrlKey||t.metaKey),r.remove()},_=function(t){e.send("popupPanel",{what:"reloadTab",tabId:c.tabId,select:vAPI.webextFlavor.soup.has("mobile"),bypassCache:t.ctrlKey||t.metaKey||t.shiftKey}),c.contentLastModified=-1,document.body.classList.remove("needReload")};uDom("#refresh").on("click",_),document.addEventListener("keydown",(t=>{"F5"===t.code&&(_(t),t.preventDefault(),t.stopPropagation())}),{capture:!0});const G=new Set;vAPI.localStorage.getItemAsync("popupExpandExceptions").then((t=>{try{if(!1===Array.isArray(t))return;for(const e of t)G.add(e)}catch(t){}}));const J=function(){vAPI.localStorage.setItem("popupExpandExceptions",Array.from(G))},Q=function(t,o=!1){uDom(".expandException").removeClass("expandException"),t?uDom("#firewall").addClass("expanded"):uDom("#firewall").removeClass("expanded"),o||(c.firewallPaneMinimized=!t,G.clear(),J(),e.send("popupPanel",{what:"userSettings",name:"firewallPaneMinimized",value:c.firewallPaneMinimized}))},X=function(t,e,o=!1){const n=uDom(`[data-des="${t}"],[data-des$=".${t}"]`);e?n.addClass("expandException"):n.removeClass("expandException"),o||(e?G.add(t):G.delete(t),J())};uDom('[data-i18n="popupAnyRulePrompt"]').on("click",(t=>{if(t.shiftKey&&t.ctrlKey)return e.send("popupPanel",{what:"gotoURL",details:{url:`popup-fenix.html?tabId=${c.tabId}&intab=1`,select:!0,index:-1}}),void vAPI.closePopup();Q(!1===uDom("#firewall").hasClass("expanded"))})),uDom("#firewall").on("click",'.isDomain[data-type="*"] > span:first-of-type',(t=>{const e=t.target.closest("[data-des]");null!==e&&X(e.getAttribute("data-des"),!1===e.classList.contains("expandException"))}));const Y=function(){e.send("popupPanel",{what:"saveFirewallRules",srcHostname:c.pageHostname,desHostnames:c.hostnameDict}),document.body.classList.remove("needSave")},tt=async function(){document.body.classList.remove("needSave");const t=await e.send("popupPanel",{what:"revertFirewallRules",srcHostname:c.pageHostname,desHostnames:c.hostnameDict,tabId:c.tabId});b(t),L(),A(),y()},et=async function(t){const o=t.currentTarget,n=o.getAttribute("id");if(!n)return;if(vAPI.webextFlavor.soup.has("mobile")&&o.classList.contains("hnSwitchBusy"))return;o.classList.toggle("on"),M(`#${n}`);const a=await e.send("popupPanel",{what:"toggleHostnameSwitch",name:n,hostname:c.pageHostname,state:o.classList.contains("on"),tabId:c.tabId,persist:t.ctrlKey||t.metaKey});b(a),L(),y()};{let t=0,e=0;document.addEventListener("keydown",(o=>{if("Control"!==o.key)return void(t=0);const n=Date.now();n-e>=500&&(t=0),t+=1,e=n,t<2||(t=0,document.body.classList.toggle("godMode"))}))}const ot=(()=>{let t;const o=async function(){t=void 0;const o=await e.send("popupPanel",{what:"hasPopupContentChanged",tabId:c.tabId,contentLastModified:c.contentLastModified});n(o)},n=function(t){t?nt(c.tabId):a()},a=function(){void 0===t&&(t=vAPI.setTimeout(o,1500))};return a})(),nt=async function(t){const o=await e.send("popupPanel",{what:"getPopupData",tabId:t});b(o),k(),x(),E(),y(!0),ot()};{const t=new URL(self.location.href),e=parseInt(t.searchParams.get("tabId"),10)||null,o=async t=>{for(let e=0;e<t;e++)await new Promise((t=>{self.requestAnimationFrame((()=>{t()}))}))},n=async function(){const e=document.querySelector(":root");if(e.classList.contains("mobile")||t.searchParams.get("portrait"))e.classList.add("portrait");else if(e.classList.contains("desktop")){await o(4);const n=document.getElementById("main"),a=document.getElementById("firewall"),s=(n.offsetWidth+a.offsetWidth)/1.1;(t.searchParams.get("portrait")||window.innerWidth<s)&&e.classList.add("portrait")}if(e.classList.contains("portrait")){const t=document.getElementById("panes"),e=document.getElementById("sticky");e.parentElement!==t&&t.prepend(e)}null!==t.searchParams.get("intab")&&e.classList.add("intab"),await o(1),document.body.classList.remove("loading")};nt(e).then((()=>{"complete"!==document.readyState?self.addEventListener("load",(()=>{n()}),{once:!0}):n()}))}uDom("#switch").on("click",R),uDom("#gotoZap").on("click",B),uDom("#gotoPick").on("click",H),uDom(".hnSwitch").on("click",(t=>{et(t)})),uDom("#saveRules").on("click",Y),uDom("#revertRules").on("click",(()=>{tt()})),uDom("a[href]").on("click",q)}